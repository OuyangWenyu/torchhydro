
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://OuyangWenyu.github.io/torchhydro/api/models/">
      
      
        <link rel="prev" href="../../torchhydro/">
      
      
        <link rel="next" href="../datasets/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Models - torchhydro</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#models-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="torchhydro" class="md-header__button md-logo" aria-label="torchhydro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            torchhydro
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Models
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/OuyangWenyu/torchhydro" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="torchhydro" class="md-nav__button md-logo" aria-label="torchhydro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    torchhydro
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OuyangWenyu/torchhydro" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/OuyangWenyu/torchhydro/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issues
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../torchhydro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models" class="md-nav__link">
    <span class="md-ellipsis">
      torchhydro.models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.ann" class="md-nav__link">
    <span class="md-ellipsis">
      ann
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ann">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp" class="md-nav__link">
    <span class="md-ellipsis">
      Mlp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mlp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleAnn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleAnn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.crits" class="md-nav__link">
    <span class="md-ellipsis">
      crits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="crits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior" class="md-nav__link">
    <span class="md-ellipsis">
      DynamicTaskPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamicTaskPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss" class="md-nav__link">
    <span class="md-ellipsis">
      FloodBaseLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FloodBaseLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss" class="md-nav__link">
    <span class="md-ellipsis">
      FloodLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FloodLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss" class="md-nav__link">
    <span class="md-ellipsis">
      GaussianLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GaussianLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss" class="md-nav__link">
    <span class="md-ellipsis">
      HybridFloodloss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HybridFloodloss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss" class="md-nav__link">
    <span class="md-ellipsis">
      HybridLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HybridLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MAELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MAELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAPELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MAPELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MAPELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAPELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MASELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MASELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss" class="md-nav__link">
    <span class="md-ellipsis">
      MultiOutLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiOutLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss" class="md-nav__link">
    <span class="md-ellipsis">
      MultiOutWaterBalanceLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiOutWaterBalanceLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      NSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NegativeLogLikelihood" class="md-nav__link">
    <span class="md-ellipsis">
      NegativeLogLikelihood
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NegativeLogLikelihood">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NegativeLogLikelihood.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss" class="md-nav__link">
    <span class="md-ellipsis">
      PESLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PESLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PenalizedMSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      PenalizedMSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PenalizedMSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PenalizedMSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.QuantileLoss" class="md-nav__link">
    <span class="md-ellipsis">
      QuantileLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QuantileLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.QuantileLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      RMSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RMSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss" class="md-nav__link">
    <span class="md-ellipsis">
      RmseLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RmseLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.SigmaLoss" class="md-nav__link">
    <span class="md-ellipsis">
      SigmaLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SigmaLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.SigmaLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights" class="md-nav__link">
    <span class="md-ellipsis">
      UncertaintyWeights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UncertaintyWeights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data" class="md-nav__link">
    <span class="md-ellipsis">
      deal_gap_data()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="deal_gap_data()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.l1_regularizer" class="md-nav__link">
    <span class="md-ellipsis">
      l1_regularizer()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.orth_regularizer" class="md-nav__link">
    <span class="md-ellipsis">
      orth_regularizer()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm" class="md-nav__link">
    <span class="md-ellipsis">
      cudnnlstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cudnnlstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dKernel" class="md-nav__link">
    <span class="md-ellipsis">
      CNN1dKernel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CNN1dKernel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dKernel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel" class="md-nav__link">
    <span class="md-ellipsis">
      CNN1dLCmodel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CNN1dLCmodel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CpuLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      CpuLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CpuLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CpuLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.all_weights" class="md-nav__link">
    <span class="md-ellipsis">
      all_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __setstate__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__setstate__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_mask" class="md-nav__link">
    <span class="md-ellipsis">
      reset_mask()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      reset_parameters()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModelLstmKernel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModelLstmKernel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModelMultiOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModelMultiOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearCudnnLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearCudnnLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LstmCellTied" class="md-nav__link">
    <span class="md-ellipsis">
      LstmCellTied
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LstmCellTied">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LstmCellTied.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4gr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4gr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnGr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnGr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmGr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmGr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Gr4j4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gr4j4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_evap_store" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap_store()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_perc" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_perc()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_precip_store" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_precip_store()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production" class="md-nav__link">
    <span class="md-ellipsis">
      production()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="production()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing" class="md-nav__link">
    <span class="md-ellipsis">
      routing()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="routing()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gr4j()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_gr4j()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4hbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4hbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnHbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnHbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmHbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmHbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Hbv4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hbv4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4xaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4xaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Xaj4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Xaj4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm" class="md-nav__link">
    <span class="md-ellipsis">
      ann_pbm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ann_pbm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_evap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_prcp_runoff()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_prcp_runoff()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_w_storage()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_w_storage()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir" class="md-nav__link">
    <span class="md-ellipsis">
      linear_reservoir()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="linear_reservoir()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm" class="md-nav__link">
    <span class="md-ellipsis">
      lstm_pbm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lstm_pbm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_generation()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_generation()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_sources()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_sources()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources--return" class="md-nav__link">
    <span class="md-ellipsis">
      Return
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_sources5mm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_sources5mm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4xaj_nn4et
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4xaj_nn4et">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmNnModuleXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmNnModuleXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro" class="md-nav__link">
    <span class="md-ellipsis">
      NnModule4Hydro
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NnModule4Hydro">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule" class="md-nav__link">
    <span class="md-ellipsis">
      Xaj4DplWithNnModule
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Xaj4DplWithNnModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_1layer_w_storage()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_1layer_w_storage()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dropout" class="md-nav__link">
    <span class="md-ellipsis">
      dropout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dropout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask" class="md-nav__link">
    <span class="md-ellipsis">
      DropMask
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DropMask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward" class="md-nav__link">
    <span class="md-ellipsis">
      backward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="backward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_mask()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_mask()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.gnn" class="md-nav__link">
    <span class="md-ellipsis">
      gnn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gnn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.gnn.GNNBaseModel" class="md-nav__link">
    <span class="md-ellipsis">
      GNNBaseModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GNNBaseModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.gnn.GNNBaseModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv" class="md-nav__link">
    <span class="md-ellipsis">
      kernel_conv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kernel_conv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv" class="md-nav__link">
    <span class="md-ellipsis">
      KernelConv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KernelConv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv" class="md-nav__link">
    <span class="md-ellipsis">
      uh_conv()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_conv()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gamma()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_gamma()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.model_dict_function" class="md-nav__link">
    <span class="md-ellipsis">
      model_dict_function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils" class="md-nav__link">
    <span class="md-ellipsis">
      model_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils.get_the_device" class="md-nav__link">
    <span class="md-ellipsis">
      get_the_device()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_the_device()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils.get_the_device--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm" class="md-nav__link">
    <span class="md-ellipsis">
      mtslstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mtslstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MTSLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MTSLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq" class="md-nav__link">
    <span class="md-ellipsis">
      seq2seq
    </span>
  </a>
  
    <nav class="md-nav" aria-label="seq2seq">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.AdditiveAttention" class="md-nav__link">
    <span class="md-ellipsis">
      AdditiveAttention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdditiveAttention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.AdditiveAttention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Attention" class="md-nav__link">
    <span class="md-ellipsis">
      Attention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Attention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataEnhancedModel" class="md-nav__link">
    <span class="md-ellipsis">
      DataEnhancedModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataEnhancedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataEnhancedModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataFusionModel" class="md-nav__link">
    <span class="md-ellipsis">
      DataFusionModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataFusionModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataFusionModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Decoder" class="md-nav__link">
    <span class="md-ellipsis">
      Decoder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Decoder.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DotProductAttention" class="md-nav__link">
    <span class="md-ellipsis">
      DotProductAttention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DotProductAttention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DotProductAttention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Encoder" class="md-nav__link">
    <span class="md-ellipsis">
      Encoder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Encoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Encoder.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq" class="md-nav__link">
    <span class="md-ellipsis">
      GeneralSeq2Seq
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeneralSeq2Seq">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.StateTransferNetwork" class="md-nav__link">
    <span class="md-ellipsis">
      StateTransferNetwork
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateTransferNetwork">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.StateTransferNetwork.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transformer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast" class="md-nav__link">
    <span class="md-ellipsis">
      seqforecast
    </span>
  </a>
  
    <nav class="md-nav" aria-label="seqforecast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.FeatureEmbedding" class="md-nav__link">
    <span class="md-ellipsis">
      FeatureEmbedding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FeatureEmbedding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.FeatureEmbedding.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ForecastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      ForecastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ForecastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ForecastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HiddenStateTransferNet" class="md-nav__link">
    <span class="md-ellipsis">
      HiddenStateTransferNet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HiddenStateTransferNet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HiddenStateTransferNet.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HindcastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      HindcastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HindcastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HindcastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ModelOutputHead" class="md-nav__link">
    <span class="md-ellipsis">
      ModelOutputHead
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ModelOutputHead">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ModelOutputHead.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SequentialForecastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequentialForecastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm" class="md-nav__link">
    <span class="md-ellipsis">
      simple_lstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="simple_lstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      HFLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HFLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearMultiLayerLSTMModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearMultiLayerLSTMModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearSimpleLSTMModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearSimpleLSTMModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MinLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MinLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MinLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MinLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MultiLayerLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MultiLayerLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiLayerLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MultiLayerLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleLSTMForecast
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleLSTMForecast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SlowLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SlowLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlowLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SlowLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm" class="md-nav__link">
    <span class="md-ellipsis">
      spplstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="spplstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model" class="md-nav__link">
    <span class="md-ellipsis">
      SPP_LSTM_Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPP_LSTM_Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2" class="md-nav__link">
    <span class="md-ellipsis">
      SPP_LSTM_Model_2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPP_LSTM_Model_2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer" class="md-nav__link">
    <span class="md-ellipsis">
      SppLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SppLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.TimeDistributed" class="md-nav__link">
    <span class="md-ellipsis">
      TimeDistributed
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TimeDistributed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.TimeDistributed.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Datasets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trainers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trainers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../explainers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Explainers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models" class="md-nav__link">
    <span class="md-ellipsis">
      torchhydro.models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.ann" class="md-nav__link">
    <span class="md-ellipsis">
      ann
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ann">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp" class="md-nav__link">
    <span class="md-ellipsis">
      Mlp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mlp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.Mlp.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleAnn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleAnn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.ann.SimpleAnn.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.crits" class="md-nav__link">
    <span class="md-ellipsis">
      crits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="crits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior" class="md-nav__link">
    <span class="md-ellipsis">
      DynamicTaskPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamicTaskPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.DynamicTaskPrior.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss" class="md-nav__link">
    <span class="md-ellipsis">
      FloodBaseLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FloodBaseLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodBaseLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss" class="md-nav__link">
    <span class="md-ellipsis">
      FloodLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FloodLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss" class="md-nav__link">
    <span class="md-ellipsis">
      GaussianLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GaussianLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.GaussianLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss" class="md-nav__link">
    <span class="md-ellipsis">
      HybridFloodloss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HybridFloodloss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss" class="md-nav__link">
    <span class="md-ellipsis">
      compute_flood_loss()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_flood_loss()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss" class="md-nav__link">
    <span class="md-ellipsis">
      HybridLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HybridLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.HybridLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MAELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MAELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAPELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MAPELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MAPELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MAPELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss" class="md-nav__link">
    <span class="md-ellipsis">
      MASELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MASELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MASELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss" class="md-nav__link">
    <span class="md-ellipsis">
      MultiOutLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiOutLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss" class="md-nav__link">
    <span class="md-ellipsis">
      MultiOutWaterBalanceLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiOutWaterBalanceLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      NSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NegativeLogLikelihood" class="md-nav__link">
    <span class="md-ellipsis">
      NegativeLogLikelihood
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NegativeLogLikelihood">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.NegativeLogLikelihood.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss" class="md-nav__link">
    <span class="md-ellipsis">
      PESLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PESLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PESLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PenalizedMSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      PenalizedMSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PenalizedMSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.PenalizedMSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.QuantileLoss" class="md-nav__link">
    <span class="md-ellipsis">
      QuantileLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QuantileLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.QuantileLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss" class="md-nav__link">
    <span class="md-ellipsis">
      RMSELoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RMSELoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RMSELoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss" class="md-nav__link">
    <span class="md-ellipsis">
      RmseLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RmseLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.RmseLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.SigmaLoss" class="md-nav__link">
    <span class="md-ellipsis">
      SigmaLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SigmaLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.SigmaLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights" class="md-nav__link">
    <span class="md-ellipsis">
      UncertaintyWeights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UncertaintyWeights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.UncertaintyWeights.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data" class="md-nav__link">
    <span class="md-ellipsis">
      deal_gap_data()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="deal_gap_data()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.deal_gap_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.l1_regularizer" class="md-nav__link">
    <span class="md-ellipsis">
      l1_regularizer()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.crits.orth_regularizer" class="md-nav__link">
    <span class="md-ellipsis">
      orth_regularizer()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm" class="md-nav__link">
    <span class="md-ellipsis">
      cudnnlstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cudnnlstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dKernel" class="md-nav__link">
    <span class="md-ellipsis">
      CNN1dKernel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CNN1dKernel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dKernel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel" class="md-nav__link">
    <span class="md-ellipsis">
      CNN1dLCmodel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CNN1dLCmodel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CpuLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      CpuLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CpuLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CpuLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.all_weights" class="md-nav__link">
    <span class="md-ellipsis">
      all_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __setstate__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__setstate__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_mask" class="md-nav__link">
    <span class="md-ellipsis">
      reset_mask()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      reset_parameters()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModelLstmKernel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModelLstmKernel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput" class="md-nav__link">
    <span class="md-ellipsis">
      CudnnLstmModelMultiOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CudnnLstmModelMultiOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearCudnnLstmModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearCudnnLstmModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LstmCellTied" class="md-nav__link">
    <span class="md-ellipsis">
      LstmCellTied
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LstmCellTied">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.cudnnlstm.LstmCellTied.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4gr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4gr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnGr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnGr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmGr4j
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmGr4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Gr4j4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gr4j4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_evap_store" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap_store()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_perc" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_perc()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.calculate_precip_store" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_precip_store()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production" class="md-nav__link">
    <span class="md-ellipsis">
      production()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="production()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.production--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing" class="md-nav__link">
    <span class="md-ellipsis">
      routing()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="routing()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.routing--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gr4j()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_gr4j()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4gr4j.uh_gr4j--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4hbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4hbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnHbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnHbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmHbv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmHbv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Hbv4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hbv4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4xaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4xaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplAnnXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplAnnXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl" class="md-nav__link">
    <span class="md-ellipsis">
      Xaj4Dpl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Xaj4Dpl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm" class="md-nav__link">
    <span class="md-ellipsis">
      ann_pbm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ann_pbm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.ann_pbm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_evap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_evap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_prcp_runoff()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_prcp_runoff()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_w_storage()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_w_storage()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.calculate_w_storage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir" class="md-nav__link">
    <span class="md-ellipsis">
      linear_reservoir()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="linear_reservoir()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.linear_reservoir--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm" class="md-nav__link">
    <span class="md-ellipsis">
      lstm_pbm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lstm_pbm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.lstm_pbm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_generation()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_generation()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_generation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_sources()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_sources()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources--return" class="md-nav__link">
    <span class="md-ellipsis">
      Return
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm" class="md-nav__link">
    <span class="md-ellipsis">
      xaj_sources5mm()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xaj_sources5mm()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj.xaj_sources5mm--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et" class="md-nav__link">
    <span class="md-ellipsis">
      dpl4xaj_nn4et
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dpl4xaj_nn4et">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj" class="md-nav__link">
    <span class="md-ellipsis">
      DplLstmNnModuleXaj
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DplLstmNnModuleXaj">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro" class="md-nav__link">
    <span class="md-ellipsis">
      NnModule4Hydro
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NnModule4Hydro">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule" class="md-nav__link">
    <span class="md-ellipsis">
      Xaj4DplWithNnModule
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Xaj4DplWithNnModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_1layer_w_storage()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="calculate_1layer_w_storage()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.dropout" class="md-nav__link">
    <span class="md-ellipsis">
      dropout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dropout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask" class="md-nav__link">
    <span class="md-ellipsis">
      DropMask
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DropMask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward" class="md-nav__link">
    <span class="md-ellipsis">
      backward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="backward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.backward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.DropMask.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask" class="md-nav__link">
    <span class="md-ellipsis">
      create_mask()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_mask()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.dropout.create_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.gnn" class="md-nav__link">
    <span class="md-ellipsis">
      gnn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gnn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.gnn.GNNBaseModel" class="md-nav__link">
    <span class="md-ellipsis">
      GNNBaseModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GNNBaseModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.gnn.GNNBaseModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv" class="md-nav__link">
    <span class="md-ellipsis">
      kernel_conv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kernel_conv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv" class="md-nav__link">
    <span class="md-ellipsis">
      KernelConv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KernelConv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.KernelConv.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv" class="md-nav__link">
    <span class="md-ellipsis">
      uh_conv()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_conv()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_conv--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gamma()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uh_gamma()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.kernel_conv.uh_gamma--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.model_dict_function" class="md-nav__link">
    <span class="md-ellipsis">
      model_dict_function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils" class="md-nav__link">
    <span class="md-ellipsis">
      model_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils.get_the_device" class="md-nav__link">
    <span class="md-ellipsis">
      get_the_device()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_the_device()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.model_utils.get_the_device--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm" class="md-nav__link">
    <span class="md-ellipsis">
      mtslstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mtslstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MTSLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MTSLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.mtslstm.MTSLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq" class="md-nav__link">
    <span class="md-ellipsis">
      seq2seq
    </span>
  </a>
  
    <nav class="md-nav" aria-label="seq2seq">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.AdditiveAttention" class="md-nav__link">
    <span class="md-ellipsis">
      AdditiveAttention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdditiveAttention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.AdditiveAttention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Attention" class="md-nav__link">
    <span class="md-ellipsis">
      Attention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Attention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataEnhancedModel" class="md-nav__link">
    <span class="md-ellipsis">
      DataEnhancedModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataEnhancedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataEnhancedModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataFusionModel" class="md-nav__link">
    <span class="md-ellipsis">
      DataFusionModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataFusionModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DataFusionModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Decoder" class="md-nav__link">
    <span class="md-ellipsis">
      Decoder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Decoder.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DotProductAttention" class="md-nav__link">
    <span class="md-ellipsis">
      DotProductAttention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DotProductAttention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.DotProductAttention.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Encoder" class="md-nav__link">
    <span class="md-ellipsis">
      Encoder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Encoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Encoder.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq" class="md-nav__link">
    <span class="md-ellipsis">
      GeneralSeq2Seq
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeneralSeq2Seq">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.StateTransferNetwork" class="md-nav__link">
    <span class="md-ellipsis">
      StateTransferNetwork
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateTransferNetwork">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.StateTransferNetwork.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transformer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seq2seq.Transformer.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast" class="md-nav__link">
    <span class="md-ellipsis">
      seqforecast
    </span>
  </a>
  
    <nav class="md-nav" aria-label="seqforecast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.FeatureEmbedding" class="md-nav__link">
    <span class="md-ellipsis">
      FeatureEmbedding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FeatureEmbedding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.FeatureEmbedding.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ForecastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      ForecastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ForecastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ForecastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HiddenStateTransferNet" class="md-nav__link">
    <span class="md-ellipsis">
      HiddenStateTransferNet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HiddenStateTransferNet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HiddenStateTransferNet.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HindcastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      HindcastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HindcastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.HindcastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ModelOutputHead" class="md-nav__link">
    <span class="md-ellipsis">
      ModelOutputHead
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ModelOutputHead">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.ModelOutputHead.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SequentialForecastLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequentialForecastLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm" class="md-nav__link">
    <span class="md-ellipsis">
      simple_lstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="simple_lstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      HFLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HFLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.HFLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearMultiLayerLSTMModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearMultiLayerLSTMModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel" class="md-nav__link">
    <span class="md-ellipsis">
      LinearSimpleLSTMModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LinearSimpleLSTMModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MinLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MinLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MinLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MinLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MultiLayerLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      MultiLayerLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiLayerLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.MultiLayerLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleLSTMForecast
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimpleLSTMForecast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SlowLSTM" class="md-nav__link">
    <span class="md-ellipsis">
      SlowLSTM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlowLSTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.simple_lstm.SlowLSTM.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm" class="md-nav__link">
    <span class="md-ellipsis">
      spplstm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="spplstm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model" class="md-nav__link">
    <span class="md-ellipsis">
      SPP_LSTM_Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPP_LSTM_Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2" class="md-nav__link">
    <span class="md-ellipsis">
      SPP_LSTM_Model_2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPP_LSTM_Model_2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer" class="md-nav__link">
    <span class="md-ellipsis">
      SppLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SppLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.SppLayer.forward--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.TimeDistributed" class="md-nav__link">
    <span class="md-ellipsis">
      TimeDistributed
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TimeDistributed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torchhydro.models.spplstm.TimeDistributed.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="models-api">Models API<a class="headerlink" href="#models-api" title="Permanent link">&para;</a></h1>


  <div class="doc doc-object doc-module">

<a id="torchhydro.models"></a>
    <div class="doc doc-contents first">

      <p>Author: Wenyu Ouyang
Date: 2023-07-11 17:39:09
LastEditTime: 2023-07-11 20:40:37
LastEditors: Wenyu Ouyang
Description:
FilePath: \HydroTL\hydrotl\models__init__.py
Copyright (c) 2023-2024 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.ann" class="doc doc-heading">
        <code>ann</code>



<a href="#torchhydro.models.ann" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2021-12-17 18:02:27
LastEditTime: 2025-06-25 14:07:58
LastEditors: Wenyu Ouyang
Description: ANN model
FilePath:       orchhydro       orchhydro\modelsnn.py
Copyright (c) 2021-2022 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.ann.Mlp" class="doc doc-heading">
        <code>
Mlp            (<a class="autorefs autorefs-internal" title="
SimpleAnn            (Module)
         (torchhydro.models.ann.SimpleAnn)" href="#torchhydro.models.ann.SimpleAnn">SimpleAnn</a>)
        </code>



<a href="#torchhydro.models.ann.Mlp" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Mlp</span><span class="p">(</span><span class="n">SimpleAnn</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MLP model inherited from SimpleAnn, using activation + dropout after each layer.</span>
<span class="sd">        The final layer also goes through activation+dropout if there&#39;s a corresponding</span>
<span class="sd">        dropout layer in dropout_list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hidden_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hidden_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mlp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass with activation followed by dropout for each layer in linear_list.</span>
<span class="sd">        The number of dropout layers must match or be exactly one less than</span>
<span class="sd">        the number of linear layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Raise an error if the number of linear layers and dropout layers do not match</span>
        <span class="c1"># and do not satisfy &quot;number of linear layers = number of dropout layers + 1&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Mlp: linear_list and dropout_list sizes do not match. &quot;</span>
                <span class="s2">&quot;They either have the same length or linear_list has exactly one more.&quot;</span>
            <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.ann.Mlp.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.ann.Mlp.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>MLP model inherited from SimpleAnn, using activation + dropout after each layer.
The final layer also goes through activation+dropout if there's a corresponding
dropout layer in dropout_list.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MLP model inherited from SimpleAnn, using activation + dropout after each layer.</span>
<span class="sd">    The final layer also goes through activation+dropout if there&#39;s a corresponding</span>
<span class="sd">    dropout layer in dropout_list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hidden_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hidden_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Mlp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.ann.Mlp.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.ann.Mlp.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass with activation followed by dropout for each layer in linear_list.
The number of dropout layers must match or be exactly one less than
the number of linear layers.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward pass with activation followed by dropout for each layer in linear_list.</span>
<span class="sd">    The number of dropout layers must match or be exactly one less than</span>
<span class="sd">    the number of linear layers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Raise an error if the number of linear layers and dropout layers do not match</span>
    <span class="c1"># and do not satisfy &quot;number of linear layers = number of dropout layers + 1&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Mlp: linear_list and dropout_list sizes do not match. &quot;</span>
            <span class="s2">&quot;They either have the same length or linear_list has exactly one more.&quot;</span>
        <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.ann.SimpleAnn" class="doc doc-heading">
        <code>
SimpleAnn            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.ann.SimpleAnn" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleAnn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A simple multi-layer NN model with final linear layer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nx</span>
<span class="sd">            number of input neurons</span>
<span class="sd">        ny</span>
<span class="sd">            number of output neurons</span>
<span class="sd">        hidden_size</span>
<span class="sd">            a list/tuple which contains number of neurons in each hidden layer;</span>
<span class="sd">            if int, only one hidden layer except for hidden_size=0</span>
<span class="sd">        dr</span>
<span class="sd">            dropout rate of layers, default is 0.0 which means no dropout;</span>
<span class="sd">            here we set number of dropout layers to (number of nn layers - 1)</span>
<span class="sd">        activation</span>
<span class="sd">            activation function for hidden layers, default is &quot;relu&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleAnn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">linear_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="n">dropout_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">hidden_size</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">hidden_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dr</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear2&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
                <span class="c1"># dropout layer do not have additional weights, so we do not name them here</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># dr must be a float</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
                    <span class="s2">&quot;At most, we set dropout layer for each nn layer, please check the number of dropout layers&quot;</span>
                <span class="p">)</span>
            <span class="c1"># dropout_list.add_module(&quot;dropout1&quot;, torch.nn.Dropout(dr[0]))</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                    <span class="s2">&quot;linear</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hidden_size</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s2">&quot;linear</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ny</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_list</span><span class="p">):</span>
                <span class="c1"># if final linear also need a dr</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span> <span class="o">=</span> <span class="n">linear_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span> <span class="o">=</span> <span class="n">dropout_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_activation</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># final layer must be a linear layer</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># in final layer, no relu again</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a function to get activation function by name, reference from:</span>
<span class="sd">        https://github.com/neuralhydrology/neuralhydrology/blob/master/neuralhydrology/modelzoo/fc.py</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nn.Module</span>
<span class="sd">            _description_</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tanh&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> currently not supported as activation in this class&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">activation</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.ann.SimpleAnn.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.ann.SimpleAnn.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A simple multi-layer NN model with final linear layer</p>
<h6 id="torchhydro.models.ann.SimpleAnn.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.ann.SimpleAnn.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>nx
    number of input neurons
ny
    number of output neurons
hidden_size
    a list/tuple which contains number of neurons in each hidden layer;
    if int, only one hidden layer except for hidden_size=0
dr
    dropout rate of layers, default is 0.0 which means no dropout;
    here we set number of dropout layers to (number of nn layers - 1)
activation
    activation function for hidden layers, default is "relu"</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple multi-layer NN model with final linear layer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nx</span>
<span class="sd">        number of input neurons</span>
<span class="sd">    ny</span>
<span class="sd">        number of output neurons</span>
<span class="sd">    hidden_size</span>
<span class="sd">        a list/tuple which contains number of neurons in each hidden layer;</span>
<span class="sd">        if int, only one hidden layer except for hidden_size=0</span>
<span class="sd">    dr</span>
<span class="sd">        dropout rate of layers, default is 0.0 which means no dropout;</span>
<span class="sd">        here we set number of dropout layers to (number of nn layers - 1)</span>
<span class="sd">    activation</span>
<span class="sd">        activation function for hidden layers, default is &quot;relu&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">SimpleAnn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="n">linear_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
    <span class="n">dropout_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">hidden_size</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">hidden_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dr</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear2&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
            <span class="c1"># dropout layer do not have additional weights, so we do not name them here</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dr must be a float</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;linear1&quot;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
                <span class="s2">&quot;At most, we set dropout layer for each nn layer, please check the number of dropout layers&quot;</span>
            <span class="p">)</span>
        <span class="c1"># dropout_list.add_module(&quot;dropout1&quot;, torch.nn.Dropout(dr[0]))</span>
        <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s2">&quot;linear</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hidden_size</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="n">linear_list</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
            <span class="s2">&quot;linear</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ny</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">linear_list</span><span class="p">):</span>
            <span class="c1"># if final linear also need a dr</span>
            <span class="n">dropout_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span> <span class="o">=</span> <span class="n">linear_list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span> <span class="o">=</span> <span class="n">dropout_list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_activation</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.ann.SimpleAnn.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.ann.SimpleAnn.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/ann.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># final layer must be a linear layer</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># in final layer, no relu again</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_list</span><span class="p">)</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_list</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">model</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.crits" class="doc doc-heading">
        <code>crits</code>



<a href="#torchhydro.models.crits" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2021-12-31 11:08:29
LastEditTime: 2025-07-13 16:36:07
LastEditors: Wenyu Ouyang
Description: Loss functions
FilePath:       orchhydro       orchhydro\models\crits.py
Copyright (c) 2021-2022 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.DynamicTaskPrior" class="doc doc-heading">
        <code>
DynamicTaskPrior            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.DynamicTaskPrior" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Dynamic Task Prioritization</p>
<p>This method is proposed in https://openaccess.thecvf.com/content_ECCV_2018/html/Michelle_Guo_Focus_on_the_ECCV_2018_paper.html
In contrast to UW and other curriculum learning methods, where easy tasks are prioritized above difficult tasks,
It shows the importance of prioritizing difficult tasks first.
It automatically prioritize more difficult tasks by adaptively adjusting the mixing weight of each task's loss.
Here we choose correlation as KPI. As KPI must be in [0,1], we set (corr+1)/2 as KPI</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DynamicTaskPrior</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Dynamic Task Prioritization</span>

<span class="sd">    This method is proposed in https://openaccess.thecvf.com/content_ECCV_2018/html/Michelle_Guo_Focus_on_the_ECCV_2018_paper.html</span>
<span class="sd">    In contrast to UW and other curriculum learning methods, where easy tasks are prioritized above difficult tasks,</span>
<span class="sd">    It shows the importance of prioritizing difficult tasks first.</span>
<span class="sd">    It automatically prioritize more difficult tasks by adaptively adjusting the mixing weight of each task&#39;s loss.</span>
<span class="sd">    Here we choose correlation as KPI. As KPI must be in [0,1], we set (corr+1)/2 as KPI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_funcs</span>
<span class="sd">        data_gap</span>
<span class="sd">        device</span>
<span class="sd">        limit_part</span>
<span class="sd">        gamma</span>
<span class="sd">            the example-level focusing parameter</span>
<span class="sd">        alpha</span>
<span class="sd">            default is 1, which means we only use the newest KPI value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DynamicTaskPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">kpi_last</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output</span>
<span class="sd">            model&#39;s prediction</span>
<span class="sd">        target</span>
<span class="sd">            observation</span>

<span class="sd">        kpi_last</span>
<span class="sd">            the KPI value of last iteration; each element for an output</span>
<span class="sd">            It use a moving average KPI as the weighting coefficient: KPI_i = alpha * KPI_i + (1-alpha) * KPI_{i-1}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            multi-task loss by Dynamic Task Prioritization method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kpis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_out</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="c1"># kpi must be in [0, 1], as corr&#39;s range is [-1, 1], just trans corr to  (corr+1)/2</span>
            <span class="n">kpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">kpi_last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">kpi</span> <span class="o">=</span> <span class="n">kpi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">kpi_last</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                <span class="c1"># if we exclude kpi from the backward, it trans to a normal multi-task model</span>
                <span class="c1"># kpi = kpi.detach().clone() * self.alpha + kpi_last[k] * (1 - self.alpha)</span>
            <span class="n">kpis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi</span>
            <span class="c1"># focal loss</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kpi</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kpi</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fl</span> <span class="o">*</span> <span class="n">temp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># if kpi has grad_fn, backward will repeat. It won&#39;t work</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">kpis</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.DynamicTaskPrior.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_funcs</span><span class="p">,</span> <span class="n">data_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.DynamicTaskPrior.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.crits.DynamicTaskPrior.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.DynamicTaskPrior.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>loss_funcs
data_gap
device
limit_part
gamma
    the example-level focusing parameter
alpha
    default is 1, which means we only use the newest KPI value</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loss_funcs</span>
<span class="sd">    data_gap</span>
<span class="sd">    device</span>
<span class="sd">    limit_part</span>
<span class="sd">    gamma</span>
<span class="sd">        the example-level focusing parameter</span>
<span class="sd">    alpha</span>
<span class="sd">        default is 1, which means we only use the newest KPI value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DynamicTaskPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.DynamicTaskPrior.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">kpi_last</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.DynamicTaskPrior.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.crits.DynamicTaskPrior.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.DynamicTaskPrior.forward--parameters" title="Permanent link">&para;</a></h6>
<p>output
    model's prediction
target
    observation</p>
<p>kpi_last
    the KPI value of last iteration; each element for an output
    It use a moving average KPI as the weighting coefficient: KPI_i = alpha * KPI_i + (1-alpha) * KPI_{i-1}</p>
<h6 id="torchhydro.models.crits.DynamicTaskPrior.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.DynamicTaskPrior.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    multi-task loss by Dynamic Task Prioritization method</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">kpi_last</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output</span>
<span class="sd">        model&#39;s prediction</span>
<span class="sd">    target</span>
<span class="sd">        observation</span>

<span class="sd">    kpi_last</span>
<span class="sd">        the KPI value of last iteration; each element for an output</span>
<span class="sd">        It use a moving average KPI as the weighting coefficient: KPI_i = alpha * KPI_i + (1-alpha) * KPI_{i-1}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        multi-task loss by Dynamic Task Prioritization method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">kpis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_out</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># kpi must be in [0, 1], as corr&#39;s range is [-1, 1], just trans corr to  (corr+1)/2</span>
        <span class="n">kpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kpi_last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">kpi</span> <span class="o">=</span> <span class="n">kpi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">kpi_last</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="c1"># if we exclude kpi from the backward, it trans to a normal multi-task model</span>
            <span class="c1"># kpi = kpi.detach().clone() * self.alpha + kpi_last[k] * (1 - self.alpha)</span>
        <span class="n">kpis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi</span>
        <span class="c1"># focal loss</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kpi</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kpi</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fl</span> <span class="o">*</span> <span class="n">temp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if kpi has grad_fn, backward will repeat. It won&#39;t work</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">kpis</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.FloodBaseLoss" class="doc doc-heading">
        <code>
FloodBaseLoss            (<span title="torch.nn.modules.module.Module">Module</span>, <span title="abc.ABC">ABC</span>)
        </code>



<a href="#torchhydro.models.crits.FloodBaseLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Abstract base class for flood-related loss functions.</p>
<p>All flood-related loss functions should inherit from this class.
The labels tensor is expected to have the flood mask as the last column.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FloodBaseLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for flood-related loss functions.</span>

<span class="sd">    All flood-related loss functions should inherit from this class.</span>
<span class="sd">    The labels tensor is expected to have the flood mask as the last column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FloodBaseLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flood-aware loss.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictions : torch.Tensor</span>
<span class="sd">            Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">        targets : torch.Tensor</span>
<span class="sd">            Target values [batch_size, seq_len, output_features]</span>
<span class="sd">        flood_mask : torch.Tensor</span>
<span class="sd">            Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Computed loss value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass that calls the abstract compute_flood_loss method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictions : torch.Tensor</span>
<span class="sd">            Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">        targets : torch.Tensor</span>
<span class="sd">            Target values [batch_size, seq_len, output_features]</span>
<span class="sd">        flood_mask : torch.Tensor</span>
<span class="sd">            Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Computed loss value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_flood_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.FloodBaseLoss.compute_flood_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_flood_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Compute the flood-aware loss.</p>
<h6 id="torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--parameters" title="Permanent link">&para;</a></h6>
<p>predictions : torch.Tensor
    Model predictions [batch_size, seq_len, output_features]
targets : torch.Tensor
    Target values [batch_size, seq_len, output_features]
flood_mask : torch.Tensor
    Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</p>
<h6 id="torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.FloodBaseLoss.compute_flood_loss--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    Computed loss value</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the flood-aware loss.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : torch.Tensor</span>
<span class="sd">        Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">    targets : torch.Tensor</span>
<span class="sd">        Target values [batch_size, seq_len, output_features]</span>
<span class="sd">    flood_mask : torch.Tensor</span>
<span class="sd">        Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Computed loss value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.FloodBaseLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.FloodBaseLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass that calls the abstract compute_flood_loss method.</p>
<h6 id="torchhydro.models.crits.FloodBaseLoss.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.FloodBaseLoss.forward--parameters" title="Permanent link">&para;</a></h6>
<p>predictions : torch.Tensor
    Model predictions [batch_size, seq_len, output_features]
targets : torch.Tensor
    Target values [batch_size, seq_len, output_features]
flood_mask : torch.Tensor
    Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</p>
<h6 id="torchhydro.models.crits.FloodBaseLoss.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.FloodBaseLoss.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    Computed loss value</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward pass that calls the abstract compute_flood_loss method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : torch.Tensor</span>
<span class="sd">        Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">    targets : torch.Tensor</span>
<span class="sd">        Target values [batch_size, seq_len, output_features]</span>
<span class="sd">    flood_mask : torch.Tensor</span>
<span class="sd">        Flood mask [batch_size, seq_len] (1 for flood, 0 for normal)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Computed loss value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_flood_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.FloodLoss" class="doc doc-heading">
        <code>
FloodLoss            (<a class="autorefs autorefs-internal" title="
FloodBaseLoss            (Module, ABC)
         (torchhydro.models.crits.FloodBaseLoss)" href="#torchhydro.models.crits.FloodBaseLoss">FloodBaseLoss</a>)
        </code>



<a href="#torchhydro.models.crits.FloodLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FloodLoss</span><span class="p">(</span><span class="n">FloodBaseLoss</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MSELoss&quot;</span><span class="p">,</span>
        <span class="n">flood_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">non_flood_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">flood_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
        <span class="n">flood_focus_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General flood-aware loss function with configurable base loss and strategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_func : Union[torch.nn.Module, str]</span>
<span class="sd">            Base loss function to use. Can be a PyTorch loss function or string name.</span>
<span class="sd">            Supported strings: &quot;MSELoss&quot;, &quot;MAELoss&quot;, &quot;RMSELoss&quot;, &quot;L1Loss&quot;</span>
<span class="sd">        flood_weight : float</span>
<span class="sd">            Weight multiplier for flood events when using &quot;weight&quot; strategy, default is 2.0</span>
<span class="sd">        non_flood_weight : float</span>
<span class="sd">            Weight multiplier for non-flood events when using &quot;weight&quot; strategy, default is 1.0</span>
<span class="sd">        flood_strategy : str</span>
<span class="sd">            Strategy for handling flood events:</span>
<span class="sd">            - &quot;weight&quot;: Apply higher weights to flood events</span>
<span class="sd">            - &quot;focal&quot;: Use focal loss approach based on flood event frequency</span>
<span class="sd">        flood_focus_factor : float</span>
<span class="sd">            Factor for focal loss when using &quot;focal&quot; strategy, default is 2.0</span>
<span class="sd">        device : list</span>
<span class="sd">            Device configuration, default is None (auto-detect)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FloodLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flood_weight</span> <span class="o">=</span> <span class="n">flood_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_flood_weight</span> <span class="o">=</span> <span class="n">non_flood_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">=</span> <span class="n">flood_strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flood_focus_factor</span> <span class="o">=</span> <span class="n">flood_focus_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Initialize base loss function</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># NOTE: reduction=&quot;none&quot; is important, otherwise the loss will be reduced to a scalar</span>
                <span class="s2">&quot;MSELoss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
                <span class="s2">&quot;MAELoss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
                <span class="s2">&quot;L1Loss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
                <span class="s2">&quot;RMSELoss&quot;</span><span class="p">:</span> <span class="n">RMSELoss</span><span class="p">(),</span>
                <span class="s2">&quot;HybridLoss&quot;</span><span class="p">:</span> <span class="n">HybridLoss</span><span class="p">(</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mae_weight&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
                <span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">loss_func</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="n">loss_func</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported loss function string: </span><span class="si">{</span><span class="n">loss_func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">loss_func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute flood-aware loss using the specified strategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictions : torch.Tensor</span>
<span class="sd">            Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">        targets : torch.Tensor</span>
<span class="sd">            Target values [batch_size, seq_len, output_features]</span>
<span class="sd">        flood_mask : torch.Tensor</span>
<span class="sd">            Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Computed loss value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure flood_mask has correct shape</span>
        <span class="k">if</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flood_mask</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Remove last dimension if it&#39;s 1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">==</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weighted_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">==</span> <span class="s2">&quot;focal&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_focal_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported flood strategy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_weighted_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute loss with higher weights for flood events.&quot;&quot;&quot;</span>
        <span class="c1"># Compute base loss</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">,</span> <span class="n">RMSELoss</span><span class="p">):</span>
            <span class="c1"># Special handling for RMSELoss which doesn&#39;t have reduction=&quot;none&quot;</span>
            <span class="n">base_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">flood_mask</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="p">[</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>  <span class="c1"># Ensure flood_mask matches predictions/targets</span>
            <span class="n">base_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="c1"># return base_loss</span>

        <span class="c1"># Apply flood weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
            <span class="n">flood_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_flood_weight</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">predictions</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">flood_mask</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_weight</span>

        <span class="c1"># Apply weights to loss</span>
        <span class="k">if</span> <span class="n">base_loss</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># [batch, seq, features]</span>
            <span class="n">weighted_loss</span> <span class="o">=</span> <span class="n">base_loss</span> <span class="o">*</span> <span class="n">weights</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># [batch, seq]</span>
            <span class="n">weighted_loss</span> <span class="o">=</span> <span class="n">base_loss</span> <span class="o">*</span> <span class="n">weights</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weighted_loss</span><span class="p">)</span>
        <span class="n">weighted_loss</span> <span class="o">=</span> <span class="n">weighted_loss</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">,</span> <span class="n">RMSELoss</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weighted_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weighted_loss</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_focal_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute focal loss that emphasizes flood events.&quot;&quot;&quot;</span>
        <span class="c1"># Compute base loss</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">,</span> <span class="n">RMSELoss</span><span class="p">):</span>
            <span class="n">base_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

        <span class="c1"># Calculate flood ratio for focal weighting</span>
        <span class="n">flood_ratio</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [batch_size, 1]</span>

        <span class="c1"># Focal weight: higher weight when flood events are rare</span>
        <span class="n">focal_weight</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">flood_ratio</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_focus_factor</span>

        <span class="c1"># Separate flood and normal events</span>
        <span class="n">flood_loss</span> <span class="o">=</span> <span class="n">base_loss</span> <span class="o">*</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">normal_loss</span> <span class="o">=</span> <span class="n">base_loss</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

        <span class="c1"># Apply focal weight to flood events</span>
        <span class="n">weighted_flood_loss</span> <span class="o">=</span> <span class="n">flood_loss</span> <span class="o">*</span> <span class="n">focal_weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Combine losses</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">weighted_flood_loss</span> <span class="o">+</span> <span class="n">normal_loss</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span><span class="p">,</span> <span class="n">RMSELoss</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.FloodLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="s1">&#39;MSELoss&#39;</span><span class="p">,</span> <span class="n">flood_weight</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">non_flood_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">flood_strategy</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">flood_focus_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.FloodLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>General flood-aware loss function with configurable base loss and strategy.</p>
<h6 id="torchhydro.models.crits.FloodLoss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.FloodLoss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>loss_func : Union[torch.nn.Module, str]
    Base loss function to use. Can be a PyTorch loss function or string name.
    Supported strings: "MSELoss", "MAELoss", "RMSELoss", "L1Loss"
flood_weight : float
    Weight multiplier for flood events when using "weight" strategy, default is 2.0
non_flood_weight : float
    Weight multiplier for non-flood events when using "weight" strategy, default is 1.0
flood_strategy : str
    Strategy for handling flood events:
    - "weight": Apply higher weights to flood events
    - "focal": Use focal loss approach based on flood event frequency
flood_focus_factor : float
    Factor for focal loss when using "focal" strategy, default is 2.0
device : list
    Device configuration, default is None (auto-detect)</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">loss_func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MSELoss&quot;</span><span class="p">,</span>
    <span class="n">flood_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">non_flood_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">flood_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
    <span class="n">flood_focus_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General flood-aware loss function with configurable base loss and strategy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loss_func : Union[torch.nn.Module, str]</span>
<span class="sd">        Base loss function to use. Can be a PyTorch loss function or string name.</span>
<span class="sd">        Supported strings: &quot;MSELoss&quot;, &quot;MAELoss&quot;, &quot;RMSELoss&quot;, &quot;L1Loss&quot;</span>
<span class="sd">    flood_weight : float</span>
<span class="sd">        Weight multiplier for flood events when using &quot;weight&quot; strategy, default is 2.0</span>
<span class="sd">    non_flood_weight : float</span>
<span class="sd">        Weight multiplier for non-flood events when using &quot;weight&quot; strategy, default is 1.0</span>
<span class="sd">    flood_strategy : str</span>
<span class="sd">        Strategy for handling flood events:</span>
<span class="sd">        - &quot;weight&quot;: Apply higher weights to flood events</span>
<span class="sd">        - &quot;focal&quot;: Use focal loss approach based on flood event frequency</span>
<span class="sd">    flood_focus_factor : float</span>
<span class="sd">        Factor for focal loss when using &quot;focal&quot; strategy, default is 2.0</span>
<span class="sd">    device : list</span>
<span class="sd">        Device configuration, default is None (auto-detect)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">FloodLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flood_weight</span> <span class="o">=</span> <span class="n">flood_weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">non_flood_weight</span> <span class="o">=</span> <span class="n">non_flood_weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">=</span> <span class="n">flood_strategy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flood_focus_factor</span> <span class="o">=</span> <span class="n">flood_focus_factor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Initialize base loss function</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># NOTE: reduction=&quot;none&quot; is important, otherwise the loss will be reduced to a scalar</span>
            <span class="s2">&quot;MSELoss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
            <span class="s2">&quot;MAELoss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
            <span class="s2">&quot;L1Loss&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RMSELoss&quot;</span><span class="p">:</span> <span class="n">RMSELoss</span><span class="p">(),</span>
            <span class="s2">&quot;HybridLoss&quot;</span><span class="p">:</span> <span class="n">HybridLoss</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mae_weight&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">loss_func</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="n">loss_func</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported loss function string: </span><span class="si">{</span><span class="n">loss_func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">loss_func</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.FloodLoss.compute_flood_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_flood_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.FloodLoss.compute_flood_loss" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Compute flood-aware loss using the specified strategy.</p>
<h6 id="torchhydro.models.crits.FloodLoss.compute_flood_loss--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--parameters" title="Permanent link">&para;</a></h6>
<p>predictions : torch.Tensor
    Model predictions [batch_size, seq_len, output_features]
targets : torch.Tensor
    Target values [batch_size, seq_len, output_features]
flood_mask : torch.Tensor
    Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</p>
<h6 id="torchhydro.models.crits.FloodLoss.compute_flood_loss--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.FloodLoss.compute_flood_loss--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    Computed loss value</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute flood-aware loss using the specified strategy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : torch.Tensor</span>
<span class="sd">        Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">    targets : torch.Tensor</span>
<span class="sd">        Target values [batch_size, seq_len, output_features]</span>
<span class="sd">    flood_mask : torch.Tensor</span>
<span class="sd">        Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Computed loss value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure flood_mask has correct shape</span>
    <span class="k">if</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flood_mask</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Remove last dimension if it&#39;s 1</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">==</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weighted_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span> <span class="o">==</span> <span class="s2">&quot;focal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_focal_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported flood strategy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flood_strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.GaussianLoss" class="doc doc-heading">
        <code>
GaussianLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.GaussianLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GaussianLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the negative log likelihood of Gaussian Distribution</span>
<span class="sd">        From https://arxiv.org/abs/1907.00235</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GaussianLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">tdist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.GaussianLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.GaussianLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Compute the negative log likelihood of Gaussian Distribution
From https://arxiv.org/abs/1907.00235</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the negative log likelihood of Gaussian Distribution</span>
<span class="sd">    From https://arxiv.org/abs/1907.00235</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">GaussianLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.GaussianLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.GaussianLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">tdist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.HybridFloodloss" class="doc doc-heading">
        <code>
HybridFloodloss            (<a class="autorefs autorefs-internal" title="
FloodBaseLoss            (Module, ABC)
         (torchhydro.models.crits.FloodBaseLoss)" href="#torchhydro.models.crits.FloodBaseLoss">FloodBaseLoss</a>)
        </code>



<a href="#torchhydro.models.crits.HybridFloodloss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HybridFloodloss</span><span class="p">(</span><span class="n">FloodBaseLoss</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid Flood Loss: PES loss + mae_weight  MAE with flood weighting</span>

<span class="sd">        Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error,</span>
<span class="sd">        applying flood weighting to the loss.</span>

<span class="sd">        The difference from FloodLoss is that this class filter flood events first then calculate loss,</span>
<span class="sd">        because Hybrid does sigmoid on MSE, when the non-flood-weight is 0, which means we do not want to</span>
<span class="sd">        calculate loss on non-flood events, so we need to filter them out first.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mae_weight : float</span>
<span class="sd">            Weight for the MAE component, default is 0.5</span>
<span class="sd">        flood_weight : float</span>
<span class="sd">            Weight multiplier for flood events, default is 2.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HybridFloodloss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">=</span> <span class="n">mae_weight</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute flood-aware loss using the specified strategy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictions : torch.Tensor</span>
<span class="sd">            Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">        targets : torch.Tensor</span>
<span class="sd">            Target values [batch_size, seq_len, output_features]</span>
<span class="sd">        flood_mask : torch.Tensor</span>
<span class="sd">            Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Computed loss value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boolean_mask</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">boolean_mask</span><span class="p">]</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">boolean_mask</span><span class="p">]</span>

        <span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">HybridLoss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_loss_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.HybridFloodloss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.HybridFloodloss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Hybrid Flood Loss: PES loss + mae_weight  MAE with flood weighting</p>
<p>Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error,
applying flood weighting to the loss.</p>
<p>The difference from FloodLoss is that this class filter flood events first then calculate loss,
because Hybrid does sigmoid on MSE, when the non-flood-weight is 0, which means we do not want to
calculate loss on non-flood events, so we need to filter them out first.</p>
<h6 id="torchhydro.models.crits.HybridFloodloss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.HybridFloodloss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>mae_weight : float
    Weight for the MAE component, default is 0.5
flood_weight : float
    Weight multiplier for flood events, default is 2.0</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hybrid Flood Loss: PES loss + mae_weight  MAE with flood weighting</span>

<span class="sd">    Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error,</span>
<span class="sd">    applying flood weighting to the loss.</span>

<span class="sd">    The difference from FloodLoss is that this class filter flood events first then calculate loss,</span>
<span class="sd">    because Hybrid does sigmoid on MSE, when the non-flood-weight is 0, which means we do not want to</span>
<span class="sd">    calculate loss on non-flood events, so we need to filter them out first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mae_weight : float</span>
<span class="sd">        Weight for the MAE component, default is 0.5</span>
<span class="sd">    flood_weight : float</span>
<span class="sd">        Weight multiplier for flood events, default is 2.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">HybridFloodloss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">=</span> <span class="n">mae_weight</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.HybridFloodloss.compute_flood_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_flood_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Compute flood-aware loss using the specified strategy.</p>
<h6 id="torchhydro.models.crits.HybridFloodloss.compute_flood_loss--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--parameters" title="Permanent link">&para;</a></h6>
<p>predictions : torch.Tensor
    Model predictions [batch_size, seq_len, output_features]
targets : torch.Tensor
    Target values [batch_size, seq_len, output_features]
flood_mask : torch.Tensor
    Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</p>
<h6 id="torchhydro.models.crits.HybridFloodloss.compute_flood_loss--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.HybridFloodloss.compute_flood_loss--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    Computed loss value</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_flood_loss</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">flood_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute flood-aware loss using the specified strategy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : torch.Tensor</span>
<span class="sd">        Model predictions [batch_size, seq_len, output_features]</span>
<span class="sd">    targets : torch.Tensor</span>
<span class="sd">        Target values [batch_size, seq_len, output_features]</span>
<span class="sd">    flood_mask : torch.Tensor</span>
<span class="sd">        Flood mask [batch_size, seq_len, 1] (1 for flood, 0 for normal)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Computed loss value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boolean_mask</span> <span class="o">=</span> <span class="n">flood_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">boolean_mask</span><span class="p">]</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">boolean_mask</span><span class="p">]</span>

    <span class="n">base_loss_func</span> <span class="o">=</span> <span class="n">HybridLoss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base_loss_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.HybridLoss" class="doc doc-heading">
        <code>
HybridLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.HybridLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HybridLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid Loss: PES loss + mae_weight  MAE</span>

<span class="sd">        Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mae_weight : float</span>
<span class="sd">            Weight for the MAE component, default is 0.5</span>
<span class="sd">        reduction : str</span>
<span class="sd">            Reduction method for the loss, default is &quot;mean&quot;. Can be &quot;mean&quot; or &quot;none&quot;.</span>
<span class="sd">            If &quot;none&quot;, returns the loss without reduction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HybridLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pes_loss</span> <span class="o">=</span> <span class="n">PESLoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mae</span> <span class="o">=</span> <span class="n">MAELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">=</span> <span class="n">mae_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">pes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pes_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">*</span> <span class="n">mae</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">pes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">*</span> <span class="n">mae</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported reduction method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="si">}</span><span class="s2">. Use &#39;mean&#39; or &#39;none&#39;.&quot;</span>
            <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.HybridLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.HybridLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Hybrid Loss: PES loss + mae_weight  MAE</p>
<p>Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error.</p>
<h6 id="torchhydro.models.crits.HybridLoss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.HybridLoss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>mae_weight : float
    Weight for the MAE component, default is 0.5
reduction : str
    Reduction method for the loss, default is "mean". Can be "mean" or "none".
    If "none", returns the loss without reduction.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hybrid Loss: PES loss + mae_weight  MAE</span>

<span class="sd">    Combines PES loss (MSE  sigmoid(MSE)) with Mean Absolute Error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mae_weight : float</span>
<span class="sd">        Weight for the MAE component, default is 0.5</span>
<span class="sd">    reduction : str</span>
<span class="sd">        Reduction method for the loss, default is &quot;mean&quot;. Can be &quot;mean&quot; or &quot;none&quot;.</span>
<span class="sd">        If &quot;none&quot;, returns the loss without reduction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">HybridLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pes_loss</span> <span class="o">=</span> <span class="n">PESLoss</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mae</span> <span class="o">=</span> <span class="n">MAELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">=</span> <span class="n">mae_weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.HybridLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.HybridLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="n">pes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pes_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">*</span> <span class="n">mae</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">pes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae_weight</span> <span class="o">*</span> <span class="n">mae</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported reduction method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="si">}</span><span class="s2">. Use &#39;mean&#39; or &#39;none&#39;.&quot;</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.MAELoss" class="doc doc-heading">
        <code>
MAELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.MAELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MAELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="c1"># Create a mask to filter out NaN values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># Apply the mask to both target and output</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Calculate MAE for the non-NaN values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>  <span class="c1"># Return mean MAe</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">output</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Reduction must be &#39;mean&#39; or &#39;none&#39;, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MAELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.MAELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="c1"># Create a mask to filter out NaN values</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># Apply the mask to both target and output</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Calculate MAE for the non-NaN values</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>  <span class="c1"># Return mean MAe</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">output</span><span class="p">))</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">output</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Reduction must be &#39;mean&#39; or &#39;none&#39;, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.MAPELoss" class="doc doc-heading">
        <code>
MAPELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.MAPELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Returns MAPE using:
target -&gt; True y
output -&gt; Predtion by model</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MAPELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns MAPE using:</span>
<span class="sd">    target -&gt; True y</span>
<span class="sd">    output -&gt; Predtion by model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variance_penalty</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">=</span> <span class="n">variance_penalty</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MAPELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.MAPELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.MASELoss" class="doc doc-heading">
        <code>
MASELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.MASELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MASELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This implements the MASE loss function (e.g. MAE_MODEL/MAE_NAIEVE)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MASELoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_dict</span><span class="p">[</span><span class="n">baseline_method</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="c1"># Ugh why can&#39;t all tensors have batch size... Fixes for modern</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">result_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_method</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">MAE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
        <span class="n">mae2</span> <span class="o">=</span> <span class="n">MAE</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">mase4</span> <span class="o">=</span> <span class="n">MAE</span><span class="p">(</span><span class="n">result_baseline</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="c1"># Prevent divison by zero/loss exploding</span>
        <span class="k">if</span> <span class="n">mase4</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">mase4</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="k">return</span> <span class="n">mae2</span> <span class="o">/</span> <span class="n">mase4</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MASELoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_method</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.MASELoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>This implements the MASE loss function (e.g. MAE_MODEL/MAE_NAIEVE)</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This implements the MASE loss function (e.g. MAE_MODEL/MAE_NAIEVE)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MASELoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">baseline_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_dict</span><span class="p">[</span><span class="n">baseline_method</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MASELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.MASELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="c1"># Ugh why can&#39;t all tensors have batch size... Fixes for modern</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_method</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">MAE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
    <span class="n">mae2</span> <span class="o">=</span> <span class="n">MAE</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">mase4</span> <span class="o">=</span> <span class="n">MAE</span><span class="p">(</span><span class="n">result_baseline</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="c1"># Prevent divison by zero/loss exploding</span>
    <span class="k">if</span> <span class="n">mase4</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="n">mase4</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">mae2</span> <span class="o">/</span> <span class="n">mase4</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.MultiOutLoss" class="doc doc-heading">
        <code>
MultiOutLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.MultiOutLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiOutLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">item_weight</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loss function for multiple output</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_funcs</span>
<span class="sd">            The loss functions for each output</span>
<span class="sd">        data_gap</span>
<span class="sd">            It belongs to the feature dim.</span>
<span class="sd">            If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;</span>
<span class="sd">            in addition, the first non-nan value means the aggregated value of the following interval,</span>
<span class="sd">            for example, in [5, nan, nan, nan], 5 means all four data&#39;s sum, although the next 3 values are nan</span>
<span class="sd">            hence the calculation is a little different;</span>
<span class="sd">            if 2, the first non-nan value means the average value of the following interval,</span>
<span class="sd">            for example, in [5, nan, nan, nan], 5 means all four data&#39;s mean value;</span>
<span class="sd">            default is [0, 2]</span>
<span class="sd">        device</span>
<span class="sd">            the number of device: -1 -&gt; &quot;cpu&quot; or &quot;cuda:x&quot; (x is 0, 1 or ...)</span>
<span class="sd">        limit_part</span>
<span class="sd">            when transfer learning, we may ignore some part;</span>
<span class="sd">            the default is None, which means no ignorance;</span>
<span class="sd">            other choices are list, such as [0], [0, 1] or [1,2,..];</span>
<span class="sd">            0 means the first variable;</span>
<span class="sd">            tensor is [seq, time, var] or [time, seq, var]</span>
<span class="sd">        item_weight</span>
<span class="sd">            use different weight for each item&#39;s loss;</span>
<span class="sd">            for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiOutLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span> <span class="o">=</span> <span class="n">item_weight</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the sum of losses for different variables</span>

<span class="sd">        When there are NaN values in observation, we will perform a &quot;reduce&quot; operation on prediction.</span>
<span class="sd">        For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the &quot;reduce&quot; is sum;</span>
<span class="sd">        then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).</span>
<span class="sd">        Notice: when &quot;sum&quot;, actually final index is not chosen,</span>
<span class="sd">        because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.</span>
<span class="sd">        Just as the rho is 5, the final one is not chosen</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output</span>
<span class="sd">            the prediction tensor; 3-dims are time sequence, batch and feature, respectively</span>
<span class="sd">        target</span>
<span class="sd">            the observation tensor</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tensor</span>
<span class="sd">            Whole loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="c1"># sum of all k-th loss</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MultiOutLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_funcs</span><span class="p">,</span> <span class="n">data_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.MultiOutLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Loss function for multiple output</p>
<h6 id="torchhydro.models.crits.MultiOutLoss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.MultiOutLoss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>loss_funcs
    The loss functions for each output
data_gap
    It belongs to the feature dim.
    If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;
    in addition, the first non-nan value means the aggregated value of the following interval,
    for example, in [5, nan, nan, nan], 5 means all four data's sum, although the next 3 values are nan
    hence the calculation is a little different;
    if 2, the first non-nan value means the average value of the following interval,
    for example, in [5, nan, nan, nan], 5 means all four data's mean value;
    default is [0, 2]
device
    the number of device: -1 -&gt; "cpu" or "cuda:x" (x is 0, 1 or ...)
limit_part
    when transfer learning, we may ignore some part;
    the default is None, which means no ignorance;
    other choices are list, such as [0], [0, 1] or [1,2,..];
    0 means the first variable;
    tensor is [seq, time, var] or [time, seq, var]
item_weight
    use different weight for each item's loss;
    for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">item_weight</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function for multiple output</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loss_funcs</span>
<span class="sd">        The loss functions for each output</span>
<span class="sd">    data_gap</span>
<span class="sd">        It belongs to the feature dim.</span>
<span class="sd">        If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;</span>
<span class="sd">        in addition, the first non-nan value means the aggregated value of the following interval,</span>
<span class="sd">        for example, in [5, nan, nan, nan], 5 means all four data&#39;s sum, although the next 3 values are nan</span>
<span class="sd">        hence the calculation is a little different;</span>
<span class="sd">        if 2, the first non-nan value means the average value of the following interval,</span>
<span class="sd">        for example, in [5, nan, nan, nan], 5 means all four data&#39;s mean value;</span>
<span class="sd">        default is [0, 2]</span>
<span class="sd">    device</span>
<span class="sd">        the number of device: -1 -&gt; &quot;cpu&quot; or &quot;cuda:x&quot; (x is 0, 1 or ...)</span>
<span class="sd">    limit_part</span>
<span class="sd">        when transfer learning, we may ignore some part;</span>
<span class="sd">        the default is None, which means no ignorance;</span>
<span class="sd">        other choices are list, such as [0], [0, 1] or [1,2,..];</span>
<span class="sd">        0 means the first variable;</span>
<span class="sd">        tensor is [seq, time, var] or [time, seq, var]</span>
<span class="sd">    item_weight</span>
<span class="sd">        use different weight for each item&#39;s loss;</span>
<span class="sd">        for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">item_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">item_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiOutLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span> <span class="o">=</span> <span class="n">item_weight</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MultiOutLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.MultiOutLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Calculate the sum of losses for different variables</p>
<p>When there are NaN values in observation, we will perform a "reduce" operation on prediction.
For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the "reduce" is sum;
then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).
Notice: when "sum", actually final index is not chosen,
because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.
Just as the rho is 5, the final one is not chosen</p>
<h6 id="torchhydro.models.crits.MultiOutLoss.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.MultiOutLoss.forward--parameters" title="Permanent link">&para;</a></h6>
<p>output
    the prediction tensor; 3-dims are time sequence, batch and feature, respectively
target
    the observation tensor</p>
<h6 id="torchhydro.models.crits.MultiOutLoss.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.MultiOutLoss.forward--returns" title="Permanent link">&para;</a></h6>
<p>Tensor
    Whole loss</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the sum of losses for different variables</span>

<span class="sd">    When there are NaN values in observation, we will perform a &quot;reduce&quot; operation on prediction.</span>
<span class="sd">    For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the &quot;reduce&quot; is sum;</span>
<span class="sd">    then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).</span>
<span class="sd">    Notice: when &quot;sum&quot;, actually final index is not chosen,</span>
<span class="sd">    because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.</span>
<span class="sd">    Just as the rho is 5, the final one is not chosen</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output</span>
<span class="sd">        the prediction tensor; 3-dims are time sequence, batch and feature, respectively</span>
<span class="sd">    target</span>
<span class="sd">        the observation tensor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tensor</span>
<span class="sd">        Whole loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># sum of all k-th loss</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.MultiOutWaterBalanceLoss" class="doc doc-heading">
        <code>
MultiOutWaterBalanceLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiOutWaterBalanceLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">item_weight</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">wb_loss_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loss function for multiple output considering water balance</span>

<span class="sd">        loss = alpha * water_balance_loss + (1-alpha) * mtl_loss</span>

<span class="sd">        This loss function is only for p, q, et now</span>
<span class="sd">        we use the difference between p_obs_mean-q_obs_mean-et_obs_mean and p_pred_mean-q_pred_mean-et_pred_mean as water balance loss</span>
<span class="sd">        which is the difference between (q_obs_mean + et_obs_mean) and (q_pred_mean + et_pred_mean)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loss_funcs</span>
<span class="sd">            The loss functions for each output</span>
<span class="sd">        data_gap</span>
<span class="sd">            It belongs to the feature dim.</span>
<span class="sd">            If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;</span>
<span class="sd">            in addition, the first non-nan value means the aggregated value of the following interval,</span>
<span class="sd">            for example, in [5, nan, nan, nan], 5 means all four data&#39;s sum, although the next 3 values are nan</span>
<span class="sd">            hence the calculation is a little different;</span>
<span class="sd">            if 2, the first non-nan value means the average value of the following interval,</span>
<span class="sd">            for example, in [5, nan, nan, nan], 5 means all four data&#39;s mean value;</span>
<span class="sd">            default is [0, 2]</span>
<span class="sd">        device</span>
<span class="sd">            the number of device: -1 -&gt; &quot;cpu&quot; or &quot;cuda:x&quot; (x is 0, 1 or ...)</span>
<span class="sd">        limit_part</span>
<span class="sd">            when transfer learning, we may ignore some part;</span>
<span class="sd">            the default is None, which means no ignorance;</span>
<span class="sd">            other choices are list, such as [0], [0, 1] or [1,2,..];</span>
<span class="sd">            0 means the first variable;</span>
<span class="sd">            tensor is [seq, time, var] or [time, seq, var]</span>
<span class="sd">        item_weight</span>
<span class="sd">            use different weight for each item&#39;s loss;</span>
<span class="sd">            for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2</span>
<span class="sd">        alpha</span>
<span class="sd">            the weight of the water-balance item&#39;s loss</span>
<span class="sd">        beta</span>
<span class="sd">            the weight of real water-balance item&#39;s loss, et_mean/p_mean + q_mean/p_mean = 1 can be a loss.</span>
<span class="sd">            It is not strictly correct as training batch only have about one year data, but still could be a constraint</span>
<span class="sd">        wb_loss_func</span>
<span class="sd">            the loss function for water balance item, by default it is None, which means we use function in loss_funcs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiOutWaterBalanceLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span> <span class="o">=</span> <span class="n">item_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span> <span class="o">=</span> <span class="n">wb_loss_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">means</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="n">stds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the sum of losses for different variables and water-balance loss</span>

<span class="sd">        When there are NaN values in observation, we will perform a &quot;reduce&quot; operation on prediction.</span>
<span class="sd">        For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the &quot;reduce&quot; is sum;</span>
<span class="sd">        then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).</span>
<span class="sd">        Notice: when &quot;sum&quot;, actually final index is not chosen,</span>
<span class="sd">        because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.</span>
<span class="sd">        Just as the rho is 5, the final one is not chosen</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output</span>
<span class="sd">            the prediction tensor; 3-dims are time sequence, batch and feature, respectively</span>
<span class="sd">        target</span>
<span class="sd">            the observation tensor</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tensor</span>
<span class="sd">            Whole loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">p_means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t_means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>
        <span class="n">all_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="c1"># for water balance loss</span>
            <span class="k">if</span> <span class="n">all_means</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># denormalize for q and et</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="n">all_stds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_means</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">*</span> <span class="n">all_stds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_means</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">p1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">t1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">p_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">t_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">t_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">p_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_mean</span><span class="p">)</span>
            <span class="n">t_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_mean</span><span class="p">)</span>
            <span class="c1"># for mtl normal loss</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="c1"># sum of all k-th loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
        <span class="c1"># water balance loss</span>
        <span class="n">p_mean_q_plus_et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">p_means</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_mean_q_plus_et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">t_means</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wb_ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t_mean_q_plus_et</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="c1"># if wb_loss_func is None, we use the first loss function in loss_funcs</span>
                <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
                <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
                <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
            <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">wb_loss</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">wb_1loss</span>
        <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_funcs</span><span class="p">,</span> <span class="n">data_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wb_loss_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Loss function for multiple output considering water balance</p>
<p>loss = alpha * water_balance_loss + (1-alpha) * mtl_loss</p>
<p>This loss function is only for p, q, et now
we use the difference between p_obs_mean-q_obs_mean-et_obs_mean and p_pred_mean-q_pred_mean-et_pred_mean as water balance loss
which is the difference between (q_obs_mean + et_obs_mean) and (q_pred_mean + et_pred_mean)</p>
<h6 id="torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>loss_funcs
    The loss functions for each output
data_gap
    It belongs to the feature dim.
    If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;
    in addition, the first non-nan value means the aggregated value of the following interval,
    for example, in [5, nan, nan, nan], 5 means all four data's sum, although the next 3 values are nan
    hence the calculation is a little different;
    if 2, the first non-nan value means the average value of the following interval,
    for example, in [5, nan, nan, nan], 5 means all four data's mean value;
    default is [0, 2]
device
    the number of device: -1 -&gt; "cpu" or "cuda:x" (x is 0, 1 or ...)
limit_part
    when transfer learning, we may ignore some part;
    the default is None, which means no ignorance;
    other choices are list, such as [0], [0, 1] or [1,2,..];
    0 means the first variable;
    tensor is [seq, time, var] or [time, seq, var]
item_weight
    use different weight for each item's loss;
    for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2
alpha
    the weight of the water-balance item's loss
beta
    the weight of real water-balance item's loss, et_mean/p_mean + q_mean/p_mean = 1 can be a loss.
    It is not strictly correct as training batch only have about one year data, but still could be a constraint
wb_loss_func
    the loss function for water balance item, by default it is None, which means we use function in loss_funcs</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">item_weight</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">wb_loss_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function for multiple output considering water balance</span>

<span class="sd">    loss = alpha * water_balance_loss + (1-alpha) * mtl_loss</span>

<span class="sd">    This loss function is only for p, q, et now</span>
<span class="sd">    we use the difference between p_obs_mean-q_obs_mean-et_obs_mean and p_pred_mean-q_pred_mean-et_pred_mean as water balance loss</span>
<span class="sd">    which is the difference between (q_obs_mean + et_obs_mean) and (q_pred_mean + et_pred_mean)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loss_funcs</span>
<span class="sd">        The loss functions for each output</span>
<span class="sd">    data_gap</span>
<span class="sd">        It belongs to the feature dim.</span>
<span class="sd">        If 1, then the corresponding value is uniformly-spaced with NaN values filling the gap;</span>
<span class="sd">        in addition, the first non-nan value means the aggregated value of the following interval,</span>
<span class="sd">        for example, in [5, nan, nan, nan], 5 means all four data&#39;s sum, although the next 3 values are nan</span>
<span class="sd">        hence the calculation is a little different;</span>
<span class="sd">        if 2, the first non-nan value means the average value of the following interval,</span>
<span class="sd">        for example, in [5, nan, nan, nan], 5 means all four data&#39;s mean value;</span>
<span class="sd">        default is [0, 2]</span>
<span class="sd">    device</span>
<span class="sd">        the number of device: -1 -&gt; &quot;cpu&quot; or &quot;cuda:x&quot; (x is 0, 1 or ...)</span>
<span class="sd">    limit_part</span>
<span class="sd">        when transfer learning, we may ignore some part;</span>
<span class="sd">        the default is None, which means no ignorance;</span>
<span class="sd">        other choices are list, such as [0], [0, 1] or [1,2,..];</span>
<span class="sd">        0 means the first variable;</span>
<span class="sd">        tensor is [seq, time, var] or [time, seq, var]</span>
<span class="sd">    item_weight</span>
<span class="sd">        use different weight for each item&#39;s loss;</span>
<span class="sd">        for example, the default values [0.5, 0.5] means 0.5 * loss1 + 0.5 * loss2</span>
<span class="sd">    alpha</span>
<span class="sd">        the weight of the water-balance item&#39;s loss</span>
<span class="sd">    beta</span>
<span class="sd">        the weight of real water-balance item&#39;s loss, et_mean/p_mean + q_mean/p_mean = 1 can be a loss.</span>
<span class="sd">        It is not strictly correct as training batch only have about one year data, but still could be a constraint</span>
<span class="sd">    wb_loss_func</span>
<span class="sd">        the loss function for water balance item, by default it is None, which means we use function in loss_funcs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">item_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">item_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MultiOutWaterBalanceLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span> <span class="o">=</span> <span class="n">item_weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span> <span class="o">=</span> <span class="n">wb_loss_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">means</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="n">stds</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.MultiOutWaterBalanceLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Calculate the sum of losses for different variables and water-balance loss</p>
<p>When there are NaN values in observation, we will perform a "reduce" operation on prediction.
For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the "reduce" is sum;
then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).
Notice: when "sum", actually final index is not chosen,
because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.
Just as the rho is 5, the final one is not chosen</p>
<h6 id="torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--parameters" title="Permanent link">&para;</a></h6>
<p>output
    the prediction tensor; 3-dims are time sequence, batch and feature, respectively
target
    the observation tensor</p>
<h6 id="torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.MultiOutWaterBalanceLoss.forward--returns" title="Permanent link">&para;</a></h6>
<p>Tensor
    Whole loss</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the sum of losses for different variables and water-balance loss</span>

<span class="sd">    When there are NaN values in observation, we will perform a &quot;reduce&quot; operation on prediction.</span>
<span class="sd">    For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the &quot;reduce&quot; is sum;</span>
<span class="sd">    then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).</span>
<span class="sd">    Notice: when &quot;sum&quot;, actually final index is not chosen,</span>
<span class="sd">    because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.</span>
<span class="sd">    Just as the rho is 5, the final one is not chosen</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output</span>
<span class="sd">        the prediction tensor; 3-dims are time sequence, batch and feature, respectively</span>
<span class="sd">    target</span>
<span class="sd">        the observation tensor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tensor</span>
<span class="sd">        Whole loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>
    <span class="n">all_stds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="c1"># for water balance loss</span>
        <span class="k">if</span> <span class="n">all_means</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># denormalize for q and et</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="n">all_stds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_means</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">*</span> <span class="n">all_stds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_means</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">p1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">t1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">p_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">t_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">t_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_mean</span><span class="p">)</span>
        <span class="n">t_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_mean</span><span class="p">)</span>
        <span class="c1"># for mtl normal loss</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_weight</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># sum of all k-th loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
    <span class="c1"># water balance loss</span>
    <span class="n">p_mean_q_plus_et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">p_means</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_mean_q_plus_et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">t_means</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">wb_ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t_mean_q_plus_et</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c1"># if wb_loss_func is None, we use the first loss function in loss_funcs</span>
            <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
            <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
            <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">t_mean_q_plus_et</span><span class="p">)</span>
        <span class="n">wb_1loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_loss_func</span><span class="p">(</span><span class="n">p_mean_q_plus_et</span><span class="p">,</span> <span class="n">wb_ones</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">wb_loss</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">wb_1loss</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.NSELoss" class="doc doc-heading">
        <code>
NSELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.NSELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NSELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># Same as Fredrick 2019</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NSELoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">Ngage</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">losssum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nsample</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ngage</span><span class="p">):</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">tmean</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">SST</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">tmean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">SSRes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">SSRes</span> <span class="o">/</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SST</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># original NSE</span>
                <span class="c1"># temp = SSRes / SST</span>
                <span class="n">losssum</span> <span class="o">=</span> <span class="n">losssum</span> <span class="o">+</span> <span class="n">temp</span>
                <span class="n">nsample</span> <span class="o">=</span> <span class="n">nsample</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">losssum</span> <span class="o">/</span> <span class="n">nsample</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.NSELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.NSELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">Ngage</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">losssum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nsample</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ngage</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">tmean</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">SST</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">tmean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">SSRes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">SSRes</span> <span class="o">/</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SST</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># original NSE</span>
            <span class="c1"># temp = SSRes / SST</span>
            <span class="n">losssum</span> <span class="o">=</span> <span class="n">losssum</span> <span class="o">+</span> <span class="n">temp</span>
            <span class="n">nsample</span> <span class="o">=</span> <span class="n">nsample</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">losssum</span> <span class="o">/</span> <span class="n">nsample</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.NegativeLogLikelihood" class="doc doc-heading">
        <code>
NegativeLogLikelihood            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.NegativeLogLikelihood" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>target -&gt; True y
output -&gt; predicted distribution</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NegativeLogLikelihood</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    target -&gt; True y</span>
<span class="sd">    output -&gt; predicted distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculates NegativeLogLikelihood</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.NegativeLogLikelihood.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.NegativeLogLikelihood.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>calculates NegativeLogLikelihood</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculates NegativeLogLikelihood</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.PESLoss" class="doc doc-heading">
        <code>
PESLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.PESLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PESLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PES Loss: MSE  sigmoid(MSE)</span>

<span class="sd">        This loss function applies a sigmoid activation to MSE and then multiplies it with MSE,</span>
<span class="sd">        creating a non-linear penalty that increases more gradually for larger errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PESLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">mse_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">sigmoid_mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">mse_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mse_value</span> <span class="o">*</span> <span class="n">sigmoid_mse</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.PESLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.PESLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>PES Loss: MSE  sigmoid(MSE)</p>
<p>This loss function applies a sigmoid activation to MSE and then multiplies it with MSE,
creating a non-linear penalty that increases more gradually for larger errors.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PES Loss: MSE  sigmoid(MSE)</span>

<span class="sd">    This loss function applies a sigmoid activation to MSE and then multiplies it with MSE,</span>
<span class="sd">    creating a non-linear penalty that increases more gradually for larger errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">PESLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.PESLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.PESLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="n">mse_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">sigmoid_mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">mse_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mse_value</span> <span class="o">*</span> <span class="n">sigmoid_mse</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.PenalizedMSELoss" class="doc doc-heading">
        <code>
PenalizedMSELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.PenalizedMSELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Returns MSE using:
target -&gt; True y
output -&gt; Predtion by model
source: https://discuss.pytorch.org/t/rmse-loss-function/16540/3</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PenalizedMSELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns MSE using:</span>
<span class="sd">    target -&gt; True y</span>
<span class="sd">    output -&gt; Predtion by model</span>
<span class="sd">    source: https://discuss.pytorch.org/t/rmse-loss-function/16540/3</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variance_penalty</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">=</span> <span class="n">variance_penalty</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.PenalizedMSELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.PenalizedMSELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.QuantileLoss" class="doc doc-heading">
        <code>
QuantileLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.QuantileLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>From https://medium.com/the-artificial-impostor/quantile-regression-part-2-6fdbc26b2629</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">QuantileLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;From https://medium.com/the-artificial-impostor/quantile-regression-part-2-6fdbc26b2629&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantiles</span> <span class="o">=</span> <span class="n">quantiles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">requires_grad</span>
        <span class="k">assert</span> <span class="n">preds</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantiles</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">preds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">errors</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span> <span class="n">errors</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.QuantileLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.QuantileLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">requires_grad</span>
    <span class="k">assert</span> <span class="n">preds</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantiles</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">preds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">errors</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span> <span class="n">errors</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.RMSELoss" class="doc doc-heading">
        <code>
RMSELoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.RMSELoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RMSELoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variance_penalty</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate RMSE</span>

<span class="sd">        using:</span>
<span class="sd">            target -&gt; True y</span>
<span class="sd">            output -&gt; Prediction by model</span>
<span class="sd">            source: https://discuss.pytorch.org/t/rmse-loss-function/16540/3</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variance_penalty</span>
<span class="sd">            penalty for big variance; default is 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">=</span> <span class="n">variance_penalty</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">std_dev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">var_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">std_dev</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span> <span class="o">+</span> <span class="n">var_penalty</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.RMSELoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variance_penalty</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.RMSELoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Calculate RMSE</p>
<p>!!! using
    target -&gt; True y
    output -&gt; Prediction by model
    source: https://discuss.pytorch.org/t/rmse-loss-function/16540/3</p>
<h6 id="torchhydro.models.crits.RMSELoss.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.RMSELoss.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>variance_penalty
    penalty for big variance; default is 0</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variance_penalty</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate RMSE</span>

<span class="sd">    using:</span>
<span class="sd">        target -&gt; True y</span>
<span class="sd">        output -&gt; Prediction by model</span>
<span class="sd">        source: https://discuss.pytorch.org/t/rmse-loss-function/16540/3</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    variance_penalty</span>
<span class="sd">        penalty for big variance; default is 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">=</span> <span class="n">variance_penalty</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.RMSELoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.RMSELoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="n">std_dev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">var_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_penalty</span> <span class="o">*</span> <span class="n">std_dev</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span> <span class="o">+</span> <span class="n">var_penalty</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.RmseLoss" class="doc doc-heading">
        <code>
RmseLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.RmseLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RmseLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RMSE loss which could ignore NaN values</span>

<span class="sd">        Now we only support 3-d tensor and 1-d tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RmseLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">target</span> <span class="o">==</span> <span class="n">target</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.RmseLoss.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.crits.RmseLoss.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>RMSE loss which could ignore NaN values</p>
<p>Now we only support 3-d tensor and 1-d tensor</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RMSE loss which could ignore NaN values</span>

<span class="sd">    Now we only support 3-d tensor and 1-d tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">RmseLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.RmseLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.RmseLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">target</span> <span class="o">==</span> <span class="n">target</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">temp</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.SigmaLoss" class="doc doc-heading">
        <code>
SigmaLoss            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.SigmaLoss" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SigmaLoss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SigmaLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="s2">&quot;elementwise_mean&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">prior</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">prior</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lossMean</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;invGamma&quot;</span><span class="p">:</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">nt</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">/</span> <span class="n">nt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="n">nt</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span>
                <span class="p">)</span>
            <span class="n">lossMean</span> <span class="o">=</span> <span class="n">lossMean</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lossMean</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.SigmaLoss.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.SigmaLoss.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lossMean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;invGamma&quot;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">nt</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">/</span> <span class="n">nt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="n">nt</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span>
            <span class="p">)</span>
        <span class="n">lossMean</span> <span class="o">=</span> <span class="n">lossMean</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lossMean</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.crits.UncertaintyWeights" class="doc doc-heading">
        <code>
UncertaintyWeights            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.crits.UncertaintyWeights" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Uncertainty Weights (UW).</p>
<p>This method is proposed in <code>Multi-Task Learning Using Uncertainty to Weigh Losses for Scene Geometry and Semantics (CVPR 2018) &lt;https://openaccess.thecvf.com/content_cvpr_2018/papers/Kendall_Multi-Task_Learning_Using_CVPR_2018_paper.pdf&gt;</code>_ \
and implemented by us.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UncertaintyWeights</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Uncertainty Weights (UW).</span>

<span class="sd">    This method is proposed in `Multi-Task Learning Using Uncertainty to Weigh Losses for Scene Geometry and Semantics (CVPR 2018) &lt;https://openaccess.thecvf.com/content_cvpr_2018/papers/Kendall_Multi-Task_Learning_Using_CVPR_2018_paper.pdf&gt;`_ \</span>
<span class="sd">    and implemented by us.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss_funcs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">data_gap</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_part</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">data_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_gap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UncertaintyWeights</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span> <span class="o">=</span> <span class="n">loss_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">data_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_the_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="o">=</span> <span class="n">limit_part</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">log_vars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output</span>
<span class="sd">        target</span>
<span class="sd">        log_vars</span>
<span class="sd">            sigma in uncertainty weighting;</span>
<span class="sd">            default is None, meaning we manually set weights for different target&#39;s loss;</span>
<span class="sd">            more info could be seen in</span>
<span class="sd">            https://libmtl.readthedocs.io/en/latest/docs/_autoapi/LibMTL/weighting/index.html#LibMTL.weighting.UW</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            multi-task loss by uncertainty weighting method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">log_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">precision</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">log_vars</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.crits.UncertaintyWeights.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">log_vars</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.UncertaintyWeights.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.crits.UncertaintyWeights.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.UncertaintyWeights.forward--parameters" title="Permanent link">&para;</a></h6>
<p>output
target
log_vars
    sigma in uncertainty weighting;
    default is None, meaning we manually set weights for different target's loss;
    more info could be seen in
    https://libmtl.readthedocs.io/en/latest/docs/_autoapi/LibMTL/weighting/index.html#LibMTL.weighting.UW</p>
<h6 id="torchhydro.models.crits.UncertaintyWeights.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.UncertaintyWeights.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    multi-task loss by uncertainty weighting method</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">log_vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output</span>
<span class="sd">    target</span>
<span class="sd">    log_vars</span>
<span class="sd">        sigma in uncertainty weighting;</span>
<span class="sd">        default is None, meaning we manually set weights for different target&#39;s loss;</span>
<span class="sd">        more info could be seen in</span>
<span class="sd">        https://libmtl.readthedocs.io/en/latest/docs/_autoapi/LibMTL/weighting/index.html#LibMTL.weighting.UW</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        multi-task loss by uncertainty weighting method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_out</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">log_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_part</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">deal_gap_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">precision</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">log_vars</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.crits.deal_gap_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">deal_gap_data</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">data_gap</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.deal_gap_data" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>How to handle with gap data</p>
<p>When there are NaN values in observation, we will perform a "reduce" operation on prediction.
For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the "reduce" is sum;
then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).
Notice: when "sum", actually final index is not chosen,
because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.
Just as the rho is 5, the final one is not chosen</p>
<h5 id="torchhydro.models.crits.deal_gap_data--parameters">Parameters<a class="headerlink" href="#torchhydro.models.crits.deal_gap_data--parameters" title="Permanent link">&para;</a></h5>
<p>output
    model output for k-th variable
target
    target for k-th variable
data_gap
    data_gap=1: reduce is sum
    data_gap=2: reduce is mean
device
    where to save the data</p>
<h5 id="torchhydro.models.crits.deal_gap_data--returns">Returns<a class="headerlink" href="#torchhydro.models.crits.deal_gap_data--returns" title="Permanent link">&para;</a></h5>
<p>tuple[tensor, tensor]
    output and target after dealing with gap</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">deal_gap_data</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">data_gap</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    How to handle with gap data</span>

<span class="sd">    When there are NaN values in observation, we will perform a &quot;reduce&quot; operation on prediction.</span>
<span class="sd">    For example, pred = [0,1,2,3,4], obs=[5, nan, nan, 6, nan]; the &quot;reduce&quot; is sum;</span>
<span class="sd">    then, pred_sum = [0+1+2, 3+4], obs_sum=[5,6], loss = loss_func(pred_sum, obs_sum).</span>
<span class="sd">    Notice: when &quot;sum&quot;, actually final index is not chosen,</span>
<span class="sd">    because the whole observation may be [5, nan, nan, 6, nan, nan, 7, nan, nan], 6 means sum of three elements.</span>
<span class="sd">    Just as the rho is 5, the final one is not chosen</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output</span>
<span class="sd">        model output for k-th variable</span>
<span class="sd">    target</span>
<span class="sd">        target for k-th variable</span>
<span class="sd">    data_gap</span>
<span class="sd">        data_gap=1: reduce is sum</span>
<span class="sd">        data_gap=2: reduce is mean</span>
<span class="sd">    device</span>
<span class="sd">        where to save the data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tensor, tensor]</span>
<span class="sd">        output and target after dealing with gap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># all members in a batch has different NaN-gap, so we need a loop</span>
    <span class="n">seg_p_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seg_t_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">non_nan_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]),</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;All NaN elements, please check your data&quot;</span><span class="p">)</span>

        <span class="c1">#  cumsum  scatter_index</span>
        <span class="n">is_not_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">cumsum_is_not_nan</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">is_not_nan</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">first_non_nan</span> <span class="o">=</span> <span class="n">non_nan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scatter_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
            <span class="n">target</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span>
        <span class="p">)</span>  <span class="c1">#  -1</span>
        <span class="n">scatter_index</span><span class="p">[</span><span class="n">first_non_nan</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumsum_is_not_nan</span><span class="p">[</span><span class="n">first_non_nan</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">scatter_index</span> <span class="o">=</span> <span class="n">scatter_index</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># </span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">scatter_index</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">data_gap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_idx</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scatter_add_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scatter_index</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="c1"># for sum, better exclude final non-nan value as it didn&#39;t include all necessary periods</span>
            <span class="n">seg_p_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">seg_t_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">non_nan_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">j</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">data_gap</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_idx</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scatter_add_</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">scatter_index</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_idx</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scatter_add_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scatter_index</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">seg</span> <span class="o">/</span> <span class="n">counts</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># for mean, we can include all periods</span>
            <span class="n">seg_p_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
            <span class="n">seg_t_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">non_nan_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;We have not provided this reduce way now!! Please choose 1 or 2!!&quot;</span>
            <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">seg_p_lst</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">seg_t_lst</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.crits.l1_regularizer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l1_regularizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lambda_l1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.l1_regularizer" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>source: https://stackoverflow.com/questions/58172188/how-to-add-l1-regularization-to-pytorch-nn-model</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">l1_regularizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lambda_l1</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    source: https://stackoverflow.com/questions/58172188/how-to-add-l1-regularization-to-pytorch-nn-model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lossl1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">model_param_name</span><span class="p">,</span> <span class="n">model_param_value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">model_param_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">):</span>
            <span class="n">lossl1</span> <span class="o">+=</span> <span class="n">lambda_l1</span> <span class="o">*</span> <span class="n">model_param_value</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lossl1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.crits.orth_regularizer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">orth_regularizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lambda_orth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></code>


<a href="#torchhydro.models.crits.orth_regularizer" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>source: https://stackoverflow.com/questions/58172188/how-to-add-l1-regularization-to-pytorch-nn-model</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/crits.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">orth_regularizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lambda_orth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    source: https://stackoverflow.com/questions/58172188/how-to-add-l1-regularization-to-pytorch-nn-model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lossorth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">model_param_name</span><span class="p">,</span> <span class="n">model_param_value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">model_param_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">):</span>
            <span class="n">param_flat</span> <span class="o">=</span> <span class="n">model_param_value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">model_param_value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">param_flat</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">param_flat</span><span class="p">))</span>
            <span class="n">sym</span> <span class="o">-=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">param_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">lossorth</span> <span class="o">+=</span> <span class="n">lambda_orth</span> <span class="o">*</span> <span class="n">sym</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lossorth</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.cudnnlstm" class="doc doc-heading">
        <code>cudnnlstm</code>



<a href="#torchhydro.models.cudnnlstm" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: MHPI group, Wenyu Ouyang
Date: 2021-12-31 11:08:29
LastEditTime: 2024-10-09 16:36:34
LastEditors: Wenyu Ouyang
Description: LSTM with dropout implemented by Kuai Fang and more LSTMs using it
FilePath:       orchhydro       orchhydro\models\cudnnlstm.py
Copyright (c) 2021-2022 MHPI group, Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CNN1dKernel" class="doc doc-heading">
        <code>
CNN1dKernel            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CNN1dKernel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CNN1dKernel</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ninchannel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nkernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kernelSize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN1dKernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn1d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">ninchannel</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="n">nkernel</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernelSize</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;CNN1dkernel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_legacy</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cnn1d</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CNN1dKernel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CNN1dKernel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cnn1d</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CNN1dLCmodel" class="doc doc-heading">
        <code>
CNN1dLCmodel            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CNN1dLCmodel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># Directly add the CNN extracted features into LSTM inputSize</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">,</span>
        <span class="n">nobs</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">n_kernel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">kernel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">stride</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">pool_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cnn_dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">cat_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;cat_first means: we will concatenate the CNN output with the x, then input them to the CudnnLstm model;</span>
<span class="sd">        if not cat_first, it is relu_first, meaning we will relu the CNN output firstly, then concatenate it with x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># two convolutional layer</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN1dLCmodel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># N_cnn_out</span>
        <span class="c1"># nx</span>
        <span class="c1"># ny1</span>
        <span class="c1"># nobsCNN</span>
        <span class="c1"># hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">nobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="n">n_layer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_kernel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">n_in_chan</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="n">nobs</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layer</span><span class="p">):</span>
            <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">CNN1dKernel</span><span class="p">(</span>
                <span class="n">ninchannel</span><span class="o">=</span><span class="n">n_in_chan</span><span class="p">,</span>
                <span class="n">nkernel</span><span class="o">=</span><span class="n">n_kernel</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                <span class="n">kernelSize</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;CnnLayer</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">conv_layer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cnn_dr</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;dropout</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">cnn_dr</span><span class="p">))</span>
            <span class="n">n_in_chan</span> <span class="o">=</span> <span class="n">n_kernel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">lout</span> <span class="o">=</span> <span class="n">cal_conv_size</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="n">lout</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;Relu</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">pool_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                    <span class="s2">&quot;Pooling</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool1d</span><span class="p">(</span><span class="n">pool_opt</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">lout</span> <span class="o">=</span> <span class="n">cal_pool_size</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="n">lout</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">pool_opt</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">lout</span> <span class="o">*</span> <span class="n">n_kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># total CNN feature number after convolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_first</span> <span class="o">=</span> <span class="n">cat_first</span>
        <span class="c1"># </span>
        <span class="c1"># CNN</span>
        <span class="c1"># </span>
        <span class="k">if</span> <span class="n">cat_first</span><span class="p">:</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">+</span> <span class="n">nx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
            <span class="c1"># CudnnLstmhc</span>
            <span class="c1"># </span>
            <span class="c1"># </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
                <span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">+</span> <span class="n">hidden_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">nf</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># z = n_grid*nVar add a channel dimension</span>
        <span class="c1"># z = z.t()</span>
        <span class="n">n_grid</span><span class="p">,</span> <span class="n">nobs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_grid</span> <span class="o">*</span> <span class="n">nobs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n_t</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">n_var</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># add a channel dimension</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># z0 = (n_grid) * n_kernel * sizeafterconv</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_first</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CNN1dLCmodel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nobs</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">n_kernel</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">pool_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cnn_dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cat_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>cat_first means: we will concatenate the CNN output with the x, then input them to the CudnnLstm model;
if not cat_first, it is relu_first, meaning we will relu the CNN output firstly, then concatenate it with x</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">,</span>
    <span class="n">nobs</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">,</span>
    <span class="n">n_kernel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">kernel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">stride</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">pool_opt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cnn_dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">cat_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;cat_first means: we will concatenate the CNN output with the x, then input them to the CudnnLstm model;</span>
<span class="sd">    if not cat_first, it is relu_first, meaning we will relu the CNN output firstly, then concatenate it with x</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># two convolutional layer</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CNN1dLCmodel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="c1"># N_cnn_out</span>
    <span class="c1"># nx</span>
    <span class="c1"># ny1</span>
    <span class="c1"># nobsCNN</span>
    <span class="c1"># hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">nx</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">ny</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span> <span class="o">=</span> <span class="n">hidden_size</span>
    <span class="n">n_layer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_kernel</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">n_in_chan</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lout</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layer</span><span class="p">):</span>
        <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">CNN1dKernel</span><span class="p">(</span>
            <span class="n">ninchannel</span><span class="o">=</span><span class="n">n_in_chan</span><span class="p">,</span>
            <span class="n">nkernel</span><span class="o">=</span><span class="n">n_kernel</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
            <span class="n">kernelSize</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;CnnLayer</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">conv_layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnn_dr</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;dropout</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">cnn_dr</span><span class="p">))</span>
        <span class="n">n_in_chan</span> <span class="o">=</span> <span class="n">n_kernel</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="n">cal_conv_size</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="n">lout</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&quot;Relu</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">pool_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s2">&quot;Pooling</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool1d</span><span class="p">(</span><span class="n">pool_opt</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">lout</span> <span class="o">=</span> <span class="n">cal_pool_size</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="n">lout</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">pool_opt</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">lout</span> <span class="o">*</span> <span class="n">n_kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># total CNN feature number after convolution</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cat_first</span> <span class="o">=</span> <span class="n">cat_first</span>
    <span class="c1"># </span>
    <span class="c1"># CNN</span>
    <span class="c1"># </span>
    <span class="k">if</span> <span class="n">cat_first</span><span class="p">:</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">+</span> <span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="c1"># CudnnLstmhc</span>
        <span class="c1"># </span>
        <span class="c1"># </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span> <span class="o">+</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">nf</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CNN1dLCmodel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CNN1dLCmodel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># z = n_grid*nVar add a channel dimension</span>
    <span class="c1"># z = z.t()</span>
    <span class="n">n_grid</span><span class="p">,</span> <span class="n">nobs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_grid</span> <span class="o">*</span> <span class="n">nobs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n_t</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">n_var</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># add a channel dimension</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="c1"># z0 = (n_grid) * n_kernel * sizeafterconv</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_cnn_out</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_first</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CpuLstmModel" class="doc doc-heading">
        <code>
CpuLstmModel            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CpuLstmModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Cpu version of CudnnLstmModel</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CpuLstmModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cpu version of CudnnLstmModel&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CpuLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">n_input_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">n_output_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span> <span class="o">=</span> <span class="n">n_hidden_states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nLayer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">LstmCellTied</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span>
            <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">,</span>
            <span class="n">dr_method</span><span class="o">=</span><span class="s2">&quot;drW&quot;</span><span class="p">,</span>
            <span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># x0 = F.relu(self.linearIn(x))</span>
        <span class="c1"># outLSTM, (hn, cn) = self.lstm(x0, do_drop_mc=do_drop_mc)</span>
        <span class="c1"># out = self.linearOut(outLSTM)</span>
        <span class="c1"># return out</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">yt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reset_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xt</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xt</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">xt</span><span class="p">))</span>
            <span class="n">ht</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">ct</span><span class="p">),</span> <span class="n">do_reset_mask</span><span class="o">=</span><span class="n">reset_mask</span><span class="p">)</span>
            <span class="n">yt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>
            <span class="n">reset_mask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">out</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">yt</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CpuLstmModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CpuLstmModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># x0 = F.relu(self.linearIn(x))</span>
    <span class="c1"># outLSTM, (hn, cn) = self.lstm(x0, do_drop_mc=do_drop_mc)</span>
    <span class="c1"># out = self.linearOut(outLSTM)</span>
    <span class="c1"># return out</span>
    <span class="n">nt</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">reset_mask</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xt</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xt</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">xt</span><span class="p">))</span>
        <span class="n">ht</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">ct</span><span class="p">),</span> <span class="n">do_reset_mask</span><span class="o">=</span><span class="n">reset_mask</span><span class="p">)</span>
        <span class="n">yt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>
        <span class="n">reset_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">out</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">yt</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CudnnLstm" class="doc doc-heading">
        <code>
CudnnLstm            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CudnnLstm" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>LSTM with dropout implemented by Kuai Fang: https://github.com/mhpi/hydroDL/blob/release/hydroDL/model/rnn.py</p>
<p>Only run in GPU; the CPU version is LstmCellTied in this file</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CudnnLstm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LSTM with dropout implemented by Kuai Fang: https://github.com/mhpi/hydroDL/blob/release/hydroDL/model/rnn.py</span>

<span class="sd">    Only run in GPU; the CPU version is LstmCellTied in this file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_size</span>
<span class="sd">            number of neurons in input layer</span>
<span class="sd">        hidden_size</span>
<span class="sd">            number of neurons in hidden layer</span>
<span class="sd">        dr</span>
<span class="sd">            dropout rate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;w_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;w_hh&quot;</span><span class="p">,</span> <span class="s2">&quot;b_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;b_hh&quot;</span><span class="p">]]</span>
        <span class="c1"># self.cuda()</span>
        <span class="c1"># set the mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">()</span>
        <span class="c1"># initialize the weights and bias of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;just use the default _apply function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fn : function</span>
<span class="sd">            _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># _apply is always recursively applied to all submodules and the module itself such as move all to GPU</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;a python magic function to set the state of the object used for deserialization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># set a default value for _data_ptrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;_data_ptrs&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="s2">&quot;all_weights&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;all_weights&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;w_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;w_hh&quot;</span><span class="p">,</span> <span class="s2">&quot;b_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;b_hh&quot;</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;generate mask for dropout&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;initialize the weights and bias of the model using Xavier initialization&quot;&quot;&quot;</span>
        <span class="n">stdv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="c1"># uniform distribution between -stdv and stdv for the weights and bias initialization</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># dropout_false: it will ensure do_drop is false, unless do_drop_mc is true</span>
        <span class="k">if</span> <span class="n">dropout_false</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_drop_mc</span><span class="p">):</span>
            <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_drop_mc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># if train mode and set self.dr &gt; 0, then do_drop is true</span>
            <span class="c1"># so each time the model forward function is called, the dropout is applied</span>
            <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># input must be a tensor with shape (seq_len, batch, input_size)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hx</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># handle = torch.backends.cudnn.get_handle()</span>
        <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># cuDNN backend - disabled flat weight</span>
            <span class="c1"># NOTE: each time the mask is newly generated, so for each batch the mask is different</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">()</span>
            <span class="c1"># apply the mask to the weights</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&lt;</span> <span class="s2">&quot;1.8&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">reserve</span><span class="p">,</span> <span class="n">new_weight_buf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_cudnn_rnn</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">,</span>
                <span class="n">weight</span><span class="p">,</span>
                <span class="mi">4</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">hx</span><span class="p">,</span>
                <span class="n">cx</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 2 means LSTM</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="p">(),</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">reserve</span><span class="p">,</span> <span class="n">new_weight_buf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_cudnn_rnn</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">,</span>
                <span class="n">weight</span><span class="p">,</span>
                <span class="mi">4</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">hx</span><span class="p">,</span>
                <span class="n">cx</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 2 means LSTM</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="p">(),</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return all weights and bias of the model as a list&quot;&quot;&quot;</span>
        <span class="c1"># getattr() is used to get the value of an object&#39;s attribute</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span>
        <span class="p">]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.all_weights" class="doc doc-heading">
<code class="highlight language-python"><span class="n">all_weights</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstm.all_weights" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>return all weights and bias of the model as a list</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.cudnnlstm.CudnnLstm.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.cudnnlstm.CudnnLstm.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>input_size
    number of neurons in input layer
hidden_size
    number of neurons in hidden layer
dr
    dropout rate</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_size</span>
<span class="sd">        number of neurons in input layer</span>
<span class="sd">    hidden_size</span>
<span class="sd">        number of neurons in hidden layer</span>
<span class="sd">    dr</span>
<span class="sd">        dropout rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;w_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;w_hh&quot;</span><span class="p">,</span> <span class="s2">&quot;b_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;b_hh&quot;</span><span class="p">]]</span>
    <span class="c1"># self.cuda()</span>
    <span class="c1"># set the mask</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">()</span>
    <span class="c1"># initialize the weights and bias of the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.__setstate__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>a python magic function to set the state of the object used for deserialization</p>
<h6 id="torchhydro.models.cudnnlstm.CudnnLstm.__setstate__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.cudnnlstm.CudnnLstm.__setstate__--parameters" title="Permanent link">&para;</a></h6>
<p>d : <em>type</em>
    <em>description</em></p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a python magic function to set the state of the object used for deserialization</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c1"># set a default value for _data_ptrs</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;_data_ptrs&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="s2">&quot;all_weights&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;all_weights&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_all_weights</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;w_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;w_hh&quot;</span><span class="p">,</span> <span class="s2">&quot;b_ih&quot;</span><span class="p">,</span> <span class="s2">&quot;b_hh&quot;</span><span class="p">]]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstm.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># dropout_false: it will ensure do_drop is false, unless do_drop_mc is true</span>
    <span class="k">if</span> <span class="n">dropout_false</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_drop_mc</span><span class="p">):</span>
        <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_drop_mc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
        <span class="c1"># if train mode and set self.dr &gt; 0, then do_drop is true</span>
        <span class="c1"># so each time the model forward function is called, the dropout is applied</span>
        <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_drop</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># input must be a tensor with shape (seq_len, batch, input_size)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># handle = torch.backends.cudnn.get_handle()</span>
    <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># cuDNN backend - disabled flat weight</span>
        <span class="c1"># NOTE: each time the mask is newly generated, so for each batch the mask is different</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">()</span>
        <span class="c1"># apply the mask to the weights</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&lt;</span> <span class="s2">&quot;1.8&quot;</span><span class="p">:</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">reserve</span><span class="p">,</span> <span class="n">new_weight_buf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_cudnn_rnn</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">,</span>
            <span class="n">weight</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">hx</span><span class="p">,</span>
            <span class="n">cx</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 2 means LSTM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">reserve</span><span class="p">,</span> <span class="n">new_weight_buf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_cudnn_rnn</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">,</span>
            <span class="n">weight</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">hx</span><span class="p">,</span>
            <span class="n">cx</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 2 means LSTM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">hy</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.reset_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reset_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_mask" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>generate mask for dropout</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;generate mask for dropout&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstm.reset_parameters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstm.reset_parameters" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>initialize the weights and bias of the model using Xavier initialization</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;initialize the weights and bias of the model using Xavier initialization&quot;&quot;&quot;</span>
    <span class="n">stdv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="c1"># uniform distribution between -stdv and stdv for the weights and bias initialization</span>
        <span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CudnnLstmModel" class="doc doc-heading">
        <code>
CudnnLstmModel            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CudnnLstmModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CudnnLstmModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An LSTM model writen by Kuai Fang from this paper: https://doi.org/10.1002/2017GL075619</span>

<span class="sd">        only gpu version</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features</span>
<span class="sd">        dr</span>
<span class="sd">            dropout rate and its default is 0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">n_input_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">n_output_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">n_hidden_states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nLayer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
        <span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">))</span> <span class="k">if</span> <span class="n">return_h_c</span> <span class="k">else</span> <span class="n">out</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>An LSTM model writen by Kuai Fang from this paper: https://doi.org/10.1002/2017GL075619</p>
<p>only gpu version</p>
<h6 id="torchhydro.models.cudnnlstm.CudnnLstmModel.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.cudnnlstm.CudnnLstmModel.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features
n_output_features
    the number of output features
n_hidden_states
    the number of hidden features
dr
    dropout rate and its default is 0.5</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An LSTM model writen by Kuai Fang from this paper: https://doi.org/10.1002/2017GL075619</span>

<span class="sd">    only gpu version</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features</span>
<span class="sd">    dr</span>
<span class="sd">        dropout rate and its default is 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">n_input_features</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">n_output_features</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">n_hidden_states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nLayer</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
        <span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstmModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">))</span> <span class="k">if</span> <span class="n">return_h_c</span> <span class="k">else</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel" class="doc doc-heading">
        <code>
CudnnLstmModelLstmKernel            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>use a trained/un-trained CudnnLstm as a kernel generator before another CudnnLstm.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CudnnLstmModelLstmKernel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;use a trained/un-trained CudnnLstm as a kernel generator before another CudnnLstm.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_size_later</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">delta_s</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;delta_s means we will use the difference of the first lstm&#39;s output and the second&#39;s as the final output&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModelLstmKernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># These three layers are same with CudnnLstmModel to be used for transfer learning or just vanilla-use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="c1"># if cut is True, we will only select the final index in nk, and repeat it, then concatenate with x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span>
        <span class="c1"># the second lstm has more input than the previous</span>
        <span class="k">if</span> <span class="n">nk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="n">ny</span>
        <span class="k">if</span> <span class="n">hidden_size_later</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hidden_size_later</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_in_later</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="n">nk</span><span class="p">,</span> <span class="n">hidden_size_later</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_later</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_out_later</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta_s</span> <span class="o">=</span> <span class="n">delta_s</span>
        <span class="c1"># when delta_s is true, cut cannot be true, because they have to have same number params</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cut</span> <span class="ow">and</span> <span class="n">delta_s</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_lstm1</span><span class="p">,</span> <span class="p">(</span><span class="n">hn1</span><span class="p">,</span> <span class="n">cn1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
        <span class="p">)</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">gen</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_in_later</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
        <span class="n">out_lstm2</span><span class="p">,</span> <span class="p">(</span><span class="n">hn2</span><span class="p">,</span> <span class="n">cn2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_later</span><span class="p">(</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
        <span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_out_later</span><span class="p">(</span><span class="n">out_lstm2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gen</span> <span class="o">-</span> <span class="n">out</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_s</span> <span class="k">else</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_size_later</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">delta_s</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>delta_s means we will use the difference of the first lstm's output and the second's as the final output</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">,</span>
    <span class="n">nk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_size_later</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">delta_s</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;delta_s means we will use the difference of the first lstm&#39;s output and the second&#39;s as the final output&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModelLstmKernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="c1"># These three layers are same with CudnnLstmModel to be used for transfer learning or just vanilla-use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
    <span class="c1"># if cut is True, we will only select the final index in nk, and repeat it, then concatenate with x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span>
    <span class="c1"># the second lstm has more input than the previous</span>
    <span class="k">if</span> <span class="n">nk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">ny</span>
    <span class="k">if</span> <span class="n">hidden_size_later</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hidden_size_later</span> <span class="o">=</span> <span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_in_later</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="n">nk</span><span class="p">,</span> <span class="n">hidden_size_later</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm_later</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
        <span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_out_later</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size_later</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">delta_s</span> <span class="o">=</span> <span class="n">delta_s</span>
    <span class="c1"># when delta_s is true, cut cannot be true, because they have to have same number params</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cut</span> <span class="ow">and</span> <span class="n">delta_s</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelLstmKernel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">out_lstm1</span><span class="p">,</span> <span class="p">(</span><span class="n">hn1</span><span class="p">,</span> <span class="n">cn1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
    <span class="p">)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">gen</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_in_later</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
    <span class="n">out_lstm2</span><span class="p">,</span> <span class="p">(</span><span class="n">hn2</span><span class="p">,</span> <span class="n">cn2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_later</span><span class="p">(</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_out_later</span><span class="p">(</span><span class="n">out_lstm2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen</span> <span class="o">-</span> <span class="n">out</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_s</span> <span class="k">else</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput" class="doc doc-heading">
        <code>
CudnnLstmModelMultiOutput            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CudnnLstmModelMultiOutput</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">,</span>
        <span class="n">layer_hidden_size</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
        <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">dr_hidden</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiple output CudnnLSTM.</span>

<span class="sd">        It has multiple output layers, each for one output, so that we can easily freeze any output layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the size of input features</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the size of output features; in this model, we set different nonlinear layer for each output</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the size of LSTM&#39;s hidden features</span>
<span class="sd">        layer_hidden_size</span>
<span class="sd">            hidden_size for multi-layers</span>
<span class="sd">        dr</span>
<span class="sd">            dropout rate</span>
<span class="sd">        dr_hidden</span>
<span class="sd">            dropout rates of hidden layers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModelMultiOutput</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">multi_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_output_features</span><span class="p">):</span>
            <span class="n">multi_layers</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s2">&quot;layer</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">layer_hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr_hidden</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_layers</span> <span class="o">=</span> <span class="n">multi_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
        <span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_layers</span><span class="p">]</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">))</span> <span class="k">if</span> <span class="n">return_h_c</span> <span class="k">else</span> <span class="n">final</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">layer_hidden_size</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dr_hidden</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Multiple output CudnnLSTM.</p>
<p>It has multiple output layers, each for one output, so that we can easily freeze any output layer.</p>
<h6 id="torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the size of input features
n_output_features
    the size of output features; in this model, we set different nonlinear layer for each output
n_hidden_states
    the size of LSTM's hidden features
layer_hidden_size
    hidden_size for multi-layers
dr
    dropout rate
dr_hidden
    dropout rates of hidden layers</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">,</span>
    <span class="n">layer_hidden_size</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
    <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">dr_hidden</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiple output CudnnLSTM.</span>

<span class="sd">    It has multiple output layers, each for one output, so that we can easily freeze any output layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the size of input features</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the size of output features; in this model, we set different nonlinear layer for each output</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the size of LSTM&#39;s hidden features</span>
<span class="sd">    layer_hidden_size</span>
<span class="sd">        hidden_size for multi-layers</span>
<span class="sd">    dr</span>
<span class="sd">        dropout rate</span>
<span class="sd">    dr_hidden</span>
<span class="sd">        dropout rates of hidden layers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CudnnLstmModelMultiOutput</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">multi_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_output_features</span><span class="p">):</span>
        <span class="n">multi_layers</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
            <span class="s2">&quot;layer</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">layer_hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr_hidden</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">multi_layers</span> <span class="o">=</span> <span class="n">multi_layers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">CudnnLstm</span><span class="p">(</span>
        <span class="n">input_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">dr</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.CudnnLstmModelMultiOutput.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_h_c</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
    <span class="p">)</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_layers</span><span class="p">]</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">))</span> <span class="k">if</span> <span class="n">return_h_c</span> <span class="k">else</span> <span class="n">final</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.LinearCudnnLstmModel" class="doc doc-heading">
        <code>
LinearCudnnLstmModel            (<a class="autorefs autorefs-internal" title="
CudnnLstmModel            (Module)
         (torchhydro.models.cudnnlstm.CudnnLstmModel)" href="#torchhydro.models.cudnnlstm.CudnnLstmModel">CudnnLstmModel</a>)
        </code>



<a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This model is nonlinear layer + CudnnLSTM/CudnnLstm-MultiOutput-Model.
kai_tl: model from this paper by Ma et al. -- https://doi.org/10.1029/2020WR028600</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LinearCudnnLstmModel</span><span class="p">(</span><span class="n">CudnnLstmModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This model is nonlinear layer + CudnnLSTM/CudnnLstm-MultiOutput-Model.</span>
<span class="sd">    kai_tl: model from this paper by Ma et al. -- https://doi.org/10.1029/2020WR028600</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        linear_size</span>
<span class="sd">            the number of input features for the first input linear layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinearCudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;n_input_features&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearCudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
        <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>linear_size
    the number of input features for the first input linear layer</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    linear_size</span>
<span class="sd">        the number of input features for the first input linear layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">LinearCudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;n_input_features&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.LinearCudnnLstmModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.LinearCudnnLstmModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearCudnnLstmModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="n">do_drop_mc</span><span class="p">,</span> <span class="n">dropout_false</span><span class="o">=</span><span class="n">dropout_false</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.cudnnlstm.LstmCellTied" class="doc doc-heading">
        <code>
LstmCellTied            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.cudnnlstm.LstmCellTied" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>LSTM with dropout implemented by Kuai Fang: https://github.com/mhpi/hydroDL/blob/release/hydroDL/model/rnn.py</p>
<p>the name of "Tied" comes from this paper:
http://papers.nips.cc/paper/6241-a-theoretically-grounded-application-of-dropout-in-recurrent-neural-networks.pdf
which means the weights of all gates will be tied together to be used (eq. 6 in this paper).
this code is mainly used as a CPU version of CudnnLstm</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LstmCellTied</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LSTM with dropout implemented by Kuai Fang: https://github.com/mhpi/hydroDL/blob/release/hydroDL/model/rnn.py</span>

<span class="sd">    the name of &quot;Tied&quot; comes from this paper:</span>
<span class="sd">    http://papers.nips.cc/paper/6241-a-theoretically-grounded-application-of-dropout-in-recurrent-neural-networks.pdf</span>
<span class="sd">    which means the weights of all gates will be tied together to be used (eq. 6 in this paper).</span>
<span class="sd">    this code is mainly used as a CPU version of CudnnLstm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">input_size</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
        <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">dr_method</span><span class="o">=</span><span class="s2">&quot;drX+drW+drC&quot;</span><span class="p">,</span>
        <span class="n">gpu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LstmCellTied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputSize</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span> <span class="o">=</span> <span class="n">dr_method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="n">gpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;drMC&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stdv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_x</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_h</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_c</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">do_reset_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">do_drop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_drop_mc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">h0</span><span class="p">,</span> <span class="n">c0</span> <span class="o">=</span> <span class="n">hidden</span>
        <span class="k">if</span> <span class="n">h0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">do_reset_mask</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">c0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drH&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
            <span class="n">h0</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_h</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drX&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drW&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
            <span class="n">w_ih</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">w_hh</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.w are parameters, while w are not</span>
            <span class="n">w_ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span>
            <span class="n">w_hh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span>

        <span class="n">gates</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">)</span>
        <span class="n">gate_i</span><span class="p">,</span> <span class="n">gate_f</span><span class="p">,</span> <span class="n">gate_c</span><span class="p">,</span> <span class="n">gate_o</span> <span class="o">=</span> <span class="n">gates</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gate_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_i</span><span class="p">)</span>
        <span class="n">gate_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_f</span><span class="p">)</span>
        <span class="n">gate_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">gate_c</span><span class="p">)</span>
        <span class="n">gate_o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_o</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s2">&quot;drC&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
            <span class="n">gate_c</span> <span class="o">=</span> <span class="n">gate_c</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_c</span><span class="p">)</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">gate_f</span> <span class="o">*</span> <span class="n">c0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gate_i</span> <span class="o">*</span> <span class="n">gate_c</span><span class="p">)</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">gate_o</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.cudnnlstm.LstmCellTied.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">do_reset_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.cudnnlstm.LstmCellTied.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/cudnnlstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">do_reset_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_drop_mc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">do_drop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_drop_mc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">h0</span><span class="p">,</span> <span class="n">c0</span> <span class="o">=</span> <span class="n">hidden</span>
    <span class="k">if</span> <span class="n">h0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">do_reset_mask</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">c0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drH&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_h</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drX&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_drop</span> <span class="ow">and</span> <span class="s2">&quot;drW&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
        <span class="n">w_ih</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_ih</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">w_hh</span> <span class="o">=</span> <span class="n">DropMask</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_w_hh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># self.w are parameters, while w are not</span>
        <span class="n">w_ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ih</span>
        <span class="n">w_hh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hh</span>

    <span class="n">gates</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w_ih</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_ih</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_hh</span><span class="p">)</span>
    <span class="n">gate_i</span><span class="p">,</span> <span class="n">gate_f</span><span class="p">,</span> <span class="n">gate_c</span><span class="p">,</span> <span class="n">gate_o</span> <span class="o">=</span> <span class="n">gates</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gate_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_i</span><span class="p">)</span>
    <span class="n">gate_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_f</span><span class="p">)</span>
    <span class="n">gate_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">gate_c</span><span class="p">)</span>
    <span class="n">gate_o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gate_o</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s2">&quot;drC&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drMethod</span><span class="p">:</span>
        <span class="n">gate_c</span> <span class="o">=</span> <span class="n">gate_c</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_c</span><span class="p">)</span>

    <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">gate_f</span> <span class="o">*</span> <span class="n">c0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gate_i</span> <span class="o">*</span> <span class="n">gate_c</span><span class="p">)</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">gate_o</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>









  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.dpl4gr4j" class="doc doc-heading">
        <code>dpl4gr4j</code>



<a href="#torchhydro.models.dpl4gr4j" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Simulates streamflow over time using the model logic from GR4J as implemented in PyTorch.
This function can be used to offer up the functionality of GR4J with added gradient information.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4gr4j.DplAnnGr4j" class="doc doc-heading">
        <code>
DplAnnGr4j            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplAnnGr4j</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of ANN</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnGr4j</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">        Parameters will be denormalized in gr4j model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model only with attributes as DL model's input: ANN -&gt; Param -&gt; Gr4j</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of ANN
n_output_features
    the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of ANN; it could be Union[int, tuple, list]
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of ANN</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnGr4j</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.DplAnnGr4j.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q
Parameters will be denormalized in gr4j model</p>
<h6 id="torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a 2-dim tensor. [batch, feature]</p>
<h6 id="torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplAnnGr4j.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">    Parameters will be denormalized in gr4j model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4gr4j.DplLstmGr4j" class="doc doc-heading">
        <code>
DplLstmGr4j            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplLstmGr4j</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model: LSTM -&gt; Param -&gt; Gr4j</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of LSTM</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of LSTM</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmGr4j</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">        Parameters will be denormalized in gr4j model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model: LSTM -&gt; Param -&gt; Gr4j</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of LSTM
n_output_features
    the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of LSTM
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model: LSTM -&gt; Param -&gt; Gr4j</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of LSTM</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of LSTM</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmGr4j</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.DplLstmGr4j.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q
Parameters will be denormalized in gr4j model</p>
<h6 id="torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</p>
<h6 id="torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4gr4j.DplLstmGr4j.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">    Parameters will be denormalized in gr4j model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4gr4j.Gr4j4Dpl" class="doc doc-heading">
        <code>
Gr4j4Dpl            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>the nn.Module style GR4J model</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Gr4j4Dpl</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the nn.Module style GR4J model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        warmup_length</span>
<span class="sd">            length of warmup period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Gr4j4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X1&quot;</span><span class="p">,</span> <span class="s2">&quot;X2&quot;</span><span class="p">,</span> <span class="s2">&quot;X3&quot;</span><span class="p">,</span> <span class="s2">&quot;X4&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">1200.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">gr4j_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
        <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># set no_grad for warmup periods</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">cal_init</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cal_init</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">r0</span> <span class="o">=</span> <span class="n">cal_init</span><span class="p">(</span><span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x1</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x3</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">streamflow_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">prs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pr</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">production</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">x1</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pr</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">production</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">x1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">prs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="n">prs_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">conv_q9</span><span class="p">,</span> <span class="n">conv_q1</span> <span class="o">=</span> <span class="n">uh_gr4j</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
        <span class="n">q9</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">q9</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span>
                <span class="n">prs_x</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">conv_q9</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">q1</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span>
                <span class="n">prs_x</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">conv_q1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">streamflow_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q</span>
        <span class="n">streamflow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">streamflow_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">streamflow</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_state</span> <span class="k">else</span> <span class="n">streamflow</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>warmup_length
    length of warmup period</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    warmup_length</span>
<span class="sd">        length of warmup period</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Gr4j4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X1&quot;</span><span class="p">,</span> <span class="s2">&quot;X2&quot;</span><span class="p">,</span> <span class="s2">&quot;X3&quot;</span><span class="p">,</span> <span class="s2">&quot;X4&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">1200.0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4gr4j.Gr4j4Dpl.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.Gr4j4Dpl.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">gr4j_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x4_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
    <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># set no_grad for warmup periods</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">cal_init</span> <span class="o">=</span> <span class="n">Gr4j4Dpl</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cal_init</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">r0</span> <span class="o">=</span> <span class="n">cal_init</span><span class="p">(</span><span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x1</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x3</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">streamflow_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
    <span class="n">prs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pr</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">production</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">x1</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pr</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">production</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">x1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">prs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pr</span>
    <span class="n">prs_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">conv_q9</span><span class="p">,</span> <span class="n">conv_q1</span> <span class="o">=</span> <span class="n">uh_gr4j</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
    <span class="n">q9</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">q9</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span>
            <span class="n">prs_x</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">conv_q9</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">q1</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span>
            <span class="n">prs_x</span><span class="p">[:,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">conv_q1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">streamflow_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">streamflow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">streamflow_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">streamflow</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_state</span> <span class="k">else</span> <span class="n">streamflow</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.calculate_evap_store" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_evap_store</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">evap_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.calculate_evap_store" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Calculates the amount of evaporation out of the storage reservoir.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_evap_store</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">evap_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the amount of evaporation out of the storage reservoir.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">evap_net</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">evap_net</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">/</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.calculate_perc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_perc</span><span class="p">(</span><span class="n">current_store</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.calculate_perc" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Calculates the percolation from the storage reservoir into streamflow.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_perc</span><span class="p">(</span><span class="n">current_store</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the percolation from the storage reservoir into streamflow.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">current_store</span> <span class="o">*</span> <span class="p">(</span>
        <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="mf">9.0</span> <span class="o">*</span> <span class="n">current_store</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.25</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.calculate_precip_store" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_precip_store</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">precip_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.calculate_precip_store" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Calculates the amount of rainfall which enters the storage reservoir.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_precip_store</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">precip_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the amount of rainfall which enters the storage reservoir.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">precip_net</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">precip_net</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">/</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.production" class="doc doc-heading">
<code class="highlight language-python"><span class="n">production</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">s_level</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.production" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>an one-step calculation for production store in GR4J
the dimension of the cell: [batch, feature]</p>
<h5 id="torchhydro.models.dpl4gr4j.production--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.production--parameters" title="Permanent link">&para;</a></h5>
<p>p_and_e
    P is pe[:, 0] and E is pe[:, 1]; similar with the "input" in the RNNCell
!!! x1
    Storage reservoir parameter;
s_level
    s_level means S in the GR4J Model; similar with the "hx" in the RNNCell
    Initial value of storage in the storage reservoir.</p>
<h5 id="torchhydro.models.dpl4gr4j.production--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4gr4j.production--returns" title="Permanent link">&para;</a></h5>
<p>tuple
    contains the Pr and updated S</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">production</span><span class="p">(</span>
    <span class="n">p_and_e</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">s_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    an one-step calculation for production store in GR4J</span>
<span class="sd">    the dimension of the cell: [batch, feature]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        P is pe[:, 0] and E is pe[:, 1]; similar with the &quot;input&quot; in the RNNCell</span>
<span class="sd">    x1:</span>
<span class="sd">        Storage reservoir parameter;</span>
<span class="sd">    s_level</span>
<span class="sd">        s_level means S in the GR4J Model; similar with the &quot;hx&quot; in the RNNCell</span>
<span class="sd">        Initial value of storage in the storage reservoir.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        contains the Pr and updated S</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gr4j_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
    <span class="c1"># Calculate net precipitation and evapotranspiration</span>
    <span class="n">precip_difference</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">precip_net</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">precip_difference</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">))</span>
    <span class="n">evap_net</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">precip_difference</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">s_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s_level</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="c1"># s_level should not be larger than x1</span>
    <span class="n">s_level</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s_level</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">s_level</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">),</span> <span class="n">x1</span><span class="p">)</span>

    <span class="c1"># Calculate the fraction of net precipitation that is stored</span>
    <span class="n">precip_store</span> <span class="o">=</span> <span class="n">calculate_precip_store</span><span class="p">(</span><span class="n">s_level</span><span class="p">,</span> <span class="n">precip_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>

    <span class="c1"># Calculate the amount of evaporation from storage</span>
    <span class="n">evap_store</span> <span class="o">=</span> <span class="n">calculate_evap_store</span><span class="p">(</span><span class="n">s_level</span><span class="p">,</span> <span class="n">evap_net</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>

    <span class="c1"># Update the storage by adding effective precipitation and</span>
    <span class="c1"># removing evaporation</span>
    <span class="n">s_update</span> <span class="o">=</span> <span class="n">s_level</span> <span class="o">-</span> <span class="n">evap_store</span> <span class="o">+</span> <span class="n">precip_store</span>
    <span class="c1"># s_level should not be larger than self.x1</span>
    <span class="n">s_update</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
        <span class="n">s_update</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">s_update</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">),</span> <span class="n">x1</span>
    <span class="p">)</span>

    <span class="c1"># Update the storage again to reflect percolation out of the store</span>
    <span class="n">perc</span> <span class="o">=</span> <span class="n">calculate_perc</span><span class="p">(</span><span class="n">s_update</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">s_update</span> <span class="o">=</span> <span class="n">s_update</span> <span class="o">-</span> <span class="n">perc</span>
    <span class="c1"># perc is always lower than S because of the calculation itself, so we don&#39;t need clamp here anymore.</span>

    <span class="c1"># The precip. for routing is the sum of the rainfall which</span>
    <span class="c1"># did not make it to storage and the percolation from the store</span>
    <span class="n">current_runoff</span> <span class="o">=</span> <span class="n">perc</span> <span class="o">+</span> <span class="p">(</span><span class="n">precip_net</span> <span class="o">-</span> <span class="n">precip_store</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_runoff</span><span class="p">,</span> <span class="n">s_update</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.routing" class="doc doc-heading">
<code class="highlight language-python"><span class="n">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r_level</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.routing" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>the GR4J routing-module unit cell for time-sequence loop</p>
<h5 id="torchhydro.models.dpl4gr4j.routing--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.routing--parameters" title="Permanent link">&para;</a></h5>
<p>q9</p>
<p>q1</p>
<p>x2
    Catchment water exchange parameter
x3
    Routing reservoir parameters
r_level
    Beginning value of storage in the routing reservoir.</p>
<h5 id="torchhydro.models.dpl4gr4j.routing--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4gr4j.routing--returns" title="Permanent link">&para;</a></h5>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">routing</span><span class="p">(</span><span class="n">q9</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">q1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">r_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the GR4J routing-module unit cell for time-sequence loop</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q9</span>

<span class="sd">    q1</span>

<span class="sd">    x2</span>
<span class="sd">        Catchment water exchange parameter</span>
<span class="sd">    x3</span>
<span class="sd">        Routing reservoir parameters</span>
<span class="sd">    r_level</span>
<span class="sd">        Beginning value of storage in the routing reservoir.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gr4j_device</span> <span class="o">=</span> <span class="n">q9</span><span class="o">.</span><span class="n">device</span>
    <span class="k">if</span> <span class="n">r_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r_level</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="c1"># r_level should not be larger than self.x3</span>
    <span class="n">r_level</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">r_level</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r_level</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">),</span> <span class="n">x3</span><span class="p">)</span>
    <span class="n">groundwater_ex</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_level</span> <span class="o">/</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">3.5</span>
    <span class="n">r_updated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r_level</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">),</span> <span class="n">r_level</span> <span class="o">+</span> <span class="n">q9</span> <span class="o">+</span> <span class="n">groundwater_ex</span>
    <span class="p">)</span>

    <span class="n">qr</span> <span class="o">=</span> <span class="n">r_updated</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">r_updated</span> <span class="o">/</span> <span class="n">x3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">r_updated</span> <span class="o">=</span> <span class="n">r_updated</span> <span class="o">-</span> <span class="n">qr</span>

    <span class="n">qd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">groundwater_ex</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">),</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">groundwater_ex</span>
    <span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qd</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">r_updated</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4gr4j.uh_gr4j" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uh_gr4j</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4gr4j.uh_gr4j" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Generate the convolution kernel for the convolution operation in routing module of GR4J</p>
<h5 id="torchhydro.models.dpl4gr4j.uh_gr4j--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4gr4j.uh_gr4j--parameters" title="Permanent link">&para;</a></h5>
<p>x4
    the dim of x4 is [batch]</p>
<h5 id="torchhydro.models.dpl4gr4j.uh_gr4j--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4gr4j.uh_gr4j--returns" title="Permanent link">&para;</a></h5>
<p>list
    UH1s and UH2s for all basins</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4gr4j.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">uh_gr4j</span><span class="p">(</span><span class="n">x4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the convolution kernel for the convolution operation in routing module of GR4J</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x4</span>
<span class="sd">        the dim of x4 is [batch]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        UH1s and UH2s for all basins</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gr4j_device</span> <span class="o">=</span> <span class="n">x4</span><span class="o">.</span><span class="n">device</span>
    <span class="n">uh1_ordinates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">uh2_ordinates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x4</span><span class="p">)):</span>
        <span class="c1"># for SH1, the pieces are: 0, 0&lt;t&lt;x4, t&gt;=x4</span>
        <span class="n">uh1_ordinates_t1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mf">0.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">uh1_ordinates_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mf">1.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="c1"># for SH2, the pieces are: 0, 0&lt;t&lt;=x4, x4&lt;t&lt;2x4, t&gt;=2x4</span>
        <span class="n">uh2_ords_t1_seq_x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mf">0.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">uh2_ords_t1_larger_x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">uh2_ords_t_seq_x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mf">1.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">uh2_ords_t_larger_x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gr4j_device</span><span class="p">)</span>
        <span class="n">s_curve1t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">uh1_ordinates_t1</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.5</span>
        <span class="n">s_curve21t1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">uh2_ords_t1_seq_x4</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.5</span>
        <span class="n">s_curve22t1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">uh2_ords_t1_larger_x4</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.5</span>
        <span class="n">s_curve2t1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">s_curve21t1</span><span class="p">,</span> <span class="n">s_curve22t1</span><span class="p">])</span>
        <span class="c1"># t1 cannot be larger than x4, but t can, so we should set (uh1_ordinates_t / x4[i]) &lt;=1</span>
        <span class="c1"># we don&#39;t use torch.clamp, because it seems we have to use mask, or we will get nan for grad. More details</span>
        <span class="c1"># could be seen here: https://github.com/waterDLut/hydro-dl-basic/tree/dev/3-more-knowledge/5-grad-problem.ipynb</span>
        <span class="n">uh1_x4</span> <span class="o">=</span> <span class="n">uh1_ordinates_t</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">limit_uh1_x4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">uh1_x4</span><span class="p">)</span>
        <span class="n">limit_uh2_smaller_x4</span> <span class="o">=</span> <span class="n">uh2_ords_t_seq_x4</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">uh2_larger_x4</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">uh2_ords_t_larger_x4</span> <span class="o">/</span> <span class="n">x4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">limit_uh2_larger_x4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">uh2_larger_x4</span><span class="p">)</span>
        <span class="n">s_curve1t</span> <span class="o">=</span> <span class="n">limit_uh1_x4</span><span class="o">**</span><span class="mf">2.5</span>
        <span class="n">s_curve21t</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">limit_uh2_smaller_x4</span><span class="o">**</span><span class="mf">2.5</span>
        <span class="n">s_curve22t</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">limit_uh2_larger_x4</span><span class="o">**</span><span class="mf">2.5</span>
        <span class="n">s_curve2t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">s_curve21t</span><span class="p">,</span> <span class="n">s_curve22t</span><span class="p">])</span>
        <span class="n">uh1_ordinate</span> <span class="o">=</span> <span class="n">s_curve1t</span> <span class="o">-</span> <span class="n">s_curve1t1</span>
        <span class="n">uh2_ordinate</span> <span class="o">=</span> <span class="n">s_curve2t</span> <span class="o">-</span> <span class="n">s_curve2t1</span>
        <span class="n">uh1_ordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uh1_ordinate</span><span class="p">)</span>
        <span class="n">uh2_ordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uh2_ordinate</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">uh1_ordinates</span><span class="p">,</span> <span class="n">uh2_ordinates</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.dpl4hbv" class="doc doc-heading">
        <code>dpl4hbv</code>



<a href="#torchhydro.models.dpl4hbv" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4hbv.DplAnnHbv" class="doc doc-heading">
        <code>
DplAnnHbv            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4hbv.DplAnnHbv" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplAnnHbv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of ANN</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">        kernel_size</span>
<span class="sd">            size for unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnHbv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">        Parameters will be denormalized in gr4j model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.DplAnnHbv.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model only with attributes as DL model's input: ANN -&gt; Param -&gt; Gr4j</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4hbv.DplAnnHbv.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplAnnHbv.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of ANN
n_output_features
    the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of ANN; it could be Union[int, tuple, list]
kernel_size
    size for unit hydrograph
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of ANN</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">    kernel_size</span>
<span class="sd">        size for unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnHbv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.DplAnnHbv.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q
Parameters will be denormalized in gr4j model</p>
<h6 id="torchhydro.models.dpl4hbv.DplAnnHbv.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a 2-dim tensor. [batch, feature]</p>
<h6 id="torchhydro.models.dpl4hbv.DplAnnHbv.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplAnnHbv.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">    Parameters will be denormalized in gr4j model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4hbv.DplLstmHbv" class="doc doc-heading">
        <code>
DplLstmHbv            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4hbv.DplLstmHbv" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplLstmHbv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of LSTM</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of LSTM</span>
<span class="sd">        kernel_size</span>
<span class="sd">            size for unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the time length of warmup period</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmHbv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">        Parameters will be denormalized in xaj model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.DplLstmHbv.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4hbv.DplLstmHbv.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplLstmHbv.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of LSTM
n_output_features
    the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of LSTM
kernel_size
    size for unit hydrograph
warmup_length
    the time length of warmup period
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of LSTM</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of LSTM</span>
<span class="sd">    kernel_size</span>
<span class="sd">        size for unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the time length of warmup period</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmHbv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.DplLstmHbv.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q
Parameters will be denormalized in xaj model</p>
<h6 id="torchhydro.models.dpl4hbv.DplLstmHbv.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</p>
<h6 id="torchhydro.models.dpl4hbv.DplLstmHbv.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4hbv.DplLstmHbv.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">    Parameters will be denormalized in xaj model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4hbv.Hbv4Dpl" class="doc doc-heading">
        <code>
Hbv4Dpl            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4hbv.Hbv4Dpl" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>HBV Model Pytorch version</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Hbv4Dpl</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HBV Model Pytorch version&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate a HBV instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        warmup_length : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        kernel_size : int, optional</span>
<span class="sd">            conv kernel for unit hydrograph, by default 15</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Hbv4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;HBV&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;hbv&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
        <span class="n">parasca_lst</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;hbv&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;BETA&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K0&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K1&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K2&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;LP&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;PERC&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;UZL&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;TT&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CFMAX&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CFR&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CWH&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
        <span class="c1"># there are 3 input vars in HBV: P, PET and TEMPERATURE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">out_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rout_opt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the HBV-light hydrological model (Seibert, 2005).</span>

<span class="sd">        The code comes from mhpi/hydro-dev.</span>
<span class="sd">        NaN values have to be removed from the inputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            p_all = array with daily values of precipitation (mm/d)</span>
<span class="sd">            pet_all = array with daily values of potential evapotranspiration (mm/d)</span>
<span class="sd">            t_all = array with daily values of air temperature (deg C)</span>
<span class="sd">        parameters</span>
<span class="sd">            array with parameter values having the following structure and scales</span>
<span class="sd">            BETA: parameter in soil routine</span>
<span class="sd">            FC: maximum soil moisture content</span>
<span class="sd">            K0: recession coefficient</span>
<span class="sd">            K1: recession coefficient</span>
<span class="sd">            K2: recession coefficient</span>
<span class="sd">            LP: limit for potential evapotranspiration</span>
<span class="sd">            PERC: percolation from upper to lower response box</span>
<span class="sd">            UZL: upper zone limit</span>
<span class="sd">            TT: temperature limit for snow/rain; distinguish rainfall from snowfall</span>
<span class="sd">            CFMAX: degree day factor; used for melting calculation</span>
<span class="sd">            CFR: refreezing factor</span>
<span class="sd">            CWH: liquid water holding capacity of the snowpack</span>
<span class="sd">            A: parameter of mizuRoute</span>
<span class="sd">            THETA: parameter of mizuRoute</span>
<span class="sd">        out_state</span>
<span class="sd">            if True, the state variables&#39; value will be output</span>
<span class="sd">        rout_opt</span>
<span class="sd">            if True, route module will be performed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[tuple, torch.Tensor]</span>
<span class="sd">            q_sim = daily values of simulated streamflow (mm)</span>
<span class="sd">            sm = soil storage (mm)</span>
<span class="sd">            suz = upper zone storage (mm)</span>
<span class="sd">            slz = lower zone storage (mm)</span>
<span class="sd">            snowpack = snow depth (mm)</span>
<span class="sd">            et_act = actual evaporation (mm)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hbv_device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="n">buffer_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
        <span class="c1"># Initialization</span>
        <span class="k">if</span> <span class="n">buffer_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">x_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">buffer_time</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">warmup_length</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">init_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">init_model</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Please set warmup_length as 0 when initializing HBV model&quot;</span>
                    <span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">suz</span><span class="p">,</span> <span class="n">slz</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span>
                    <span class="n">x_init</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">out_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rout_opt</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Without buff time, initialize state variables with zeros</span>
            <span class="n">n_grid</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">snowpack</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
            <span class="n">meltwater</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="n">hbv_device</span>
            <span class="p">)</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
            <span class="n">suz</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
            <span class="n">slz</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>

        <span class="c1"># the sequence must be p, pet and t</span>
        <span class="n">p_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">pet_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">t_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># scale the parameters</span>
        <span class="n">par_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># parCET = parameters[:,1]</span>
        <span class="n">par_fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_k2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># parMAXBAS = parameters[:,7]</span>
        <span class="n">par_perc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_uzl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># parPCORR = parameters[:,10]</span>
        <span class="n">par_tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_cfmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># parSFCF = parameters[:,13]</span>
        <span class="n">par_cfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">par_cwh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">n_step</span><span class="p">,</span> <span class="n">n_grid</span> <span class="o">=</span> <span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="c1"># Apply correction factor to precipitation</span>
        <span class="c1"># p_all = parPCORR.repeat(n_step, 1) * p_all</span>

        <span class="c1"># Initialize time series of model variables</span>
        <span class="n">q_sim</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
        <span class="c1"># # Debug for the state variables</span>
        <span class="c1"># SMlog = np.zeros(p_all.size())</span>
        <span class="n">log_sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">log_ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">log_swet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">log_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_step</span><span class="p">):</span>
            <span class="c1"># Separate precipitation into liquid and solid components</span>
            <span class="n">precip</span> <span class="o">=</span> <span class="n">p_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">tempre</span> <span class="o">=</span> <span class="n">t_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">potent</span> <span class="o">=</span> <span class="n">pet_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">rain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">&gt;=</span> <span class="n">par_tt</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="n">snow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">&lt;</span> <span class="n">par_tt</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            <span class="c1"># snow = snow * parSFCF</span>

            <span class="c1"># Snow</span>
            <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">+</span> <span class="n">snow</span>
            <span class="n">melt</span> <span class="o">=</span> <span class="n">par_cfmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">-</span> <span class="n">par_tt</span><span class="p">)</span>
            <span class="c1"># melt[melt &lt; 0.0] = 0.0</span>
            <span class="n">melt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">melt</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="c1"># melt[melt &gt; snowpack] = snowpack[melt &gt; snowpack]</span>
            <span class="n">melt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">melt</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">)</span>
            <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">+</span> <span class="n">melt</span>
            <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">-</span> <span class="n">melt</span>
            <span class="n">refreezing</span> <span class="o">=</span> <span class="n">par_cfr</span> <span class="o">*</span> <span class="n">par_cfmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">par_tt</span> <span class="o">-</span> <span class="n">tempre</span><span class="p">)</span>
            <span class="c1"># refreezing[refreezing &lt; 0.0] = 0.0</span>
            <span class="c1"># refreezing[refreezing &gt; meltwater] = meltwater[refreezing &gt; meltwater]</span>
            <span class="n">refreezing</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">refreezing</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">refreezing</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">refreezing</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">)</span>
            <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">+</span> <span class="n">refreezing</span>
            <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="n">refreezing</span>
            <span class="n">to_soil</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="p">(</span><span class="n">par_cwh</span> <span class="o">*</span> <span class="n">snowpack</span><span class="p">)</span>
            <span class="c1"># to_soil[to_soil &lt; 0.0] = 0.0</span>
            <span class="n">to_soil</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">to_soil</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="n">to_soil</span>

            <span class="c1"># Soil and evaporation</span>
            <span class="n">soil_wetness</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="n">par_fc</span><span class="p">)</span> <span class="o">**</span> <span class="n">par_beta</span>
            <span class="c1"># soil_wetness[soil_wetness &lt; 0.0] = 0.0</span>
            <span class="c1"># soil_wetness[soil_wetness &gt; 1.0] = 1.0</span>
            <span class="n">soil_wetness</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">soil_wetness</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">recharge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span><span class="p">)</span> <span class="o">*</span> <span class="n">soil_wetness</span>

            <span class="c1"># log for displaying</span>
            <span class="n">log_sm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">log_ps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">log_swet</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="n">par_fc</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">log_re</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">recharge</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span> <span class="o">-</span> <span class="n">recharge</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">-</span> <span class="n">par_fc</span>
            <span class="c1"># excess[excess &lt; 0.0] = 0.0</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">excess</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">-</span> <span class="n">excess</span>
            <span class="n">evap_factor</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="n">par_lp</span> <span class="o">*</span> <span class="n">par_fc</span><span class="p">)</span>
            <span class="c1"># evap_factor[evap_factor &lt; 0.0] = 0.0</span>
            <span class="c1"># evap_factor[evap_factor &gt; 1.0] = 1.0</span>
            <span class="n">evap_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">evap_factor</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">et_act</span> <span class="o">=</span> <span class="n">potent</span> <span class="o">*</span> <span class="n">evap_factor</span>
            <span class="n">et_act</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">et_act</span><span class="p">)</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
                <span class="n">sm</span> <span class="o">-</span> <span class="n">et_act</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">precision</span>
            <span class="p">)</span>  <span class="c1"># sm can not be zero for gradient tracking</span>

            <span class="c1"># Groundwater boxes</span>
            <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">+</span> <span class="n">recharge</span> <span class="o">+</span> <span class="n">excess</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">suz</span><span class="p">,</span> <span class="n">par_perc</span><span class="p">)</span>
            <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">perc</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">par_k0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">suz</span> <span class="o">-</span> <span class="n">par_uzl</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">q0</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="n">par_k1</span> <span class="o">*</span> <span class="n">suz</span>
            <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">q1</span>
            <span class="n">slz</span> <span class="o">=</span> <span class="n">slz</span> <span class="o">+</span> <span class="n">perc</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="n">par_k2</span> <span class="o">*</span> <span class="n">slz</span>
            <span class="n">slz</span> <span class="o">=</span> <span class="n">slz</span> <span class="o">-</span> <span class="n">q2</span>
            <span class="n">q_sim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">+</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span>

            <span class="c1"># # for debug state variables</span>
            <span class="c1"># SMlog[t,:] = sm.detach().cpu().numpy()</span>

        <span class="k">if</span> <span class="n">rout_opt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># routing</span>
            <span class="n">temp_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">temp_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">rout_a</span> <span class="o">=</span> <span class="n">temp_a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rout_b</span> <span class="o">=</span> <span class="n">temp_b</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">uh_from_gamma</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">rout_a</span><span class="p">,</span> <span class="n">rout_b</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">uh_from_gamma</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># add a dimension</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">suz</span><span class="p">,</span> <span class="n">slz</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">qs</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.Hbv4Dpl.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Initiate a HBV instance</p>
<h6 id="torchhydro.models.dpl4hbv.Hbv4Dpl.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.Hbv4Dpl.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>warmup_length : <em>type</em>
    <em>description</em>
kernel_size : int, optional
    conv kernel for unit hydrograph, by default 15</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initiate a HBV instance</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    warmup_length : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    kernel_size : int, optional</span>
<span class="sd">        conv kernel for unit hydrograph, by default 15</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Hbv4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;HBV&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;hbv&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
    <span class="n">parasca_lst</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;hbv&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;BETA&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K0&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K1&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;K2&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;LP&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;PERC&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;UZL&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;TT&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CFMAX&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CFR&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;CWH&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">parasca_lst</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
    <span class="c1"># there are 3 input vars in HBV: P, PET and TEMPERATURE</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4hbv.Hbv4Dpl.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">out_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rout_opt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Runs the HBV-light hydrological model (Seibert, 2005).</p>
<p>The code comes from mhpi/hydro-dev.
NaN values have to be removed from the inputs.</p>
<h6 id="torchhydro.models.dpl4hbv.Hbv4Dpl.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    p_all = array with daily values of precipitation (mm/d)
    pet_all = array with daily values of potential evapotranspiration (mm/d)
    t_all = array with daily values of air temperature (deg C)
parameters
    array with parameter values having the following structure and scales
    BETA: parameter in soil routine
    FC: maximum soil moisture content
    K0: recession coefficient
    K1: recession coefficient
    K2: recession coefficient
    LP: limit for potential evapotranspiration
    PERC: percolation from upper to lower response box
    UZL: upper zone limit
    TT: temperature limit for snow/rain; distinguish rainfall from snowfall
    CFMAX: degree day factor; used for melting calculation
    CFR: refreezing factor
    CWH: liquid water holding capacity of the snowpack
    A: parameter of mizuRoute
    THETA: parameter of mizuRoute
out_state
    if True, the state variables' value will be output
rout_opt
    if True, route module will be performed</p>
<h6 id="torchhydro.models.dpl4hbv.Hbv4Dpl.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4hbv.Hbv4Dpl.forward--returns" title="Permanent link">&para;</a></h6>
<p>Union[tuple, torch.Tensor]
    q_sim = daily values of simulated streamflow (mm)
    sm = soil storage (mm)
    suz = upper zone storage (mm)
    slz = lower zone storage (mm)
    snowpack = snow depth (mm)
    et_act = actual evaporation (mm)</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4hbv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">out_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rout_opt</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the HBV-light hydrological model (Seibert, 2005).</span>

<span class="sd">    The code comes from mhpi/hydro-dev.</span>
<span class="sd">    NaN values have to be removed from the inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        p_all = array with daily values of precipitation (mm/d)</span>
<span class="sd">        pet_all = array with daily values of potential evapotranspiration (mm/d)</span>
<span class="sd">        t_all = array with daily values of air temperature (deg C)</span>
<span class="sd">    parameters</span>
<span class="sd">        array with parameter values having the following structure and scales</span>
<span class="sd">        BETA: parameter in soil routine</span>
<span class="sd">        FC: maximum soil moisture content</span>
<span class="sd">        K0: recession coefficient</span>
<span class="sd">        K1: recession coefficient</span>
<span class="sd">        K2: recession coefficient</span>
<span class="sd">        LP: limit for potential evapotranspiration</span>
<span class="sd">        PERC: percolation from upper to lower response box</span>
<span class="sd">        UZL: upper zone limit</span>
<span class="sd">        TT: temperature limit for snow/rain; distinguish rainfall from snowfall</span>
<span class="sd">        CFMAX: degree day factor; used for melting calculation</span>
<span class="sd">        CFR: refreezing factor</span>
<span class="sd">        CWH: liquid water holding capacity of the snowpack</span>
<span class="sd">        A: parameter of mizuRoute</span>
<span class="sd">        THETA: parameter of mizuRoute</span>
<span class="sd">    out_state</span>
<span class="sd">        if True, the state variables&#39; value will be output</span>
<span class="sd">    rout_opt</span>
<span class="sd">        if True, route module will be performed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[tuple, torch.Tensor]</span>
<span class="sd">        q_sim = daily values of simulated streamflow (mm)</span>
<span class="sd">        sm = soil storage (mm)</span>
<span class="sd">        suz = upper zone storage (mm)</span>
<span class="sd">        slz = lower zone storage (mm)</span>
<span class="sd">        snowpack = snow depth (mm)</span>
<span class="sd">        et_act = actual evaporation (mm)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hbv_device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">buffer_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
    <span class="c1"># Initialization</span>
    <span class="k">if</span> <span class="n">buffer_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">x_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">buffer_time</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">warmup_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">init_model</span> <span class="o">=</span> <span class="n">Hbv4Dpl</span><span class="p">(</span><span class="n">warmup_length</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">init_model</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Please set warmup_length as 0 when initializing HBV model&quot;</span>
                <span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">suz</span><span class="p">,</span> <span class="n">slz</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span>
                <span class="n">x_init</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">out_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rout_opt</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Without buff time, initialize state variables with zeros</span>
        <span class="n">n_grid</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">snowpack</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
        <span class="n">meltwater</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">hbv_device</span>
        <span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
        <span class="n">suz</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
        <span class="n">slz</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>

    <span class="c1"># the sequence must be p, pet and t</span>
    <span class="n">p_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pet_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">t_all</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">buffer_time</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># scale the parameters</span>
    <span class="n">par_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># parCET = parameters[:,1]</span>
    <span class="n">par_fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_k2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># parMAXBAS = parameters[:,7]</span>
    <span class="n">par_perc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">perc_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_uzl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">uzl_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># parPCORR = parameters[:,10]</span>
    <span class="n">par_tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_cfmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfmax_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># parSFCF = parameters[:,13]</span>
    <span class="n">par_cfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfr_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">par_cwh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwh_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">n_step</span><span class="p">,</span> <span class="n">n_grid</span> <span class="o">=</span> <span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="c1"># Apply correction factor to precipitation</span>
    <span class="c1"># p_all = parPCORR.repeat(n_step, 1) * p_all</span>

    <span class="c1"># Initialize time series of model variables</span>
    <span class="n">q_sim</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hbv_device</span><span class="p">)</span>
    <span class="c1"># # Debug for the state variables</span>
    <span class="c1"># SMlog = np.zeros(p_all.size())</span>
    <span class="n">log_sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">log_ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">log_swet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">log_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p_all</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_step</span><span class="p">):</span>
        <span class="c1"># Separate precipitation into liquid and solid components</span>
        <span class="n">precip</span> <span class="o">=</span> <span class="n">p_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">tempre</span> <span class="o">=</span> <span class="n">t_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">potent</span> <span class="o">=</span> <span class="n">pet_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">rain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">&gt;=</span> <span class="n">par_tt</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">snow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">&lt;</span> <span class="n">par_tt</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="c1"># snow = snow * parSFCF</span>

        <span class="c1"># Snow</span>
        <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">+</span> <span class="n">snow</span>
        <span class="n">melt</span> <span class="o">=</span> <span class="n">par_cfmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">tempre</span> <span class="o">-</span> <span class="n">par_tt</span><span class="p">)</span>
        <span class="c1"># melt[melt &lt; 0.0] = 0.0</span>
        <span class="n">melt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">melt</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># melt[melt &gt; snowpack] = snowpack[melt &gt; snowpack]</span>
        <span class="n">melt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">melt</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">)</span>
        <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">+</span> <span class="n">melt</span>
        <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">-</span> <span class="n">melt</span>
        <span class="n">refreezing</span> <span class="o">=</span> <span class="n">par_cfr</span> <span class="o">*</span> <span class="n">par_cfmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">par_tt</span> <span class="o">-</span> <span class="n">tempre</span><span class="p">)</span>
        <span class="c1"># refreezing[refreezing &lt; 0.0] = 0.0</span>
        <span class="c1"># refreezing[refreezing &gt; meltwater] = meltwater[refreezing &gt; meltwater]</span>
        <span class="n">refreezing</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">refreezing</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">refreezing</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">refreezing</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">)</span>
        <span class="n">snowpack</span> <span class="o">=</span> <span class="n">snowpack</span> <span class="o">+</span> <span class="n">refreezing</span>
        <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="n">refreezing</span>
        <span class="n">to_soil</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="p">(</span><span class="n">par_cwh</span> <span class="o">*</span> <span class="n">snowpack</span><span class="p">)</span>
        <span class="c1"># to_soil[to_soil &lt; 0.0] = 0.0</span>
        <span class="n">to_soil</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">to_soil</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">meltwater</span> <span class="o">=</span> <span class="n">meltwater</span> <span class="o">-</span> <span class="n">to_soil</span>

        <span class="c1"># Soil and evaporation</span>
        <span class="n">soil_wetness</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="n">par_fc</span><span class="p">)</span> <span class="o">**</span> <span class="n">par_beta</span>
        <span class="c1"># soil_wetness[soil_wetness &lt; 0.0] = 0.0</span>
        <span class="c1"># soil_wetness[soil_wetness &gt; 1.0] = 1.0</span>
        <span class="n">soil_wetness</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">soil_wetness</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">recharge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span><span class="p">)</span> <span class="o">*</span> <span class="n">soil_wetness</span>

        <span class="c1"># log for displaying</span>
        <span class="n">log_sm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">log_ps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">log_swet</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="n">par_fc</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">log_re</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">recharge</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">rain</span> <span class="o">+</span> <span class="n">to_soil</span> <span class="o">-</span> <span class="n">recharge</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">-</span> <span class="n">par_fc</span>
        <span class="c1"># excess[excess &lt; 0.0] = 0.0</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">excess</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">-</span> <span class="n">excess</span>
        <span class="n">evap_factor</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="n">par_lp</span> <span class="o">*</span> <span class="n">par_fc</span><span class="p">)</span>
        <span class="c1"># evap_factor[evap_factor &lt; 0.0] = 0.0</span>
        <span class="c1"># evap_factor[evap_factor &gt; 1.0] = 1.0</span>
        <span class="n">evap_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">evap_factor</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">et_act</span> <span class="o">=</span> <span class="n">potent</span> <span class="o">*</span> <span class="n">evap_factor</span>
        <span class="n">et_act</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">et_act</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
            <span class="n">sm</span> <span class="o">-</span> <span class="n">et_act</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">precision</span>
        <span class="p">)</span>  <span class="c1"># sm can not be zero for gradient tracking</span>

        <span class="c1"># Groundwater boxes</span>
        <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">+</span> <span class="n">recharge</span> <span class="o">+</span> <span class="n">excess</span>
        <span class="n">perc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">suz</span><span class="p">,</span> <span class="n">par_perc</span><span class="p">)</span>
        <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">perc</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="n">par_k0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">suz</span> <span class="o">-</span> <span class="n">par_uzl</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">q0</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">par_k1</span> <span class="o">*</span> <span class="n">suz</span>
        <span class="n">suz</span> <span class="o">=</span> <span class="n">suz</span> <span class="o">-</span> <span class="n">q1</span>
        <span class="n">slz</span> <span class="o">=</span> <span class="n">slz</span> <span class="o">+</span> <span class="n">perc</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">par_k2</span> <span class="o">*</span> <span class="n">slz</span>
        <span class="n">slz</span> <span class="o">=</span> <span class="n">slz</span> <span class="o">-</span> <span class="n">q2</span>
        <span class="n">q_sim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">+</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span>

        <span class="c1"># # for debug state variables</span>
        <span class="c1"># SMlog[t,:] = sm.detach().cpu().numpy()</span>

    <span class="k">if</span> <span class="n">rout_opt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># routing</span>
        <span class="n">temp_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">temp_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">rout_a</span> <span class="o">=</span> <span class="n">temp_a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rout_b</span> <span class="o">=</span> <span class="n">temp_b</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">uh_from_gamma</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">rout_a</span><span class="p">,</span> <span class="n">rout_b</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">uh_from_gamma</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># add a dimension</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">snowpack</span><span class="p">,</span> <span class="n">meltwater</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">suz</span><span class="p">,</span> <span class="n">slz</span><span class="p">)</span> <span class="k">if</span> <span class="n">out_state</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">qs</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.dpl4xaj" class="doc doc-heading">
        <code>dpl4xaj</code>



<a href="#torchhydro.models.dpl4xaj" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2023-09-19 09:36:25
LastEditTime: 2025-06-25 15:50:57
LastEditors: Wenyu Ouyang
Description: The method comes from this paper: https://doi.org/10.1038/s41467-021-26107-z It use Deep Learning (DL) methods to Learn the Parameters of physics-based models (PBM), which is called "differentiable parameter learning" (dPL).
FilePath:       orchhydro       orchhydro\models\dpl4xaj.py
Copyright (c) 2023-2024 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj.DplAnnXaj" class="doc doc-heading">
        <code>
DplAnnXaj            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj.DplAnnXaj" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplAnnXaj</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
        <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of ANN</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the time length of unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        return_et</span>
<span class="sd">            if True, return evapotranspiration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span>
            <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
            <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">        Parameters will be denormalized in gr4j model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.DplAnnXaj.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model only with attributes as DL model's input: ANN -&gt; Param -&gt; Gr4j</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4xaj.DplAnnXaj.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplAnnXaj.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of ANN
n_output_features
    the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of ANN; it could be Union[int, tuple, list]
kernel_size
    the time length of unit hydrograph
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used
return_et
    if True, return evapotranspiration</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model only with attributes as DL model&#39;s input: ANN -&gt; Param -&gt; Gr4j</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of ANN</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of ANN, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of ANN; it could be Union[int, tuple, list]</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the time length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    return_et</span>
<span class="sd">        if True, return evapotranspiration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplAnnXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span>
        <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dr</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
        <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.DplAnnXaj.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q
Parameters will be denormalized in gr4j model</p>
<h6 id="torchhydro.models.dpl4xaj.DplAnnXaj.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a 2-dim tensor. [batch, feature]</p>
<h6 id="torchhydro.models.dpl4xaj.DplAnnXaj.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplAnnXaj.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; ANN -&gt; param -&gt; + x (not normalized) -&gt; gr4j -&gt; q</span>
<span class="sd">    Parameters will be denormalized in gr4j model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">ann_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj.DplLstmXaj" class="doc doc-heading">
        <code>
DplLstmXaj            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj.DplLstmXaj" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplLstmXaj</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
        <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of LSTM</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of LSTM</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the time length of unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        return_et</span>
<span class="sd">            if True, return evapotranspiration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
            <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">        Parameters will be denormalized in xaj model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.DplLstmXaj.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4xaj.DplLstmXaj.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplLstmXaj.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of LSTM
n_output_features
    the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of LSTM
kernel_size
    the time length of unit hydrograph
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used
return_et
    if True, return evapotranspiration</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of LSTM</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of LSTM</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the time length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">    return_et</span>
<span class="sd">        if True, return evapotranspiration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
        <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.DplLstmXaj.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q
Parameters will be denormalized in xaj model</p>
<h6 id="torchhydro.models.dpl4xaj.DplLstmXaj.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</p>
<h6 id="torchhydro.models.dpl4xaj.DplLstmXaj.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.DplLstmXaj.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">    Parameters will be denormalized in xaj model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">lstm_pbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj.Xaj4Dpl" class="doc doc-heading">
        <code>
Xaj4Dpl            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj.Xaj4Dpl" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>XAJ model for Differential Parameter learning</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Xaj4Dpl</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    XAJ model for Differential Parameter learning</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the time length of unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            XAJ needs a warmup period to generate reasonable initial state values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Xaj4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
        <span class="n">param_range</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;IM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;UM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;LM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;DM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;SM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;EX&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KG&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CG&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
        <span class="c1"># there are 2 input variables in XAJ: P and PET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span> <span class="o">=</span> <span class="n">source_book</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">=</span> <span class="n">source_type</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run XAJ model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p_and_e</span>
<span class="sd">            precipitation and potential evapotranspiration</span>
<span class="sd">        parameters</span>
<span class="sd">            parameters of XAJ model</span>
<span class="sd">        return_state</span>
<span class="sd">            if True, return state values, mainly for warmup periods</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            streamflow got by XAJ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
        <span class="c1"># denormalize the parameters to general range</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">um</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ki_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">kg_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># ki+kg should be smaller than 1; if not, we scale them, but note float only contain 4 digits, so we need 0.999</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">ki_</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki_</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">kg_</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># initialize state values</span>
        <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
        <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># set no_grad for warmup periods</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">cal_init_xaj4dpl</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">cal_init_xaj4dpl</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">cal_init_xaj4dpl</span><span class="p">(</span>
                    <span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">()),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">()))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">qi0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">qg0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rss_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">ris_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rgs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">es_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">xaj_generation</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">xaj_generation</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
            <span class="c1"># impevious part is pe * im</span>
            <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
            <span class="c1"># so for non-imprvious part, the result should be corrected</span>
            <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">es_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="c1"># rss_[i, :] = 0.7 * r</span>
            <span class="c1"># ris_[i, :] = 0.2 * r</span>
            <span class="c1"># rgs_[i, :] = 0.1 * r</span>
        <span class="c1"># seq, batch, feature</span>
        <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">es_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">KernelConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">qs_</span> <span class="o">=</span> <span class="n">conv_uh</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
        <span class="c1"># seq, batch, feature</span>
        <span class="n">q_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span>
        <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.Xaj4Dpl.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.dpl4xaj.Xaj4Dpl.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.Xaj4Dpl.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>kernel_size
    the time length of unit hydrograph
warmup_length
    the length of warmup periods;
    XAJ needs a warmup period to generate reasonable initial state values</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the time length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        XAJ needs a warmup period to generate reasonable initial state values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Xaj4Dpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
    <span class="n">param_range</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;IM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;UM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;LM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;DM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;SM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;EX&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KG&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CI&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CG&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
    <span class="c1"># there are 2 input variables in XAJ: P and PET</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span> <span class="o">=</span> <span class="n">source_book</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">=</span> <span class="n">source_type</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj.Xaj4Dpl.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>run XAJ model</p>
<h6 id="torchhydro.models.dpl4xaj.Xaj4Dpl.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--parameters" title="Permanent link">&para;</a></h6>
<p>p_and_e
    precipitation and potential evapotranspiration
parameters
    parameters of XAJ model
return_state
    if True, return state values, mainly for warmup periods</p>
<h6 id="torchhydro.models.dpl4xaj.Xaj4Dpl.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.Xaj4Dpl.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    streamflow got by XAJ</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run XAJ model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        precipitation and potential evapotranspiration</span>
<span class="sd">    parameters</span>
<span class="sd">        parameters of XAJ model</span>
<span class="sd">    return_state</span>
<span class="sd">        if True, return state values, mainly for warmup periods</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        streamflow got by XAJ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
    <span class="c1"># denormalize the parameters to general range</span>
    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">um</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ki_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">kg_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># ki+kg should be smaller than 1; if not, we scale them, but note float only contain 4 digits, so we need 0.999</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">ki_</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki_</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">kg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">kg_</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># initialize state values</span>
    <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
    <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># set no_grad for warmup periods</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">cal_init_xaj4dpl</span> <span class="o">=</span> <span class="n">Xaj4Dpl</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">cal_init_xaj4dpl</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">cal_init_xaj4dpl</span><span class="p">(</span>
                <span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">()),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">()))</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">qi0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">qg0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rss_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">ris_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rgs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">es_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">xaj_generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">xaj_generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="c1"># impevious part is pe * im</span>
        <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
        <span class="c1"># so for non-imprvious part, the result should be corrected</span>
        <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">es_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="c1"># rss_[i, :] = 0.7 * r</span>
        <span class="c1"># ris_[i, :] = 0.2 * r</span>
        <span class="c1"># rgs_[i, :] = 0.1 * r</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">es_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">KernelConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
    <span class="n">qs_</span> <span class="o">=</span> <span class="n">conv_uh</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">)</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
        <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">q_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span>
    <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.ann_pbm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ann_pbm</span><span class="p">(</span><span class="n">dl_model</span><span class="p">,</span> <span class="n">pb_model</span><span class="p">,</span> <span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.ann_pbm" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; ann -&gt; param -&gt; + x (not normalized) -&gt; pbm -&gt; q
Parameters will be denormalized in pbm model</p>
<h5 id="torchhydro.models.dpl4xaj.ann_pbm--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.ann_pbm--parameters" title="Permanent link">&para;</a></h5>
<p>dl_model
    ann model
pb_model
    physics-based model
param_func
    function used to limit the range of params; now it is sigmoid or clamp function
x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a 2-dim tensor. [batch, feature]</p>
<h5 id="torchhydro.models.dpl4xaj.ann_pbm--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.ann_pbm--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ann_pbm</span><span class="p">(</span><span class="n">dl_model</span><span class="p">,</span> <span class="n">pb_model</span><span class="p">,</span> <span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; ann -&gt; param -&gt; + x (not normalized) -&gt; pbm -&gt; q</span>
<span class="sd">    Parameters will be denormalized in pbm model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dl_model</span>
<span class="sd">        ann model</span>
<span class="sd">    pb_model</span>
<span class="sd">        physics-based model</span>
<span class="sd">    param_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a 2-dim tensor. [batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">dl_model</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: NaN values detected. Check your data firstly!!!&quot;</span><span class="p">)</span>
    <span class="c1"># we set all params&#39; values in [0, 1] and will scale them when forwarding</span>
    <span class="k">if</span> <span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;clamp&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this way to limit parameters&#39; range!! Please choose sigmoid or clamp&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pb_model</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">pb_model</span><span class="o">.</span><span class="n">feature_size</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.calculate_evap" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.calculate_evap" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Three-layers evaporation model from "Watershed Hydrologic Simulation" written by Prof. RenJun Zhao.</p>
<p>The book is Chinese, and its real name is ;
The three-layers evaporation model is descibed in Page 76;
The method is same with that in Page 22-23 in "Hydrologic Forecasting (5-th version)" written by Prof. Weimin Bao.
This book's Chinese name is </p>
<h5 id="torchhydro.models.dpl4xaj.calculate_evap--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_evap--parameters" title="Permanent link">&para;</a></h5>
<p>lm
    average soil moisture storage capacity of lower layer (mm)
c
    coefficient of deep layer
wu0
    initial soil moisture of upper layer; update in each time step (mm)
wl0
    initial soil moisture of lower layer; update in each time step (mm)
prcp
    basin mean precipitation (mm/day)
pet
    potential evapotranspiration (mm/day)</p>
<h5 id="torchhydro.models.dpl4xaj.calculate_evap--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_evap--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    eu/el/ed are evaporation from upper/lower/deeper layer, respectively</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_evap</span><span class="p">(</span>
    <span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Three-layers evaporation model from &quot;Watershed Hydrologic Simulation&quot; written by Prof. RenJun Zhao.</span>

<span class="sd">    The book is Chinese, and its real name is ;</span>
<span class="sd">    The three-layers evaporation model is descibed in Page 76;</span>
<span class="sd">    The method is same with that in Page 22-23 in &quot;Hydrologic Forecasting (5-th version)&quot; written by Prof. Weimin Bao.</span>
<span class="sd">    This book&#39;s Chinese name is </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of lower layer (mm)</span>
<span class="sd">    c</span>
<span class="sd">        coefficient of deep layer</span>
<span class="sd">    wu0</span>
<span class="sd">        initial soil moisture of upper layer; update in each time step (mm)</span>
<span class="sd">    wl0</span>
<span class="sd">        initial soil moisture of lower layer; update in each time step (mm)</span>
<span class="sd">    prcp</span>
<span class="sd">        basin mean precipitation (mm/day)</span>
<span class="sd">    pet</span>
<span class="sd">        potential evapotranspiration (mm/day)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        eu/el/ed are evaporation from upper/lower/deeper layer, respectively</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tensor_min</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">wu0</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">prcp</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># when using torch.where, please see here: https://github.com/pytorch/pytorch/issues/9190</span>
    <span class="c1"># it&#39;s element-wise operation, no problem here. For example:</span>
    <span class="c1"># In: torch.where(torch.Tensor([2,1])&gt;torch.Tensor([1,1]),torch.Tensor([1,2]),torch.Tensor([3,4]))</span>
    <span class="c1"># Out: tensor([1., 4.])</span>
    <span class="n">eu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">tensor_min</span>
    <span class="p">)</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span>
        <span class="n">tensor_min</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">,</span>
            <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">*</span> <span class="n">wl0</span> <span class="o">/</span> <span class="n">lm</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">wl0</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.calculate_prcp_runoff" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Calculates the amount of runoff generated from rainfall after entering the underlying surface</p>
<p>Same in "Watershed Hydrologic Simulation" and "Hydrologic Forecasting (5-th version)"</p>
<h5 id="torchhydro.models.dpl4xaj.calculate_prcp_runoff--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--parameters" title="Permanent link">&para;</a></h5>
<p>b
    B exponent coefficient
im
    IMP imperiousness coefficient
wm
    average soil moisture storage capacity
w0
    initial soil moisture
pe
    net precipitation</p>
<h5 id="torchhydro.models.dpl4xaj.calculate_prcp_runoff--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_prcp_runoff--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    r -- runoff; r_im -- runoff of impervious part</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the amount of runoff generated from rainfall after entering the underlying surface</span>

<span class="sd">    Same in &quot;Watershed Hydrologic Simulation&quot; and &quot;Hydrologic Forecasting (5-th version)&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    b</span>
<span class="sd">        B exponent coefficient</span>
<span class="sd">    im</span>
<span class="sd">        IMP imperiousness coefficient</span>
<span class="sd">    wm</span>
<span class="sd">        average soil moisture storage capacity</span>
<span class="sd">    w0</span>
<span class="sd">        initial soil moisture</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        r -- runoff; r_im -- runoff of impervious part</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">wmm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w0</span> <span class="o">/</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error: NaN values detected. Try set clamp function or check your data!!!&quot;</span>
        <span class="p">)</span>
    <span class="n">r_cal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span> <span class="o">+</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">wmm</span><span class="p">,</span>
            <span class="c1"># torch.clamp is used for gradient not to be NaN, see more in xaj_sources function</span>
            <span class="n">pe</span> <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span> <span class="o">+</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">wmm</span><span class="p">)</span> <span class="o">/</span> <span class="n">wmm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span>
            <span class="n">pe</span> <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_cal</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error: NaN values detected. Try set clamp function or check your data!!!&quot;</span>
        <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">r_cal</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">r_im_cal</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="n">im</span>
    <span class="n">r_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">r_im_cal</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_im</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.calculate_w_storage" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.calculate_w_storage" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update the soil moisture values of the three layers.</p>
<p>According to the runoff-generation equation 2.60 in the book "SHUIWENYUBAO", dW = dPE - dR</p>
<h5 id="torchhydro.models.dpl4xaj.calculate_w_storage--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_w_storage--parameters" title="Permanent link">&para;</a></h5>
<p>um
    average soil moisture storage capacity of the upper layer (mm)
lm
    average soil moisture storage capacity of the lower layer (mm)
dm
    average soil moisture storage capacity of the deep layer (mm)
wu0
    initial values of soil moisture in upper layer
wl0
    initial values of soil moisture in lower layer
wd0
    initial values of soil moisture in deep layer
eu
    evaporation of the upper layer; it isn't used in this function
el
    evaporation of the lower layer
ed
    evaporation of the deep layer
pe
    net precipitation; it is able to be negative value in this function
r
    runoff</p>
<h5 id="torchhydro.models.dpl4xaj.calculate_w_storage--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.calculate_w_storage--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    wu,wl,wd -- soil moisture in upper, lower and deep layer</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the soil moisture values of the three layers.</span>

<span class="sd">    According to the runoff-generation equation 2.60 in the book &quot;SHUIWENYUBAO&quot;, dW = dPE - dR</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    um</span>
<span class="sd">        average soil moisture storage capacity of the upper layer (mm)</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of the lower layer (mm)</span>
<span class="sd">    dm</span>
<span class="sd">        average soil moisture storage capacity of the deep layer (mm)</span>
<span class="sd">    wu0</span>
<span class="sd">        initial values of soil moisture in upper layer</span>
<span class="sd">    wl0</span>
<span class="sd">        initial values of soil moisture in lower layer</span>
<span class="sd">    wd0</span>
<span class="sd">        initial values of soil moisture in deep layer</span>
<span class="sd">    eu</span>
<span class="sd">        evaporation of the upper layer; it isn&#39;t used in this function</span>
<span class="sd">    el</span>
<span class="sd">        evaporation of the lower layer</span>
<span class="sd">    ed</span>
<span class="sd">        evaporation of the deep layer</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation; it is able to be negative value in this function</span>
<span class="sd">    r</span>
<span class="sd">        runoff</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        wu,wl,wd -- soil moisture in upper, lower and deep layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">device</span>
    <span class="n">tensor_zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">wu0</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="c1"># pe&gt;0: the upper soil moisture was added firstly, then lower layer, and the final is deep layer</span>
    <span class="c1"># pe&lt;=0: no additional water, just remove evapotranspiration,</span>
    <span class="c1"># but note the case: e &gt;= p &gt; 0</span>
    <span class="c1"># (1) if wu0 + p &gt; e, then e = eu (2) else, wu must be zero</span>
    <span class="n">wu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">um</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">um</span><span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="n">tensor_zeros</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># calculate wd before wl because it is easier to cal using where statement</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">um</span> <span class="o">-</span> <span class="n">lm</span><span class="p">,</span> <span class="n">wd0</span>
        <span class="p">),</span>
        <span class="n">wd0</span> <span class="o">-</span> <span class="n">ed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># water balance (equation 2.2 in Page 13, also shown in Page 23)</span>
    <span class="c1"># if wu0 + p &gt; e, then e = eu; else p must be used in upper layer,</span>
    <span class="c1"># so no matter what the case is, el didn&#39;t include p, neither ed</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">wu</span> <span class="o">-</span> <span class="n">wd</span><span class="p">,</span> <span class="n">wl0</span> <span class="o">-</span> <span class="n">el</span><span class="p">)</span>
    <span class="c1"># the water storage should be in reasonable range</span>
    <span class="n">tensor_mins</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">wu_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">tensor_mins</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">um</span><span class="p">)</span>
    <span class="n">wl_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">tensor_mins</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span>
    <span class="n">wd_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">tensor_mins</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wu_</span><span class="p">,</span> <span class="n">wl_</span><span class="p">,</span> <span class="n">wd_</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.linear_reservoir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.linear_reservoir" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Linear reservoir's release function</p>
<h5 id="torchhydro.models.dpl4xaj.linear_reservoir--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.linear_reservoir--parameters" title="Permanent link">&para;</a></h5>
<p>x
    the input to the linear reservoir
weight
    the coefficient of linear reservoir
last_y
    the output of last period</p>
<h5 id="torchhydro.models.dpl4xaj.linear_reservoir--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.linear_reservoir--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    one-step forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear reservoir&#39;s release function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        the input to the linear reservoir</span>
<span class="sd">    weight</span>
<span class="sd">        the coefficient of linear reservoir</span>
<span class="sd">    last_y</span>
<span class="sd">        the output of last period</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one-step forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight</span>
    <span class="k">if</span> <span class="n">last_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">last_y</span> <span class="o">+</span> <span class="n">weight1</span> <span class="o">*</span> <span class="n">x</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.lstm_pbm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lstm_pbm</span><span class="p">(</span><span class="n">dl_model</span><span class="p">,</span> <span class="n">pb_model</span><span class="p">,</span> <span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.lstm_pbm" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; pbm -&gt; q
Parameters will be denormalized in pbm model</p>
<h5 id="torchhydro.models.dpl4xaj.lstm_pbm--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.lstm_pbm--parameters" title="Permanent link">&para;</a></h5>
<p>dl_model
    lstm model
pb_model
    physics-based model
param_func
    function used to limit the range of params; now it is sigmoid or clamp function
x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</p>
<h5 id="torchhydro.models.dpl4xaj.lstm_pbm--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.lstm_pbm--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
        one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lstm_pbm</span><span class="p">(</span><span class="n">dl_model</span><span class="p">,</span> <span class="n">pb_model</span><span class="p">,</span> <span class="n">param_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; pbm -&gt; q</span>
<span class="sd">    Parameters will be denormalized in pbm model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dl_model</span>
<span class="sd">        lstm model</span>
<span class="sd">    pb_model</span>
<span class="sd">        physics-based model</span>
<span class="sd">    param_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">dl_model</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: NaN values detected. Check your data firstly!!!&quot;</span><span class="p">)</span>
    <span class="c1"># we set all params&#39; values in [0, 1] and will scale them when forwarding</span>
    <span class="k">if</span> <span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
        <span class="n">params_</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;clamp&quot;</span><span class="p">:</span>
        <span class="n">params_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this way to limit parameters&#39; range!! Please choose sigmoid or clamp&quot;</span>
        <span class="p">)</span>
    <span class="c1"># just get one-period values, here we use the final period&#39;s values</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">pb_model</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">pb_model</span><span class="o">.</span><span class="n">feature_size</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.xaj_generation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">xaj_generation</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wd0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.xaj_generation" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Single-step runoff generation in XAJ.</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_generation--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_generation--parameters" title="Permanent link">&para;</a></h5>
<p>p_and_e
    precipitation and potential evapotranspiration (mm/day)
k
    ratio of potential evapotranspiration to reference crop evaporation
b
    exponent parameter
um
    average soil moisture storage capacity of the upper layer (mm)
lm
    average soil moisture storage capacity of the lower layer (mm)
dm
    average soil moisture storage capacity of the deep layer (mm)
im
    impermeability coefficient
c
    coefficient of deep layer
wu0
    initial values of soil moisture in upper layer (mm)
wl0
    initial values of soil moisture in lower layer (mm)
wd0
    initial values of soil moisture in deep layer (mm)</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_generation--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_generation--returns" title="Permanent link">&para;</a></h5>
<p>tuple[torch.Tensor]
    (r, rim, e, pe), (wu, wl, wd)</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xaj_generation</span><span class="p">(</span>
    <span class="n">p_and_e</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">k</span><span class="p">,</span>
    <span class="n">b</span><span class="p">,</span>
    <span class="n">im</span><span class="p">,</span>
    <span class="n">um</span><span class="p">,</span>
    <span class="n">lm</span><span class="p">,</span>
    <span class="n">dm</span><span class="p">,</span>
    <span class="n">c</span><span class="p">,</span>
    <span class="n">wu0</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">wl0</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">wd0</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single-step runoff generation in XAJ.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        precipitation and potential evapotranspiration (mm/day)</span>
<span class="sd">    k</span>
<span class="sd">        ratio of potential evapotranspiration to reference crop evaporation</span>
<span class="sd">    b</span>
<span class="sd">        exponent parameter</span>
<span class="sd">    um</span>
<span class="sd">        average soil moisture storage capacity of the upper layer (mm)</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of the lower layer (mm)</span>
<span class="sd">    dm</span>
<span class="sd">        average soil moisture storage capacity of the deep layer (mm)</span>
<span class="sd">    im</span>
<span class="sd">        impermeability coefficient</span>
<span class="sd">    c</span>
<span class="sd">        coefficient of deep layer</span>
<span class="sd">    wu0</span>
<span class="sd">        initial values of soil moisture in upper layer (mm)</span>
<span class="sd">    wl0</span>
<span class="sd">        initial values of soil moisture in lower layer (mm)</span>
<span class="sd">    wd0</span>
<span class="sd">        initial values of soil moisture in deep layer (mm)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[torch.Tensor]</span>
<span class="sd">        (r, rim, e, pe), (wu, wl, wd)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure physical variables&#39; value ranges are correct</span>
    <span class="n">prcp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">pet</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># wm</span>
    <span class="n">wm</span> <span class="o">=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">dm</span>
    <span class="k">if</span> <span class="n">wu0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
        <span class="n">wu0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">wl0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wl0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">wd0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wd0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="n">w0_</span> <span class="o">=</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span>
    <span class="c1"># w0 need locate in correct range so that following calculation could be right</span>
    <span class="c1"># To make sure the gradient is also not NaN (see case in xaj_sources),</span>
    <span class="c1"># we&#39;d better minus a precision (1e-5), although we&#39;ve not met this situation (grad is NaN)</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w0_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">wm</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="c1"># Calculate the amount of evaporation from storage</span>
    <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">+</span> <span class="n">el</span> <span class="o">+</span> <span class="n">ed</span>

    <span class="c1"># Calculate the runoff generated by net precipitation</span>
    <span class="n">prcp_difference</span> <span class="o">=</span> <span class="n">prcp</span> <span class="o">-</span> <span class="n">e</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">prcp_difference</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">rim</span> <span class="o">=</span> <span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
    <span class="c1"># Update wu, wl, wd;</span>
    <span class="c1"># we use prcp_difference rather than pe, as when pe&lt;0 but prcp&gt;0, prcp should be considered</span>
    <span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span> <span class="o">=</span> <span class="n">calculate_w_storage</span><span class="p">(</span>
        <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">prcp_difference</span><span class="p">,</span> <span class="n">r</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.xaj_sources" class="doc doc-heading">
<code class="highlight language-python"><span class="n">xaj_sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.xaj_sources" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Divide the runoff to different sources</p>
<p>We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:
"Analysis of parameters of the XinAnJiang model". Its Chinese name is &lt;&lt;&gt;&gt;,
which could be found by searching in "Baidu Xueshu".
The module's code can also be found in "Watershed Hydrologic Simulation" (WHS) Page 174.
It is nearly same with that in "Hydrologic Forecasting" (HF) Page 148-149
We use the period average runoff as input and the unit period is day so we don't need to difference it as books show</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_sources--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_sources--parameters" title="Permanent link">&para;</a></h5>
<p>pe
    net precipitation (mm/day)
r
    runoff from xaj_generation (mm/day)
sm
    areal mean free water capacity of the surface layer (mm)
ex
    exponent of the free water capacity curve
ki
    outflow coefficients of the free water storage to interflow relationships
kg
    outflow coefficients of the free water storage to groundwater relationships
s0
    initial free water capacity (mm)
fr0
    runoff area of last period</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_sources--return">Return<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_sources--return" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xaj_sources</span><span class="p">(</span>
    <span class="n">pe</span><span class="p">,</span>
    <span class="n">r</span><span class="p">,</span>
    <span class="n">sm</span><span class="p">,</span>
    <span class="n">ex</span><span class="p">,</span>
    <span class="n">ki</span><span class="p">,</span>
    <span class="n">kg</span><span class="p">,</span>
    <span class="n">s0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fr0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide the runoff to different sources</span>

<span class="sd">    We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:</span>
<span class="sd">    &quot;Analysis of parameters of the XinAnJiang model&quot;. Its Chinese name is &lt;&lt;&gt;&gt;,</span>
<span class="sd">    which could be found by searching in &quot;Baidu Xueshu&quot;.</span>
<span class="sd">    The module&#39;s code can also be found in &quot;Watershed Hydrologic Simulation&quot; (WHS) Page 174.</span>
<span class="sd">    It is nearly same with that in &quot;Hydrologic Forecasting&quot; (HF) Page 148-149</span>
<span class="sd">    We use the period average runoff as input and the unit period is day so we don&#39;t need to difference it as books show</span>


<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation (mm/day)</span>
<span class="sd">    r</span>
<span class="sd">        runoff from xaj_generation (mm/day)</span>
<span class="sd">    sm</span>
<span class="sd">        areal mean free water capacity of the surface layer (mm)</span>
<span class="sd">    ex</span>
<span class="sd">        exponent of the free water capacity curve</span>
<span class="sd">    ki</span>
<span class="sd">        outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">    kg</span>
<span class="sd">        outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">    s0</span>
<span class="sd">        initial free water capacity (mm)</span>
<span class="sd">    fr0</span>
<span class="sd">        runoff area of last period</span>

<span class="sd">    Return</span>
<span class="sd">    ------------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">device</span>
    <span class="c1"># maximum free water storage capacity in a basin</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="c1"># For free water storage, because s is related to fr and s0 and fr0 are both values of last period,</span>
    <span class="c1"># we have to trans the initial value of s from last period to this one.</span>
    <span class="c1"># both WHS&#39;s sample code and HF use s = fr0 * s0 / fr.</span>
    <span class="c1"># I think they both think free water reservoir as a cubic tank. Its height is s and area of bottom rectangle is fr</span>
    <span class="c1"># we will have a cubic tank with varying bottom and height,</span>
    <span class="c1"># and fixed boundary (in HF sm is fixed) or none-fixed boundary (in EH smmf is not fixed)</span>
    <span class="c1"># but notice r&#39;s list like&quot; [1,0] which 1 is the 1st period&#39;s runoff and 0 is the 2nd period&#39;s runoff</span>
    <span class="c1"># after 1st period, the s1 could not be zero, but in the 2nd period, fr=0, then we cannot set s=0, because some water still in the tank</span>
    <span class="c1"># fr&#39;s formula could be found in Eq. 9 in &quot;Analysis of parameters of the XinAnJiang model&quot;,</span>
    <span class="c1"># Here our r doesn&#39;t include rim, so there is no need to remove rim from r; this is also the method in HF</span>
    <span class="c1"># Moreover, to make sure ss is not larger than sm, otherwise au will be nan value.</span>
    <span class="c1"># It is worth to note that we have to use a precision here -- 1e-5, otherwise the gradient will be NaN;</span>
    <span class="c1"># I guess maybe when calculating gradient -- y/x,  brings some precision problem when we need exponent function.</span>

    <span class="c1"># NOTE: when r is 0, fr should be 0, however, s1 may not be zero and it still hold some water,</span>
    <span class="c1"># then fr can not be 0, otherwise when fr is used as denominator it lead to error,</span>
    <span class="c1"># so we have to deal with this case later, for example, when r=0, we cannot use pe * fr to replace r</span>
    <span class="c1"># because fr get the value of last period, and it is not 0</span>

    <span class="c1"># cannot use torch.where, because it will cause some error when calculating gradient</span>
    <span class="c1"># fr = torch.where(r &gt; 0.0, r / pe, fr0)</span>
    <span class="c1"># fr just use fr0, and it can be included in the computation graph, so we don&#39;t detach it</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>
    <span class="n">fr_mask</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fr</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error: NaN values detected. Try set clamp function or check your data!!!&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fr</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
            <span class="s2">&quot;Please check fr&#39;s value, fr==0.0 will cause error in the next step!&quot;</span>
        <span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>

    <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr0</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">s0</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">sm</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Error: NaN values detected. Try set clamp function or check your data!!!&quot;</span>
            <span class="p">)</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="c1"># equation 2-85 in HF</span>
            <span class="c1"># it&#39;s weird here, but we have to clamp so that the gradient could be not NaN;</span>
            <span class="c1"># otherwise, even the forward calculation is correct, the gradient is still NaN;</span>
            <span class="c1"># maybe when calculating gradient -- y/x,  brings some precision problem</span>
            <span class="c1"># if we need exponent function.</span>
            <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="mi">1</span>
                        <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="c1"># equation 2-86 in HF</span>
            <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># ri&#39;s mask is not same as rs&#39;s, because last period&#39;s s may not be 0</span>
        <span class="c1"># and in this time, ri and rg could be larger than 0</span>
        <span class="c1"># we need firstly calculate the updated s, s&#39;s mask is same as fr_mask,</span>
        <span class="c1"># when r==0, then s will be equal to last period&#39;s</span>
        <span class="c1"># equation 2-87 in HF, some free water leave or save, so we update free water storage</span>
        <span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;EH&quot;</span><span class="p">:</span>
        <span class="n">smmf</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ex</span><span class="p">))</span>
        <span class="n">smf</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">smf</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">/</span> <span class="n">smf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
                <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
            <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">(</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                        <span class="nb">max</span><span class="o">=</span><span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">/</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">**</span> <span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
        <span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">smf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please set book as &#39;HF&#39; or &#39;EH&#39;!&quot;</span><span class="p">)</span>
    <span class="c1"># equation 2-88 in HF, next interflow and ground water will be released from the updated free water storage</span>
    <span class="c1"># We use the period average runoff as input and the unit period is day.</span>
    <span class="c1"># Hence, we directly use ki and kg rather than ki_{t} in books.</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">kg</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="c1"># equation 2-89 in HF; although it looks different with that in WHS, they are actually same</span>
    <span class="c1"># Finally, calculate the final free water storage</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ki</span> <span class="o">-</span> <span class="n">kg</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj.xaj_sources5mm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">xaj_sources5mm</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">runoff</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj.xaj_sources5mm" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Divide the runoff to different sources according to books -- HF 5th edition and EH 3rd edition</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_sources5mm--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_sources5mm--parameters" title="Permanent link">&para;</a></h5>
<p>pe
    net precipitation
runoff
    runoff from xaj_generation
sm
    areal mean free water capacity of the surface layer
ex
    exponent of the free water capacity curve
ki
    outflow coefficients of the free water storage to interflow relationships
kg
    outflow coefficients of the free water storage to groundwater relationships
s0
    initial free water capacity
fr0
    initial area of generation
time_interval_hours
    KiKgCiCg24,
book
    the methods in HF 5th edition and EH 3rd edition are different,
    hence, both are provided, and the default is the former -- "ShuiWenYuBao";
    the other one is "GongChengShuiWenXue"</p>
<h5 id="torchhydro.models.dpl4xaj.xaj_sources5mm--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj.xaj_sources5mm--returns" title="Permanent link">&para;</a></h5>
<p>tuple[tuple, tuple]
    rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;
    (fr_ds[-1], s_ds[-1]): state variables' final value;
    all variables are numpy array</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xaj_sources5mm</span><span class="p">(</span>
    <span class="n">pe</span><span class="p">,</span>
    <span class="n">runoff</span><span class="p">,</span>
    <span class="n">sm</span><span class="p">,</span>
    <span class="n">ex</span><span class="p">,</span>
    <span class="n">ki</span><span class="p">,</span>
    <span class="n">kg</span><span class="p">,</span>
    <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide the runoff to different sources according to books -- HF 5th edition and EH 3rd edition</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation</span>
<span class="sd">    runoff</span>
<span class="sd">        runoff from xaj_generation</span>
<span class="sd">    sm</span>
<span class="sd">        areal mean free water capacity of the surface layer</span>
<span class="sd">    ex</span>
<span class="sd">        exponent of the free water capacity curve</span>
<span class="sd">    ki</span>
<span class="sd">        outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">    kg</span>
<span class="sd">        outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">    s0</span>
<span class="sd">        initial free water capacity</span>
<span class="sd">    fr0</span>
<span class="sd">        initial area of generation</span>
<span class="sd">    time_interval_hours</span>
<span class="sd">        KiKgCiCg24,</span>
<span class="sd">    book</span>
<span class="sd">        the methods in HF 5th edition and EH 3rd edition are different,</span>
<span class="sd">        hence, both are provided, and the default is the former -- &quot;ShuiWenYuBao&quot;;</span>
<span class="sd">        the other one is &quot;GongChengShuiWenXue&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tuple, tuple]</span>
<span class="sd">        rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;</span>
<span class="sd">        (fr_ds[-1], s_ds[-1]): state variables&#39; final value;</span>
<span class="sd">        all variables are numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">device</span>
    <span class="c1"># </span>
    <span class="n">smm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>
    <span class="n">fr_mask</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">runoff</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">runoff</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">runoff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">residue_temp</span> <span class="o">=</span> <span class="n">r_max</span> <span class="o">%</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">residue_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">residue_temp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_max</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">residue_temp</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">kss_d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span><span class="p">)</span>
    <span class="n">kg_d</span> <span class="o">=</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kss_d</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kg_d</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: NaN values detected. Check your parameters setting!!!&quot;</span><span class="p">)</span>
    <span class="c1"># kss_d = ki</span>
    <span class="c1"># kg_d = kg</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">runoff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">runoff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">runoff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>

    <span class="n">s_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fr_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">fr0_d</span> <span class="o">=</span> <span class="n">fr_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">s0_d</span> <span class="o">=</span> <span class="n">s_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># equation 5-32 in HF, but strange, cause each period, rn/pen is same</span>
        <span class="c1"># fr_d = torch.full_like(fr0_d, PRECISION, device=xaj_device)</span>
        <span class="c1"># fr_d_mask = fr &gt; PRECISION</span>
        <span class="c1"># fr_d[fr_d_mask] = 1 - (1 - fr[fr_d_mask]) ** (1 / n)</span>
        <span class="n">fr_d</span> <span class="o">=</span> <span class="n">fr</span>

        <span class="n">ss_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s0_d</span><span class="p">)</span>
        <span class="n">s_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s0_d</span><span class="p">)</span>

        <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr0_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">s0_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span>
            <span class="c1"># ms = smm</span>
            <span class="n">ss_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ss_d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">sm</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">smm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ss_d</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
                <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="c1"># equation 5-26 in HF</span>
                <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="mi">1</span>
                            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                            <span class="o">/</span> <span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="c1"># equation 5-27 in HF</span>
                <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rs_j</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">rn</span><span class="p">)</span>
            <span class="n">s_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s_d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;EH&quot;</span><span class="p">:</span>
            <span class="n">smmf</span> <span class="o">=</span> <span class="n">smm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr_d</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ex</span><span class="p">))</span>
            <span class="n">smf</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
            <span class="n">ss_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ss_d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">smf</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ss_d</span> <span class="o">/</span> <span class="n">smf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
                <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">rn</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="p">(</span>
                    <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span>
                        <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
                            <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                            <span class="nb">max</span><span class="o">=</span><span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="o">/</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rs_j</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">rn</span><span class="p">)</span>
            <span class="n">s_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">s_d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">smf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;We don&#39;t have this implementation! Please chose &#39;HF&#39; or &#39;EH&#39;!!&quot;</span>
            <span class="p">)</span>

        <span class="n">rss_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">fr_d</span>
        <span class="n">rg_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kg_d</span> <span class="o">*</span> <span class="n">fr_d</span>
        <span class="n">s1_d</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kss_d</span> <span class="o">-</span> <span class="n">kg_d</span><span class="p">)</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">rs_j</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">rss</span> <span class="o">+</span> <span class="n">rss_j</span>
        <span class="n">rg</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">+</span> <span class="n">rg_j</span>
        <span class="c1"># s_dfr_d</span>
        <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1_d</span><span class="p">)</span>
        <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr_d</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.dpl4xaj_nn4et" class="doc doc-heading">
        <code>dpl4xaj_nn4et</code>



<a href="#torchhydro.models.dpl4xaj_nn4et" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>The method is similar with dpl4xaj.py.
The difference between dpl4xaj and dpl4xaj_nn4et is:
in the former, the parameter of PBM is only one output of a DL model,
while in the latter, time series output of a DL model can be as parameter of PBM
and some modules could be replaced with neural networks</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj" class="doc doc-heading">
        <code>
DplLstmNnModuleXaj            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DplLstmNnModuleXaj</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_input_features</span><span class="p">,</span>
        <span class="n">n_output_features</span><span class="p">,</span>
        <span class="n">n_hidden_states</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">,</span>
        <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;clamp&quot;</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
        <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
        <span class="n">nn_hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">et_output</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">        The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_input_features</span>
<span class="sd">            the number of input features of LSTM</span>
<span class="sd">        n_output_features</span>
<span class="sd">            the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">        n_hidden_states</span>
<span class="sd">            the number of hidden features of LSTM</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the time length of unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">        param_limit_func</span>
<span class="sd">            function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">        param_test_way</span>
<span class="sd">            how we use parameters from dl model when testing;</span>
<span class="sd">            now we have three ways:</span>
<span class="sd">            1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">            2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">            3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">            but remember these ways are only for non-variable parameters</span>
<span class="sd">        param_var_index</span>
<span class="sd">            variable parameters&#39; indices in all parameters</span>
<span class="sd">        return_et</span>
<span class="sd">            if True, return evapotranspiration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_var_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nn_hidden_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmNnModuleXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4DplWithNnModule</span><span class="p">(</span>
            <span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">warmup_length</span><span class="p">,</span>
            <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span>
            <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span><span class="p">,</span>
            <span class="n">nn_hidden_size</span><span class="o">=</span><span class="n">nn_hidden_size</span><span class="p">,</span>
            <span class="n">nn_dropout</span><span class="o">=</span><span class="n">nn_dropout</span><span class="p">,</span>
            <span class="n">et_output</span><span class="o">=</span><span class="n">et_output</span><span class="p">,</span>
            <span class="n">param_var_index</span><span class="o">=</span><span class="n">param_var_index</span><span class="p">,</span>
            <span class="n">param_test_way</span><span class="o">=</span><span class="n">param_test_way</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="o">=</span> <span class="n">param_var_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential parameter learning</span>

<span class="sd">        z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">        Parameters will be denormalized in xaj model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">        z</span>
<span class="sd">            normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            one time forward result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: NaN values detected. Check your data firstly!!!&quot;</span><span class="p">)</span>
        <span class="c1"># we set all params&#39; values in [0, 1] and will scale them when forwarding</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;clamp&quot;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;We don&#39;t provide this way to limit parameters&#39; range!! Please choose sigmoid or clamp&quot;</span>
            <span class="p">)</span>
        <span class="c1"># just get one-period values, here we use the final period&#39;s values,</span>
        <span class="c1"># when the MODEL_PARAM_TEST_WAY is not time_varing, we use the last period&#39;s values.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">!=</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># Please put p in the first location and pet in the second</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="o">.</span><span class="n">feature_size</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">param_limit_func</span><span class="o">=</span><span class="s1">&#39;clamp&#39;</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="n">nn_hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">et_output</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</p>
<p>The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_input_features
    the number of input features of LSTM
n_output_features
    the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ
n_hidden_states
    the number of hidden features of LSTM
kernel_size
    the time length of unit hydrograph
warmup_length
    the length of warmup periods;
    hydrologic models need a warmup period to generate reasonable initial state values
param_limit_func
    function used to limit the range of params; now it is sigmoid or clamp function
param_test_way
    how we use parameters from dl model when testing;
    now we have three ways:
    1. "final" -- use the final period's parameter for each period
    2. "mean_time" -- Mean values of all periods' parameters is used
    3. "mean_basin" -- Mean values of all basins' final periods' parameters is used
    but remember these ways are only for non-variable parameters
param_var_index
    variable parameters' indices in all parameters
return_et
    if True, return evapotranspiration</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_input_features</span><span class="p">,</span>
    <span class="n">n_output_features</span><span class="p">,</span>
    <span class="n">n_hidden_states</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">,</span>
    <span class="n">param_limit_func</span><span class="o">=</span><span class="s2">&quot;clamp&quot;</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
    <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="n">nn_hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">et_output</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">return_et</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Parameter learning model: LSTM -&gt; Param -&gt; XAJ</span>

<span class="sd">    The principle can be seen here: https://doi.org/10.1038/s41467-021-26107-z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_input_features</span>
<span class="sd">        the number of input features of LSTM</span>
<span class="sd">    n_output_features</span>
<span class="sd">        the number of output features of LSTM, and it should be equal to the number of learning parameters in XAJ</span>
<span class="sd">    n_hidden_states</span>
<span class="sd">        the number of hidden features of LSTM</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the time length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        hydrologic models need a warmup period to generate reasonable initial state values</span>
<span class="sd">    param_limit_func</span>
<span class="sd">        function used to limit the range of params; now it is sigmoid or clamp function</span>
<span class="sd">    param_test_way</span>
<span class="sd">        how we use parameters from dl model when testing;</span>
<span class="sd">        now we have three ways:</span>
<span class="sd">        1. &quot;final&quot; -- use the final period&#39;s parameter for each period</span>
<span class="sd">        2. &quot;mean_time&quot; -- Mean values of all periods&#39; parameters is used</span>
<span class="sd">        3. &quot;mean_basin&quot; -- Mean values of all basins&#39; final periods&#39; parameters is used</span>
<span class="sd">        but remember these ways are only for non-variable parameters</span>
<span class="sd">    param_var_index</span>
<span class="sd">        variable parameters&#39; indices in all parameters</span>
<span class="sd">    return_et</span>
<span class="sd">        if True, return evapotranspiration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param_var_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nn_hidden_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DplLstmNnModuleXaj</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span> <span class="o">=</span> <span class="n">SimpleLSTM</span><span class="p">(</span><span class="n">n_input_features</span><span class="p">,</span> <span class="n">n_output_features</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span> <span class="o">=</span> <span class="n">Xaj4DplWithNnModule</span><span class="p">(</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span><span class="p">,</span>
        <span class="n">nn_hidden_size</span><span class="o">=</span><span class="n">nn_hidden_size</span><span class="p">,</span>
        <span class="n">nn_dropout</span><span class="o">=</span><span class="n">nn_dropout</span><span class="p">,</span>
        <span class="n">et_output</span><span class="o">=</span><span class="n">et_output</span><span class="p">,</span>
        <span class="n">param_var_index</span><span class="o">=</span><span class="n">param_var_index</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="n">param_test_way</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">=</span> <span class="n">param_limit_func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="o">=</span> <span class="n">param_var_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="o">=</span> <span class="n">return_et</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Differential parameter learning</p>
<p>z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q
Parameters will be denormalized in xaj model</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]
z
    normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.DplLstmNnModuleXaj.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    one time forward result</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential parameter learning</span>

<span class="sd">    z (normalized input) -&gt; lstm -&gt; param -&gt; + x (not normalized) -&gt; xaj -&gt; q</span>
<span class="sd">    Parameters will be denormalized in xaj model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        not normalized data used for physical model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>
<span class="sd">    z</span>
<span class="sd">        normalized data used for DL model; a sequence-first 3-dim tensor. [sequence, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        one time forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dl_model</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: NaN values detected. Check your data firstly!!!&quot;</span><span class="p">)</span>
    <span class="c1"># we set all params&#39; values in [0, 1] and will scale them when forwarding</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_func</span> <span class="o">==</span> <span class="s2">&quot;clamp&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this way to limit parameters&#39; range!! Please choose sigmoid or clamp&quot;</span>
        <span class="p">)</span>
    <span class="c1"># just get one-period values, here we use the final period&#39;s values,</span>
    <span class="c1"># when the MODEL_PARAM_TEST_WAY is not time_varing, we use the last period&#39;s values.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">!=</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="c1"># Please put p in the first location and pet in the second</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb_model</span><span class="o">.</span><span class="n">feature_size</span><span class="p">],</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_et</span> <span class="k">else</span> <span class="n">q</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro" class="doc doc-heading">
        <code>
NnModule4Hydro            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>A NN module for Hydrological model.
Generally, the difference between it and normal NN is:
we need constrain its output to some specific value range</p>
<h5 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro--parameters" title="Permanent link">&para;</a></h5>
<p>nn : <em>type</em>
    <em>description</em></p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NnModule4Hydro</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A NN module for Hydrological model.</span>
<span class="sd">    Generally, the difference between it and normal NN is:</span>
<span class="sd">    we need constrain its output to some specific value range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nn : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A simple multi-layer NN model with final linear layer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nx</span>
<span class="sd">            number of input neurons</span>
<span class="sd">        ny</span>
<span class="sd">            number of output neurons</span>
<span class="sd">        hidden_size</span>
<span class="sd">            a list/tuple which contains number of neurons in each hidden layer;</span>
<span class="sd">            if int, only one hidden layer except for hidden_size=0</span>
<span class="sd">        dr</span>
<span class="sd">            dropout rate of layers, default is 0.0 which means no dropout;</span>
<span class="sd">            here we set number of dropout layers to (number of nn layers - 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NnModule4Hydro</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;the forward function of the NN ET module</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        w0 : _type_</span>
<span class="sd">            water storage</span>
<span class="sd">        p : _type_</span>
<span class="sd">            precipitation</span>
<span class="sd">        pet: tensor</span>
<span class="sd">            potential evapotranspiration, used to be part of upper limit of ET</span>
<span class="sd">        k: tensor</span>
<span class="sd">            coefficient of PET in XAJ model, used to be part of upper limit of ET</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">w_mask</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;</span> <span class="n">PRECISION</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">et</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
            <span class="n">z</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span>
            <span class="nb">min</span><span class="o">=</span><span class="n">zeros</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span>
            <span class="c1"># torch.minimum computes the element-wise minimum: https://pytorch.org/docs/stable/generated/torch.minimum.html</span>
            <span class="c1"># k * pet is real pet in XAJ model</span>
            <span class="nb">max</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">prcp</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">pet</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">et</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A simple multi-layer NN model with final linear layer</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>nx
    number of input neurons
ny
    number of output neurons
hidden_size
    a list/tuple which contains number of neurons in each hidden layer;
    if int, only one hidden layer except for hidden_size=0
dr
    dropout rate of layers, default is 0.0 which means no dropout;
    here we set number of dropout layers to (number of nn layers - 1)</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple multi-layer NN model with final linear layer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nx</span>
<span class="sd">        number of input neurons</span>
<span class="sd">    ny</span>
<span class="sd">        number of output neurons</span>
<span class="sd">    hidden_size</span>
<span class="sd">        a list/tuple which contains number of neurons in each hidden layer;</span>
<span class="sd">        if int, only one hidden layer except for hidden_size=0</span>
<span class="sd">    dr</span>
<span class="sd">        dropout rate of layers, default is 0.0 which means no dropout;</span>
<span class="sd">        here we set number of dropout layers to (number of nn layers - 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">NnModule4Hydro</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ann</span> <span class="o">=</span> <span class="n">SimpleAnn</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>the forward function of the NN ET module</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x : <em>type</em>
    <em>description</em>
w0 : <em>type</em>
    water storage
p : <em>type</em>
    precipitation
!!! pet "tensor"
    potential evapotranspiration, used to be part of upper limit of ET
!!! k "tensor"
    coefficient of PET in XAJ model, used to be part of upper limit of ET</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.NnModule4Hydro.forward--returns" title="Permanent link">&para;</a></h6>
<p><em>type</em>
    <em>description</em></p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;the forward function of the NN ET module</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    w0 : _type_</span>
<span class="sd">        water storage</span>
<span class="sd">    p : _type_</span>
<span class="sd">        precipitation</span>
<span class="sd">    pet: tensor</span>
<span class="sd">        potential evapotranspiration, used to be part of upper limit of ET</span>
<span class="sd">    k: tensor</span>
<span class="sd">        coefficient of PET in XAJ model, used to be part of upper limit of ET</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">w_mask</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;</span> <span class="n">PRECISION</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">et</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
        <span class="n">z</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">zeros</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span>
        <span class="c1"># torch.minimum computes the element-wise minimum: https://pytorch.org/docs/stable/generated/torch.minimum.html</span>
        <span class="c1"># k * pet is real pet in XAJ model</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">prcp</span><span class="p">[</span><span class="n">w_mask</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">pet</span><span class="p">[</span><span class="n">w_mask</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">et</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule" class="doc doc-heading">
        <code>
Xaj4DplWithNnModule            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>XAJ model for Differential Parameter learning with neural network as submodule</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Xaj4DplWithNnModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    XAJ model for Differential Parameter learning with neural network as submodule</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">nn_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
        <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
        <span class="n">et_output</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">nn_hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">param_test_way</span><span class="o">=</span><span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the time length of unit hydrograph</span>
<span class="sd">        warmup_length</span>
<span class="sd">            the length of warmup periods;</span>
<span class="sd">            XAJ needs a warmup period to generate reasonable initial state values</span>
<span class="sd">        nn_module</span>
<span class="sd">            We initialize the module when we firstly initialize Xaj4DplWithNnModule.</span>
<span class="sd">            Then we will iterately call Xaj4DplWithNnModule module for warmup.</span>
<span class="sd">            Hence, in warmup period, we don&#39;t need to initialize it again</span>
<span class="sd">        param_var_index</span>
<span class="sd">            the index of parameters which will be time-varying</span>
<span class="sd">            NOTE: at the most, we support k, b, and c to be time-varying</span>
<span class="sd">        et_output</span>
<span class="sd">            we only support one-layer et now, because its water balance is not easy to handle with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_var_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nn_hidden_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Xaj4DplWithNnModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
        <span class="n">param_range</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;IM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;UM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;LM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;DM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;SM&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;EX&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KG&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CG&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
        <span class="c1"># there are 2 input variables in XAJ: P and PET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">nn_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 7: k, um, lm, dm, c, prcp, p_and_e[:, 1] + 1/3: w0 or wu0, wl0, wd0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span> <span class="o">=</span> <span class="n">NnModule4Hydro</span><span class="p">(</span>
                <span class="mi">7</span> <span class="o">+</span> <span class="n">et_output</span><span class="p">,</span> <span class="n">et_output</span><span class="p">,</span> <span class="n">nn_hidden_size</span><span class="p">,</span> <span class="n">nn_dropout</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span> <span class="o">=</span> <span class="n">nn_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span> <span class="o">=</span> <span class="n">source_book</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">=</span> <span class="n">source_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">=</span> <span class="n">et_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="o">=</span> <span class="n">param_var_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="n">nn_hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_dropout</span> <span class="o">=</span> <span class="n">nn_dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xaj_generation_with_new_module</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p_and_e</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">k</span><span class="p">,</span>
        <span class="n">b</span><span class="p">,</span>
        <span class="n">im</span><span class="p">,</span>
        <span class="n">um</span><span class="p">,</span>
        <span class="n">lm</span><span class="p">,</span>
        <span class="n">dm</span><span class="p">,</span>
        <span class="n">c</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="c1"># wu0: Tensor = None,</span>
        <span class="c1"># wl0: Tensor = None,</span>
        <span class="c1"># wd0: Tensor = None,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="c1"># make sure physical variables&#39; value ranges are correct</span>
        <span class="n">prcp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pet</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># wm</span>
        <span class="n">wm</span> <span class="o">=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">dm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;We only support one-layer evaporation now&quot;</span><span class="p">)</span>
        <span class="n">w0_</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">w0_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w0_</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w0_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">wm</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
        <span class="n">concat_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span><span class="p">(</span><span class="n">concat_input</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="c1"># Calculate the runoff generated by net precipitation</span>
        <span class="n">prcp_difference</span> <span class="o">=</span> <span class="n">prcp</span> <span class="o">-</span> <span class="n">e</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">prcp_difference</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">rim</span> <span class="o">=</span> <span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">calculate_1layer_w_storage</span><span class="p">(</span>
                <span class="n">um</span><span class="p">,</span>
                <span class="n">lm</span><span class="p">,</span>
                <span class="n">dm</span><span class="p">,</span>
                <span class="n">w0</span><span class="p">,</span>
                <span class="n">prcp_difference</span><span class="p">,</span>
                <span class="n">r</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;et_output should be 1&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters_ts</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run XAJ model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p_and_e</span>
<span class="sd">            precipitation and potential evapotranspiration</span>
<span class="sd">        parameters_ts</span>
<span class="sd">            time series parameters of XAJ model;</span>
<span class="sd">            some parameters may be time-varying specified by param_var_index</span>
<span class="sd">        return_state</span>
<span class="sd">            if True, return state values, mainly for warmup periods</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            streamflow got by XAJ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">==</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># parameters_ts must be a 2-d tensor: (basin, param)</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_ts</span>
        <span class="c1"># denormalize the parameters to general range</span>
        <span class="c1"># TODO: now the specific parameters are hard coded; 0 is k, 1 is b, 6 is c, same as in model_config.py</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">um</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="mi">6</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ki_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">kg_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># ki+kg should be smaller than 1; if not, we scale them</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">ki_</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki_</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">kg_</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># initialize state values</span>
        <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
        <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># set no_grad for warmup periods</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">==</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
                    <span class="n">parameters_ts_warmup</span> <span class="o">=</span> <span class="n">parameters_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parameters_ts_warmup</span> <span class="o">=</span> <span class="n">parameters_ts</span>
                <span class="n">cal_init_xaj4dpl</span> <span class="o">=</span> <span class="n">Xaj4DplWithNnModule</span><span class="p">(</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span>
                    <span class="c1"># warmup_length must be 0 here</span>
                    <span class="n">warmup_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">nn_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span><span class="p">,</span>
                    <span class="n">param_var_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span><span class="p">,</span>
                    <span class="n">source_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span><span class="p">,</span>
                    <span class="n">source_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="p">,</span>
                    <span class="n">et_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">et_output</span><span class="p">,</span>
                    <span class="n">nn_hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nn_hidden_size</span><span class="p">,</span>
                    <span class="n">nn_dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nn_dropout</span><span class="p">,</span>
                    <span class="n">param_test_way</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">cal_init_xaj4dpl</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">cal_init_xaj4dpl</span><span class="p">(</span>
                    <span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters_ts_warmup</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># () and , must be added, otherwise, w0 will be a tensor, not a tuple</span>
                <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">()),)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;et_output should be 1 or 3&quot;</span><span class="p">)</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">qi0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
            <span class="n">qg0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rss_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">ris_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">rgs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">es_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">bs</span>
            <span class="k">if</span> <span class="mi">6</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cs</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaj_generation_with_new_module</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaj_generation_with_new_module</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                        <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
            <span class="c1"># impevious part is pe * im</span>
            <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
            <span class="c1"># so for non-imprvious part, the result should be corrected</span>
            <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">es_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="c1"># seq, batch, feature</span>
        <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">es_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">KernelConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">qs_</span> <span class="o">=</span> <span class="n">conv_uh</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
        <span class="c1"># seq, batch, feature</span>
        <span class="n">q_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span>
        <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">warmup_length</span><span class="p">,</span> <span class="n">nn_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="n">et_output</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nn_hidden_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">param_test_way</span><span class="o">=</span><span class="s1">&#39;var&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>kernel_size
    the time length of unit hydrograph
warmup_length
    the length of warmup periods;
    XAJ needs a warmup period to generate reasonable initial state values
nn_module
    We initialize the module when we firstly initialize Xaj4DplWithNnModule.
    Then we will iterately call Xaj4DplWithNnModule module for warmup.
    Hence, in warmup period, we don't need to initialize it again
param_var_index
    the index of parameters which will be time-varying
    NOTE: at the most, we support k, b, and c to be time-varying
et_output
    we only support one-layer et now, because its water balance is not easy to handle with</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nn_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">param_var_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="n">et_output</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">nn_hidden_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nn_dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">param_test_way</span><span class="o">=</span><span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the time length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        the length of warmup periods;</span>
<span class="sd">        XAJ needs a warmup period to generate reasonable initial state values</span>
<span class="sd">    nn_module</span>
<span class="sd">        We initialize the module when we firstly initialize Xaj4DplWithNnModule.</span>
<span class="sd">        Then we will iterately call Xaj4DplWithNnModule module for warmup.</span>
<span class="sd">        Hence, in warmup period, we don&#39;t need to initialize it again</span>
<span class="sd">    param_var_index</span>
<span class="sd">        the index of parameters which will be time-varying</span>
<span class="sd">        NOTE: at the most, we support k, b, and c to be time-varying</span>
<span class="sd">    et_output</span>
<span class="sd">        we only support one-layer et now, because its water balance is not easy to handle with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">param_var_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nn_hidden_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Xaj4DplWithNnModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params_names</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_name&quot;</span><span class="p">]</span>
    <span class="n">param_range</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="s2">&quot;xaj_mz&quot;</span><span class="p">][</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;IM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;UM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;LM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;DM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;SM&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;EX&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KI&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;KG&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CI&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="s2">&quot;CG&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">=</span> <span class="n">warmup_length</span>
    <span class="c1"># there are 2 input variables in XAJ: P and PET</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">nn_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 7: k, um, lm, dm, c, prcp, p_and_e[:, 1] + 1/3: w0 or wu0, wl0, wd0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span> <span class="o">=</span> <span class="n">NnModule4Hydro</span><span class="p">(</span>
            <span class="mi">7</span> <span class="o">+</span> <span class="n">et_output</span><span class="p">,</span> <span class="n">et_output</span><span class="p">,</span> <span class="n">nn_hidden_size</span><span class="p">,</span> <span class="n">nn_dropout</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span> <span class="o">=</span> <span class="n">nn_module</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_book</span> <span class="o">=</span> <span class="n">source_book</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">=</span> <span class="n">source_type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">=</span> <span class="n">et_output</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="o">=</span> <span class="n">param_var_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nn_hidden_size</span> <span class="o">=</span> <span class="n">nn_hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nn_dropout</span> <span class="o">=</span> <span class="n">nn_dropout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">=</span> <span class="n">param_test_way</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters_ts</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>run XAJ model</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--parameters" title="Permanent link">&para;</a></h6>
<p>p_and_e
    precipitation and potential evapotranspiration
parameters_ts
    time series parameters of XAJ model;
    some parameters may be time-varying specified by param_var_index
return_state
    if True, return state values, mainly for warmup periods</p>
<h6 id="torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.Xaj4DplWithNnModule.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    streamflow got by XAJ</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_and_e</span><span class="p">,</span> <span class="n">parameters_ts</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run XAJ model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        precipitation and potential evapotranspiration</span>
<span class="sd">    parameters_ts</span>
<span class="sd">        time series parameters of XAJ model;</span>
<span class="sd">        some parameters may be time-varying specified by param_var_index</span>
<span class="sd">    return_state</span>
<span class="sd">        if True, return state values, mainly for warmup periods</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        streamflow got by XAJ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="o">.</span><span class="n">device</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">==</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># parameters_ts must be a 2-d tensor: (basin, param)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_ts</span>
    <span class="c1"># denormalize the parameters to general range</span>
    <span class="c1"># TODO: now the specific parameters are hard coded; 0 is k, 1 is b, 6 is c, same as in model_config.py</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_sacle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">um</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="mi">6</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters_ts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ki_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ki_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">kg_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># ki+kg should be smaller than 1; if not, we scale them</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">ki_</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki_</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">kg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">kg_</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># initialize state values</span>
    <span class="n">warmup_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_length</span>
    <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># set no_grad for warmup periods</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span> <span class="o">==</span> <span class="n">MODEL_PARAM_TEST_WAY</span><span class="p">[</span><span class="s2">&quot;time_varying&quot;</span><span class="p">]:</span>
                <span class="n">parameters_ts_warmup</span> <span class="o">=</span> <span class="n">parameters_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameters_ts_warmup</span> <span class="o">=</span> <span class="n">parameters_ts</span>
            <span class="n">cal_init_xaj4dpl</span> <span class="o">=</span> <span class="n">Xaj4DplWithNnModule</span><span class="p">(</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">,</span>
                <span class="c1"># warmup_length must be 0 here</span>
                <span class="n">warmup_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">nn_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evap_nn_module</span><span class="p">,</span>
                <span class="n">param_var_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span><span class="p">,</span>
                <span class="n">source_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span><span class="p">,</span>
                <span class="n">source_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="p">,</span>
                <span class="n">et_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">et_output</span><span class="p">,</span>
                <span class="n">nn_hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nn_hidden_size</span><span class="p">,</span>
                <span class="n">nn_dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nn_dropout</span><span class="p">,</span>
                <span class="n">param_test_way</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_test_way</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">cal_init_xaj4dpl</span><span class="o">.</span><span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set init model&#39;s warmup length to 0!!!&quot;</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">cal_init_xaj4dpl</span><span class="p">(</span>
                <span class="n">p_and_e_warmup</span><span class="p">,</span> <span class="n">parameters_ts_warmup</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use detach func to make wu0 no_grad as it is an initial value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">et_output</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># () and , must be added, otherwise, w0 will be a tensor, not a tuple</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">um</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">lm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> <span class="n">dm</span><span class="o">.</span><span class="n">detach</span><span class="p">()),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;et_output should be 1 or 3&quot;</span><span class="p">)</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">qi0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
        <span class="n">qg0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rss_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">ris_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">rgs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="n">es_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">bs</span>
        <span class="k">if</span> <span class="mi">6</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_var_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaj_generation_with_new_module</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xaj_generation_with_new_module</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">xaj_sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="c1"># impevious part is pe * im</span>
        <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
        <span class="c1"># so for non-imprvious part, the result should be corrected</span>
        <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">es_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">es_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">KernelConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">)</span>
    <span class="n">qs_</span> <span class="o">=</span> <span class="n">conv_uh</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">)</span>

    <span class="n">qs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
        <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">q_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span>
    <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_1layer_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></code>


<a href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update the soil moisture value.</p>
<p>According to the runoff-generation equation 2.60 in the book "SHUIWENYUBAO", dW = dPE - dR</p>
<h5 id="torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--parameters" title="Permanent link">&para;</a></h5>
<p>um
    average soil moisture storage capacity of the upper layer (mm)
lm
    average soil moisture storage capacity of the lower layer (mm)
dm
    average soil moisture storage capacity of the deep layer (mm)
w0
    initial values of soil moisture
pe
    net precipitation; it is able to be negative value in this function
r
    runoff</p>
<h5 id="torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--returns">Returns<a class="headerlink" href="#torchhydro.models.dpl4xaj_nn4et.calculate_1layer_w_storage--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    w -- soil moisture</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dpl4xaj_nn4et.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_1layer_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the soil moisture value.</span>

<span class="sd">    According to the runoff-generation equation 2.60 in the book &quot;SHUIWENYUBAO&quot;, dW = dPE - dR</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    um</span>
<span class="sd">        average soil moisture storage capacity of the upper layer (mm)</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of the lower layer (mm)</span>
<span class="sd">    dm</span>
<span class="sd">        average soil moisture storage capacity of the deep layer (mm)</span>
<span class="sd">    w0</span>
<span class="sd">        initial values of soil moisture</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation; it is able to be negative value in this function</span>
<span class="sd">    r</span>
<span class="sd">        runoff</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        w -- soil moisture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xaj_device</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">device</span>
    <span class="n">tensor_zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xaj_device</span><span class="p">)</span>
    <span class="c1"># water balance (equation 2.2 in Page 13, also shown in Page 23)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">tensor_zeros</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="n">um</span> <span class="o">+</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">dm</span><span class="p">)</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.dropout" class="doc doc-heading">
        <code>dropout</code>



<a href="#torchhydro.models.dropout" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2023-07-11 17:39:09
LastEditTime: 2024-10-09 15:27:49
LastEditors: Wenyu Ouyang
Description: Functions for dropout. Code is from Kuai Fang's repo: hydroDL
FilePath:       orchhydro       orchhydro\models\dropout.py
Copyright (c) 2023-2024 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.dropout.DropMask" class="doc doc-heading">
        <code>
DropMask            (<span title="torch.autograd.function.InplaceFunction">InplaceFunction</span>)
        </code>



<a href="#torchhydro.models.dropout.DropMask" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dropout.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DropMask</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">InplaceFunction</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctx : autograd.Function</span>
<span class="sd">            ctx is a context object that can be used to store information for backward computation</span>
<span class="sd">        input : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        mask : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        train : bool, optional</span>
<span class="sd">            if the model is in training mode, by default False</span>
<span class="sd">        inplace : bool, optional</span>
<span class="sd">            inplace operation, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">inplace</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span><span class="p">:</span>
            <span class="c1"># if not in training mode, just return the input</span>
            <span class="k">return</span> <span class="nb">input</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># mark_dirty() is used to mark the input as dirty, meaning inplace operation is performed</span>
            <span class="c1"># make it dirty so that the gradient is calculated correctly during backward</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">mark_dirty</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># clone the input tensor so that avoid changing the input tensor</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c1"># inplace multiplication with the mask</span>
        <span class="n">output</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        backward method for DropMask</span>
<span class="sd">        staticmethod means that the method belongs to the class itself and not to the object of the class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctx : _type_</span>
<span class="sd">            store information for backward computation</span>
<span class="sd">        grad_output : _type_</span>
<span class="sd">            gradient of the downstream layer</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span><span class="p">:</span>
            <span class="c1"># if in training mode, return the gradient multiplied by the mask</span>
            <span class="k">return</span> <span class="n">grad_output</span> <span class="o">*</span> <span class="n">ctx</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not in training mode, return the gradient directly</span>
            <span class="k">return</span> <span class="n">grad_output</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dropout.DropMask.backward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#torchhydro.models.dropout.DropMask.backward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>backward method for DropMask
staticmethod means that the method belongs to the class itself and not to the object of the class</p>
<h6 id="torchhydro.models.dropout.DropMask.backward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dropout.DropMask.backward--parameters" title="Permanent link">&para;</a></h6>
<p>ctx : <em>type</em>
    store information for backward computation
grad_output : <em>type</em>
    gradient of the downstream layer</p>
<h6 id="torchhydro.models.dropout.DropMask.backward--returns">Returns<a class="headerlink" href="#torchhydro.models.dropout.DropMask.backward--returns" title="Permanent link">&para;</a></h6>
<p><em>type</em>
    <em>description</em></p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dropout.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    backward method for DropMask</span>
<span class="sd">    staticmethod means that the method belongs to the class itself and not to the object of the class</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ctx : _type_</span>
<span class="sd">        store information for backward computation</span>
<span class="sd">    grad_output : _type_</span>
<span class="sd">        gradient of the downstream layer</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span><span class="p">:</span>
        <span class="c1"># if in training mode, return the gradient multiplied by the mask</span>
        <span class="k">return</span> <span class="n">grad_output</span> <span class="o">*</span> <span class="n">ctx</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if not in training mode, return the gradient directly</span>
        <span class="k">return</span> <span class="n">grad_output</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.dropout.DropMask.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a href="#torchhydro.models.dropout.DropMask.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p><em>summary</em></p>
<h6 id="torchhydro.models.dropout.DropMask.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dropout.DropMask.forward--parameters" title="Permanent link">&para;</a></h6>
<p>ctx : autograd.Function
    ctx is a context object that can be used to store information for backward computation
input : <em>type</em>
    <em>description</em>
mask : <em>type</em>
    <em>description</em>
train : bool, optional
    if the model is in training mode, by default False
inplace : bool, optional
    inplace operation, by default False</p>
<h6 id="torchhydro.models.dropout.DropMask.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.dropout.DropMask.forward--returns" title="Permanent link">&para;</a></h6>
<p><em>type</em>
    <em>description</em></p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dropout.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ctx : autograd.Function</span>
<span class="sd">        ctx is a context object that can be used to store information for backward computation</span>
<span class="sd">    input : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    mask : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    train : bool, optional</span>
<span class="sd">        if the model is in training mode, by default False</span>
<span class="sd">    inplace : bool, optional</span>
<span class="sd">        inplace operation, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span> <span class="o">=</span> <span class="n">train</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">inplace</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">master_train</span><span class="p">:</span>
        <span class="c1"># if not in training mode, just return the input</span>
        <span class="k">return</span> <span class="nb">input</span>
    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
        <span class="c1"># mark_dirty() is used to mark the input as dirty, meaning inplace operation is performed</span>
        <span class="c1"># make it dirty so that the gradient is calculated correctly during backward</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">mark_dirty</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># clone the input tensor so that avoid changing the input tensor</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="c1"># inplace multiplication with the mask</span>
    <span class="n">output</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.dropout.create_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span></code>


<a href="#torchhydro.models.dropout.create_mask" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Dropout method in Gal &amp; Ghahramami: A Theoretically Grounded Application of Dropout in RNNs.
http://papers.nips.cc/paper/6241-a-theoretically-grounded-application-of-dropout-in-recurrent-neural-networks.pdf</p>
<h5 id="torchhydro.models.dropout.create_mask--parameters">Parameters<a class="headerlink" href="#torchhydro.models.dropout.create_mask--parameters" title="Permanent link">&para;</a></h5>
<p>!!! x "torch.Tensor"
    input tensor
!!! dr "float"
    dropout rate</p>
<h5 id="torchhydro.models.dropout.create_mask--returns">Returns<a class="headerlink" href="#torchhydro.models.dropout.create_mask--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    mask tensor</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/dropout.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dropout method in Gal &amp; Ghahramami: A Theoretically Grounded Application of Dropout in RNNs.</span>
<span class="sd">    http://papers.nips.cc/paper/6241-a-theoretically-grounded-application-of-dropout-in-recurrent-neural-networks.pdf</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: torch.Tensor</span>
<span class="sd">        input tensor</span>
<span class="sd">    dr: float</span>
<span class="sd">        dropout rate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        mask tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># x.new() creates a new tensor with the same data type as x</span>
    <span class="c1"># bernoulli_(1-dr) creates a tensor with the same shape as x, filled with 0 or 1, where 1 has a probability of 1-dr</span>
    <span class="c1"># div_(1-dr) divides the tensor by 1-dr, so that the expected value of the tensor is the same as x, for example, if dr=0.5, then the expected value of the tensor is 2*x</span>
    <span class="c1"># detach_() can be used to detach the tensor from the computation graph so that the gradient is not calculated</span>
    <span class="c1"># if dr=1, then the tensor is all zeros, the results are all NaNs if using the code with bernoulli_(1 - dr).div_(1 - dr).detach_()</span>
    <span class="c1"># so we need to add a special case for dr=1</span>
    <span class="k">if</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># add a warning message</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: dropout rate is 1, directly set 0.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">bernoulli_</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dr</span><span class="p">)</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dr</span><span class="p">)</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.gnn" class="doc doc-heading">
        <code>gnn</code>



<a href="#torchhydro.models.gnn" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.gnn.GNNBaseModel" class="doc doc-heading">
        <code>
GNNBaseModel            (<span title="torch.nn.modules.module.Module">Module</span>, <span title="abc.ABC">ABC</span>)
        </code>



<a href="#torchhydro.models.gnn.GNNBaseModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/gnn.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GNNBaseModel</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_hidden</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">param_sharing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">layerfun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Module</span><span class="p">],</span>
        <span class="n">edge_orientation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">edge_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">root_gauge_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_gauge_idx</span> <span class="o">=</span> <span class="n">root_gauge_idx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">weight_initializer</span><span class="o">=</span><span class="s2">&quot;kaiming_uniform&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">param_sharing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">ModuleList</span><span class="p">(</span><span class="n">num_hidden</span> <span class="o">*</span> <span class="p">[</span><span class="n">layerfun</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">ModuleList</span><span class="p">([</span><span class="n">layerfun</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_hidden</span><span class="p">)])</span>
        <span class="c1"># decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span>
            <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">weight_initializer</span><span class="o">=</span><span class="s2">&quot;kaiming_uniform&quot;</span>
        <span class="p">)</span>
        <span class="c1"># </span>
        <span class="k">if</span> <span class="n">root_gauge_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># forward</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Linear</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edge_weights</span> <span class="o">=</span> <span class="n">edge_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_orientation</span> <span class="o">=</span> <span class="n">edge_orientation</span>
        <span class="c1"># edge_weightsforward</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_fill_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">1.0</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_weights</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;mean&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># forwardedge_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_fill_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">edge_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">edge_weight</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">batch_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evo_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        GNN</span>
<span class="sd">        1. batch_vectorbatchPyG/</span>
<span class="sd">        2. batch[batch, num_nodes, ...]</span>

<span class="sd">        :</span>
<span class="sd">            x: shape</span>
<span class="sd">            edge_index: PyG</span>
<span class="sd">            edge_weight: None1</span>
<span class="sd">            batch_vector: batch</span>
<span class="sd">            evo_tracking: </span>
<span class="sd">        :</span>
<span class="sd">            (, )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#  tensor  encoder.device device </span>
        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">edge_weight</span> <span class="o">=</span> <span class="n">edge_weight</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_vector</span> <span class="o">=</span> <span class="n">batch_vector</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#  x  [batch, num_nodes, window_size, num_features]  [total_nodes, window_size, num_features]</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported x shape for GNN batch_vector mode: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">evolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_0</span><span class="o">.</span><span class="n">detach</span><span class="p">()]</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_gauge_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># PyTorchbatch mean</span>
                <span class="n">out_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">out_sum</span> <span class="o">=</span> <span class="n">out_sum</span><span class="o">.</span><span class="n">index_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_vector</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">index_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_vector</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">batch_vector</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">out_sum</span> <span class="o">/</span> <span class="n">count</span>
                <span class="c1">#  shape  [batch, time, feature] [batch, output_size, 1] output_size==1</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">evolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#  shape  [node, time, feature] [N, output_size, 1]</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">evolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#  batch  edge_weight  edge_index </span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">window_size</span> <span class="o">*</span> <span class="n">num_features</span><span class="p">)</span>
            <span class="c1"># edge_index: [2, num_edges]  [batch, 2, num_edges]</span>
            <span class="k">if</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">node_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">edge_index</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_nodes</span>
                <span class="n">node_offsets</span> <span class="o">=</span> <span class="n">node_offsets</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">edge_index_offset</span> <span class="o">=</span> <span class="n">edge_index</span> <span class="o">+</span> <span class="n">node_offsets</span>
                <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index_offset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">edge_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">num_nodes</span>
                        <span class="n">edge_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_index</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">edge_indices</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># </span>
            <span class="c1"># edge_index, edge_weight = add_self_loops(edge_index, edge_weight, num_nodes=batch_size * num_nodes)</span>
            <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">evolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_0</span><span class="o">.</span><span class="n">detach</span><span class="p">()]</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_gauge_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span>
                        <span class="n">input_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="n">weight_initializer</span><span class="o">=</span><span class="s2">&quot;kaiming_uniform&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">x_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span><span class="p">(</span><span class="n">x_flat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">evolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">evolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="n">x</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_layer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">edge_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">edge_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">











  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.gnn.GNNBaseModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span class="p">,</span> <span class="n">batch_vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evo_tracking</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#torchhydro.models.gnn.GNNBaseModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>GNN
1. batch_vectorbatchPyG/
2. batch[batch, num_nodes, ...]</p>
<p>!!! 
    x: shape
    edge_index: PyG
    edge_weight: None1
    batch_vector: batch
    evo_tracking: 
!!! 
    (, )</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/gnn.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">edge_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">edge_weight</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">batch_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">evo_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GNN</span>
<span class="sd">    1. batch_vectorbatchPyG/</span>
<span class="sd">    2. batch[batch, num_nodes, ...]</span>

<span class="sd">    :</span>
<span class="sd">        x: shape</span>
<span class="sd">        edge_index: PyG</span>
<span class="sd">        edge_weight: None1</span>
<span class="sd">        batch_vector: batch</span>
<span class="sd">        evo_tracking: </span>
<span class="sd">    :</span>
<span class="sd">        (, )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  tensor  encoder.device device </span>
    <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">edge_weight</span> <span class="o">=</span> <span class="n">edge_weight</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_vector</span> <span class="o">=</span> <span class="n">batch_vector</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#  x  [batch, num_nodes, window_size, num_features]  [total_nodes, window_size, num_features]</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported x shape for GNN batch_vector mode: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">evolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_0</span><span class="o">.</span><span class="n">detach</span><span class="p">()]</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_gauge_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># PyTorchbatch mean</span>
            <span class="n">out_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">out_sum</span> <span class="o">=</span> <span class="n">out_sum</span><span class="o">.</span><span class="n">index_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_vector</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">index_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_vector</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">batch_vector</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">out_sum</span> <span class="o">/</span> <span class="n">count</span>
            <span class="c1">#  shape  [batch, time, feature] [batch, output_size, 1] output_size==1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">evolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#  shape  [node, time, feature] [N, output_size, 1]</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">evolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#  batch  edge_weight  edge_index </span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">window_size</span> <span class="o">*</span> <span class="n">num_features</span><span class="p">)</span>
        <span class="c1"># edge_index: [2, num_edges]  [batch, 2, num_edges]</span>
        <span class="k">if</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">node_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">edge_index</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_nodes</span>
            <span class="n">node_offsets</span> <span class="o">=</span> <span class="n">node_offsets</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">edge_index_offset</span> <span class="o">=</span> <span class="n">edge_index</span> <span class="o">+</span> <span class="n">node_offsets</span>
            <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index_offset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">edge_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">num_nodes</span>
                    <span class="n">edge_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_index</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">edge_indices</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># </span>
        <span class="c1"># edge_index, edge_weight = add_self_loops(edge_index, edge_weight, num_nodes=batch_size * num_nodes)</span>
        <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">evolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_0</span><span class="o">.</span><span class="n">detach</span><span class="p">()]</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_weight</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_gauge_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="n">evolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">input_dim</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span>
                    <span class="n">input_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span> <span class="n">weight_initializer</span><span class="o">=</span><span class="s2">&quot;kaiming_uniform&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">x_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_layer</span><span class="p">(</span><span class="n">x_flat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">evo_tracking</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">evolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">evolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">evo_tracking</span> <span class="k">else</span> <span class="n">x</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>










  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.kernel_conv" class="doc doc-heading">
        <code>kernel_conv</code>



<a href="#torchhydro.models.kernel_conv" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.kernel_conv.KernelConv" class="doc doc-heading">
        <code>
KernelConv            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.kernel_conv.KernelConv" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/kernel_conv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KernelConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The convolution kernel for the convolution operation in routing module</span>

<span class="sd">        We use two-parameter gamma distribution to determine the unit hydrograph,</span>
<span class="sd">        which comes from [mizuRoute](http://www.geosci-model-dev.net/9/2223/2016/)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a</span>
<span class="sd">            shape parameter</span>
<span class="sd">        theta</span>
<span class="sd">            timescale parameter</span>
<span class="sd">        kernel_size</span>
<span class="sd">            the size of conv kernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KernelConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">routa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">routb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uh_gamma</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">routa</span><span class="p">,</span> <span class="n">routb</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1d-convolution calculation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x</span>
<span class="sd">            x is a sequence-first variable, so the dim of x is [seq, batch, feature]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            convolution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># dim: permute from [len_uh, batch, feature] to [batch, feature, len_uh]</span>
        <span class="n">uh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uh_gamma</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># the dim of conv kernel in F.conv1d is out_channels, in_channels (feature)/groups, width (seq)</span>
        <span class="c1"># the dim of inputs in F.conv1d are batch, in_channels (feature) and width (seq),</span>
        <span class="c1"># each element in a batch should has its own conv kernel,</span>
        <span class="c1"># hence set groups = batch_size and permute input&#39;s batch-dim to channel-dim to make &quot;groups&quot; work</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># conv1d in NN is different from the general convolution: it is lack of a flip</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">groups</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">uh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># permute from [feature, batch, seq] to [seq, batch, feature]</span>
        <span class="k">return</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">uh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.kernel_conv.KernelConv.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.kernel_conv.KernelConv.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>The convolution kernel for the convolution operation in routing module</p>
<p>We use two-parameter gamma distribution to determine the unit hydrograph,
which comes from <a href="http://www.geosci-model-dev.net/9/2223/2016/">mizuRoute</a></p>
<h6 id="torchhydro.models.kernel_conv.KernelConv.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.kernel_conv.KernelConv.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>a
    shape parameter
theta
    timescale parameter
kernel_size
    the size of conv kernel</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/kernel_conv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The convolution kernel for the convolution operation in routing module</span>

<span class="sd">    We use two-parameter gamma distribution to determine the unit hydrograph,</span>
<span class="sd">    which comes from [mizuRoute](http://www.geosci-model-dev.net/9/2223/2016/)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a</span>
<span class="sd">        shape parameter</span>
<span class="sd">    theta</span>
<span class="sd">        timescale parameter</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the size of conv kernel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">KernelConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="n">routa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">routb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uh_gamma</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">routa</span><span class="p">,</span> <span class="n">routb</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.kernel_conv.KernelConv.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.kernel_conv.KernelConv.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>1d-convolution calculation</p>
<h6 id="torchhydro.models.kernel_conv.KernelConv.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.kernel_conv.KernelConv.forward--parameters" title="Permanent link">&para;</a></h6>
<p>x
    x is a sequence-first variable, so the dim of x is [seq, batch, feature]</p>
<h6 id="torchhydro.models.kernel_conv.KernelConv.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.kernel_conv.KernelConv.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    convolution</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/kernel_conv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1d-convolution calculation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        x is a sequence-first variable, so the dim of x is [seq, batch, feature]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        convolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dim: permute from [len_uh, batch, feature] to [batch, feature, len_uh]</span>
    <span class="n">uh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uh_gamma</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># the dim of conv kernel in F.conv1d is out_channels, in_channels (feature)/groups, width (seq)</span>
    <span class="c1"># the dim of inputs in F.conv1d are batch, in_channels (feature) and width (seq),</span>
    <span class="c1"># each element in a batch should has its own conv kernel,</span>
    <span class="c1"># hence set groups = batch_size and permute input&#39;s batch-dim to channel-dim to make &quot;groups&quot; work</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># conv1d in NN is different from the general convolution: it is lack of a flip</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">groups</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">uh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># permute from [feature, batch, seq] to [seq, batch, feature]</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">uh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.kernel_conv.uh_conv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uh_conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">uh_made</span><span class="p">)</span></code>


<a href="#torchhydro.models.kernel_conv.uh_conv" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Function for 1d-convolution calculation</p>
<h5 id="torchhydro.models.kernel_conv.uh_conv--parameters">Parameters<a class="headerlink" href="#torchhydro.models.kernel_conv.uh_conv--parameters" title="Permanent link">&para;</a></h5>
<p>x
    x is a sequence-first variable, so the dim of x is [seq, batch, feature]
uh_made
    unit hydrograph from uh_gamma or other unit-hydrograph method</p>
<h5 id="torchhydro.models.kernel_conv.uh_conv--returns">Returns<a class="headerlink" href="#torchhydro.models.kernel_conv.uh_conv--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    convolution, [seq, batch, feature]; the length of seq is same as x's</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/kernel_conv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">uh_conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">uh_made</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for 1d-convolution calculation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        x is a sequence-first variable, so the dim of x is [seq, batch, feature]</span>
<span class="sd">    uh_made</span>
<span class="sd">        unit hydrograph from uh_gamma or other unit-hydrograph method</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        convolution, [seq, batch, feature]; the length of seq is same as x&#39;s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uh</span> <span class="o">=</span> <span class="n">uh_made</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># the dim of conv kernel in F.conv1d is out_channels, in_channels (feature)/groups, width (seq)</span>
    <span class="c1"># the dim of inputs in F.conv1d are batch, in_channels (feature) and width (seq),</span>
    <span class="c1"># each element in a batch should has its own conv kernel,</span>
    <span class="c1"># hence set groups = batch_size and permute input&#39;s batch-dim to channel-dim to make &quot;groups&quot; work</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># conv1d in NN is different from the general convolution: it is lack of a flip</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">groups</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">uh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># cut to same shape with x and permute from [feature, batch, seq] to [seq, batch, feature]</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.kernel_conv.uh_gamma" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>


<a href="#torchhydro.models.kernel_conv.uh_gamma" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model</p>
<p>The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</p>
<h5 id="torchhydro.models.kernel_conv.uh_gamma--parameters">Parameters<a class="headerlink" href="#torchhydro.models.kernel_conv.uh_gamma--parameters" title="Permanent link">&para;</a></h5>
<p>a
    shape parameter
theta
    timescale parameter
len_uh
    the time length of the unit hydrograph</p>
<h5 id="torchhydro.models.kernel_conv.uh_gamma--returns">Returns<a class="headerlink" href="#torchhydro.models.kernel_conv.uh_gamma--returns" title="Permanent link">&para;</a></h5>
<p>torch.Tensor
    the unit hydrograph, dim: [seq, batch, feature]</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/kernel_conv.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model</span>

<span class="sd">    The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a</span>
<span class="sd">        shape parameter</span>
<span class="sd">    theta</span>
<span class="sd">        timescale parameter</span>
<span class="sd">    len_uh</span>
<span class="sd">        the time length of the unit hydrograph</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        the unit hydrograph, dim: [seq, batch, feature]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dims of a: time_seq (same all time steps), batch, feature=1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">len_uh</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># aa &gt; 0, here we set minimum 0.1 (min of a is 0, set when calling this func); First dimension of a is repeat</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="c1"># theta &gt; 0, here set minimum 0.5</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="c1"># len_f, batch, feature</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">len_uh</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="n">len_uh</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">lgamma</span><span class="p">()</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="n">aa</span><span class="p">)</span>
    <span class="c1"># [len_f, m[1], m[2]]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">denominator</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">**</span> <span class="p">(</span><span class="n">aa</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># scale to 1 for each UH</span>
    <span class="k">return</span> <span class="n">w</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.model_dict_function" class="doc doc-heading">
        <code>model_dict_function</code>



<a href="#torchhydro.models.model_dict_function" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2021-12-31 11:08:29
LastEditTime: 2025-07-13 18:17:48
LastEditors: Wenyu Ouyang
Description: Dicts including models (which are seq-first), losses, and optims
FilePath:       orchhydro       orchhydro\models\model_dict_function.py
Copyright (c) 2021-2022 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">














  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.model_utils" class="doc doc-heading">
        <code>model_utils</code>



<a href="#torchhydro.models.model_utils" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2021-08-09 10:19:13
LastEditTime: 2025-04-15 12:59:35
LastEditors: Wenyu Ouyang
Description: Some util functions for modeling
FilePath: /torchhydro/torchhydro/models/model_utils.py
Copyright (c) 2021-2022 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h3 id="torchhydro.models.model_utils.get_the_device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_the_device</span><span class="p">(</span><span class="n">device_num</span><span class="p">)</span></code>


<a href="#torchhydro.models.model_utils.get_the_device" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get device for torch according to its name</p>
<h5 id="torchhydro.models.model_utils.get_the_device--parameters">Parameters<a class="headerlink" href="#torchhydro.models.model_utils.get_the_device--parameters" title="Permanent link">&para;</a></h5>
<p>device_num : Union[list, int]
    number of the device -- -1 means "cpu" or 0, 1, ... means "cuda:x" or "mps:x"</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/model_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_the_device</span><span class="p">(</span><span class="n">device_num</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get device for torch according to its name</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    device_num : Union[list, int]</span>
<span class="sd">        number of the device -- -1 means &quot;cpu&quot; or 0, 1, ... means &quot;cuda:x&quot; or &quot;mps:x&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">device_num</span> <span class="ow">in</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-1&quot;</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">device_num</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">device_num</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span>
            <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">device_num</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Check for MPS (MacOS)</span>
    <span class="n">mps_available</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
        <span class="n">mps_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mps_available</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;MPS only supports device 0. Using &#39;mps:0&#39; instead of </span><span class="si">{</span><span class="n">device_num</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;mps:0&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">device_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-1&quot;</span><span class="p">]]:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have GPU, so have to choose cpu for models&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.mtslstm" class="doc doc-heading">
        <code>mtslstm</code>



<a href="#torchhydro.models.mtslstm" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.mtslstm.MTSLSTM" class="doc doc-heading">
        <code>
MTSLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.mtslstm.MTSLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Multi-Temporal-Scale LSTM (MTS-LSTM).</p>
<p>This model processes multi-frequency time-series data (hour/day/week) by
aggregating high-frequency (hourly) inputs into lower-frequency branches.
It supports per-feature down-aggregation, optional state transfer between
frequency branches, and loading pretrained weights for the daily branch.</p>
<p>Example usage:
    # Unified hourly input (recommended)
    model = MTSLSTM(
        hidden_sizes=[64, 64, 64],
        output_size=1,
        feature_buckets=[2, 2, 1, 0, ...],
        frequency_factors=[7, 24],   # week-&gt;day 7, day-&gt;hour 24
        seq_lengths=[T_week, T_day, T_hour],
        slice_transfer=True,
    )
    y = model(x_hour)  # x_hour: (T_hour, B, D)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code># Legacy: explicitly provide each frequency branch
y = model(x_week, x_day, x_hour)
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/mtslstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MTSLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-Temporal-Scale LSTM (MTS-LSTM).</span>

<span class="sd">    This model processes multi-frequency time-series data (hour/day/week) by</span>
<span class="sd">    aggregating high-frequency (hourly) inputs into lower-frequency branches.</span>
<span class="sd">    It supports per-feature down-aggregation, optional state transfer between</span>
<span class="sd">    frequency branches, and loading pretrained weights for the daily branch.</span>

<span class="sd">    Example usage:</span>
<span class="sd">        # Unified hourly input (recommended)</span>
<span class="sd">        model = MTSLSTM(</span>
<span class="sd">            hidden_sizes=[64, 64, 64],</span>
<span class="sd">            output_size=1,</span>
<span class="sd">            feature_buckets=[2, 2, 1, 0, ...],</span>
<span class="sd">            frequency_factors=[7, 24],   # week-&gt;day 7, day-&gt;hour 24</span>
<span class="sd">            seq_lengths=[T_week, T_day, T_hour],</span>
<span class="sd">            slice_transfer=True,</span>
<span class="sd">        )</span>
<span class="sd">        y = model(x_hour)  # x_hour: (T_hour, B, D)</span>

<span class="sd">        # Legacy: explicitly provide each frequency branch</span>
<span class="sd">        y = model(x_week, x_day, x_hour)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_sizes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_sizes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
        <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">shared_mtslstm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">transfer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">return_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">add_freq_one_hot_if_shared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">auto_build_lowfreq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">build_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">agg_reduce</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">per_feature_aggs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">truncate_incomplete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">slice_transfer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">slice_use_ceil</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">seq_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frequency_factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_buckets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">per_feature_aggs_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">down_aggregate_all_to_each_branch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pretrained_day_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrained_lstm_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrained_head_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrained_flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">linear1_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">linear2_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes an MTSLSTM model.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_sizes: Input feature dimension(s). Can be:</span>
<span class="sd">                * int: shared across all frequency branches</span>
<span class="sd">                * list: per-frequency input sizes</span>
<span class="sd">                * None: inferred from `feature_buckets`</span>
<span class="sd">            hidden_sizes: Hidden dimension(s) for each LSTM branch.</span>
<span class="sd">            output_size: Output dimension per timestep.</span>
<span class="sd">            shared_mtslstm: If True, all frequency branches share one LSTM.</span>
<span class="sd">            transfer: Hidden state transfer mode between frequencies.</span>
<span class="sd">                * None: no transfer</span>
<span class="sd">                * &quot;identity&quot;: copy states directly (same dim required)</span>
<span class="sd">                * &quot;linear&quot;: learn linear projection between dims</span>
<span class="sd">            dropout: Dropout probability applied before heads.</span>
<span class="sd">            return_all: If True, return all branch outputs (dict f0,f1,...).</span>
<span class="sd">                If False, return only the highest-frequency output.</span>
<span class="sd">            add_freq_one_hot_if_shared: If True and `shared_mtslstm=True`,</span>
<span class="sd">                append frequency one-hot encoding to inputs.</span>
<span class="sd">            auto_build_lowfreq: Legacy 2-frequency path (high-&gt;low).</span>
<span class="sd">            build_factor: Aggregation factor for auto low-frequency.</span>
<span class="sd">            agg_reduce: Aggregation method for downsampling (&quot;mean&quot; or &quot;sum&quot;).</span>
<span class="sd">            per_feature_aggs: Optional list of per-feature aggregation methods.</span>
<span class="sd">            truncate_incomplete: Whether to drop remainder timesteps when</span>
<span class="sd">                aggregating (vs. zero-padding).</span>
<span class="sd">            slice_transfer: If True, transfer LSTM states at slice boundaries</span>
<span class="sd">                computed by seq_lengths  frequency_factors.</span>
<span class="sd">            slice_use_ceil: If True, use ceil for slice length calculation.</span>
<span class="sd">            seq_lengths: Per-frequency sequence lengths [low, ..., high].</span>
<span class="sd">            frequency_factors: Multipliers between adjacent frequencies.</span>
<span class="sd">                Example: [7,24] means week-&gt;day 7, day-&gt;hour 24.</span>
<span class="sd">            feature_buckets: Per-feature frequency assignment (len = D).</span>
<span class="sd">                0 = lowest (week), nf-1 = highest (hour).</span>
<span class="sd">            per_feature_aggs_map: Per-feature aggregation method (&quot;mean&quot;/&quot;sum&quot;).</span>
<span class="sd">            down_aggregate_all_to_each_branch: If True, branch f includes all</span>
<span class="sd">                features with bucket &gt;= f (down-aggregate); else only == f.</span>
<span class="sd">            pretrained_day_path: Optional path to pretrained checkpoint. If set,</span>
<span class="sd">                loads weights for the daily (f1) LSTM and head.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If configuration is inconsistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Store configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span> <span class="o">=</span> <span class="n">pretrained_day_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_flag</span> <span class="o">=</span> <span class="n">pretrained_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear1_size</span> <span class="o">=</span> <span class="n">linear1_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear2_size</span> <span class="o">=</span> <span class="n">linear2_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared_mtslstm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_all_default</span> <span class="o">=</span> <span class="n">return_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">per_feature_aggs_map</span><span class="p">)</span> <span class="k">if</span> <span class="n">per_feature_aggs_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_agg_all</span> <span class="o">=</span> <span class="n">down_aggregate_all_to_each_branch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_build_lowfreq</span> <span class="o">=</span> <span class="n">auto_build_lowfreq</span>

        <span class="c1"># Aggregation and slicing parameters</span>
        <span class="k">assert</span> <span class="n">build_factor</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;build_factor must be &gt;=2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">build_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg_reduce</span> <span class="o">=</span> <span class="n">agg_reduce</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs</span> <span class="o">=</span> <span class="n">per_feature_aggs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncate_incomplete</span> <span class="o">=</span> <span class="n">truncate_incomplete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_transfer</span> <span class="o">=</span> <span class="n">slice_transfer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_use_ceil</span> <span class="o">=</span> <span class="n">slice_use_ceil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seq_lengths</span><span class="p">)</span> <span class="k">if</span> <span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warned_slice_fallback</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Setup frequency configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frequency_config</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">)</span>

        <span class="c1"># Validate seq_lengths</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="s2">&quot;seq_lengths length must match nf&quot;</span>

        <span class="c1"># Setup input sizes for each branch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_input_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_input_sizes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_agg_all</span>
        <span class="p">)</span>

        <span class="c1"># Setup hidden layer sizes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">hidden_sizes</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="s2">&quot;hidden_sizes length mismatch&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">)</span>

        <span class="c1"># Setup frequency one-hot encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_freq1hot</span> <span class="o">=</span> <span class="n">add_freq_one_hot_if_shared</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>

        <span class="c1"># Setup transfer configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_transfer_config</span><span class="p">(</span><span class="n">transfer</span><span class="p">)</span>

        <span class="c1"># Setup frequency factors and slice timesteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frequency_factors</span><span class="p">(</span><span class="n">frequency_factors</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span><span class="p">)</span>

        <span class="c1"># Calculate effective input sizes (including one-hot if needed)</span>
        <span class="n">eff_input_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_input_sizes</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_freq1hot</span><span class="p">:</span>
            <span class="n">eff_input_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">eff_input_sizes</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shared_mtslstm=True requires equal input sizes.&quot;</span><span class="p">)</span>

        <span class="c1"># Create model layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_model_layers</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">)</span>

        <span class="c1"># Create transfer layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_transfer_layers</span><span class="p">()</span>

        <span class="c1"># Setup dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

        <span class="c1"># Set unified hourly aggregation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_hourly_unified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Load pretrained weights if specified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_pretrained_weights</span><span class="p">(</span><span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_frequency_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup frequency configuration and compute number of frequencies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;feature_buckets cannot be empty&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_sizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">input_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">auto_build_lowfreq</span> <span class="k">else</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sizes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;At least 2 frequencies required&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_sizes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_input_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="n">down_aggregate_all_to_each_branch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup input sizes for each frequency branch.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">down_aggregate_all_to_each_branch</span><span class="p">:</span>
                <span class="n">base_input_sizes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature_buckets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_input_sizes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature_buckets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_sizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">base_input_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_sizes</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_input_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_sizes</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_input_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="s2">&quot;input_sizes mismatch with nf&quot;</span>
        <span class="k">return</span> <span class="n">base_input_sizes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_transfer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup transfer configuration for hidden and cell states.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transfer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transfer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">transfer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="n">transfer</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">transfer</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="n">transfer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">transfer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span>
            <span class="p">),</span> <span class="s2">&quot;transfer must be None/&#39;identity&#39;/&#39;linear&#39;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_frequency_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency_factors</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">,</span> <span class="n">build_factor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup frequency factors and slice timesteps.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frequency_factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">frequency_factors</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="s2">&quot;frequency_factors length must be nf-1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">frequency_factors</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">auto_build_lowfreq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">build_factor</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Pre-compute slice positions if seq_lengths and frequency_factors are provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_timesteps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_timesteps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">fac</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">next_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">next_len</span> <span class="o">/</span> <span class="n">fac</span><span class="p">)</span>  <span class="c1"># floor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_timesteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_model_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eff_input_sizes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create LSTM and linear layers based on configuration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_flag</span><span class="p">:</span>
            <span class="c1"># Use pretrained model specific layers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear1_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear2_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use default layers when no pretrained model is loaded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_linears</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># Create head layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_transfer_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create transfer projection layers between frequency branches.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">hs_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">hs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hs_i</span><span class="p">,</span> <span class="n">hs_j</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;identity&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">hs_i</span> <span class="o">==</span> <span class="n">hs_j</span><span class="p">,</span> <span class="s2">&quot;identity requires same hidden size&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hs_i</span><span class="p">,</span> <span class="n">hs_j</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_mode</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;identity&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">hs_i</span> <span class="o">==</span> <span class="n">hs_j</span><span class="p">,</span> <span class="s2">&quot;identity requires same hidden size&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_pretrained_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load pretrained weights for the daily branch if specified.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[MTSLSTM] Pretrained file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;[MTSLSTM] shared_mtslstm=True: skip daily-only pretrained load.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;[MTSLSTM] nf&lt;2: no daily branch, skip pretrained load.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;state_dict&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_load_daily_branch_weights</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MTSLSTM] Failed to load daily pretrained: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_daily_branch_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load weights for the daily LSTM and head from pretrained state.&quot;&quot;&quot;</span>
        <span class="n">day_lstm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">day_head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lstm_state</span> <span class="o">=</span> <span class="n">day_lstm</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="n">head_state</span> <span class="o">=</span> <span class="n">day_head</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

        <span class="n">matched</span> <span class="o">=</span> <span class="n">skipped</span> <span class="o">=</span> <span class="n">shape_mismatch</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">try_load</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">matched</span><span class="p">,</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">shape_mismatch</span>
            <span class="k">for</span> <span class="n">k_pre</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k_pre</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k_pre</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_state</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">target_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="n">target_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">matched</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shape_mismatch</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">try_load</span><span class="p">(</span><span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">lstm_state</span><span class="p">)</span>
        <span class="n">try_load</span><span class="p">(</span><span class="n">pretrained_head_prefix</span><span class="p">,</span> <span class="n">head_state</span><span class="p">)</span>

        <span class="c1"># Load pretrained linearIn into linear2[1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_linear_weights</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="c1"># Fallback: try raw state_dict without prefix</span>
        <span class="k">if</span> <span class="n">matched</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lstm_state</span> <span class="ow">and</span> <span class="n">lstm_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">lstm_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">matched</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">head_state</span> <span class="ow">and</span> <span class="n">head_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">head_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">matched</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape_mismatch</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_loading_debug_info</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">day_lstm</span><span class="p">,</span> <span class="n">day_head</span><span class="p">)</span>

        <span class="n">day_lstm</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">lstm_state</span><span class="p">)</span>
        <span class="n">day_head</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">head_state</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[MTSLSTM] Daily pretrained loaded: matched=</span><span class="si">{</span><span class="n">matched</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;shape_mismatch=</span><span class="si">{</span><span class="n">shape_mismatch</span><span class="si">}</span><span class="s2">, skipped=</span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_linear_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load pretrained linear layer weights.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;linearIn.weight&quot;</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">and</span> <span class="s2">&quot;linearIn.bias&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">linear_weight</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;linearIn.weight&quot;</span><span class="p">]</span>
            <span class="n">linear_bias</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;linearIn.bias&quot;</span><span class="p">]</span>

            <span class="n">target_linear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">target_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">linear_weight</span><span class="o">.</span><span class="n">shape</span>
                <span class="ow">and</span> <span class="n">target_linear</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">linear_bias</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">):</span>
                <span class="n">target_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">linear_weight</span><span class="p">)</span>
                <span class="n">target_linear</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">linear_bias</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[MTSLSTM] Pretrained linearIn loaded into linear2[1]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[MTSLSTM] linearIn shape mismatch: pretrained </span><span class="si">{</span><span class="n">linear_weight</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;current </span><span class="si">{</span><span class="n">target_linear</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;[MTSLSTM] linearIn keys not found in pretrained state&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_loading_debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">day_lstm</span><span class="p">,</span> <span class="n">day_head</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print debug information about pretrained weight loading.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Pretrained keys ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Current LSTM keys ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">day_lstm</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Current Head keys ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">day_head</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Head.bias pretrained:&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;linearOut.bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Head.bias current:&quot;</span><span class="p">,</span> <span class="n">day_head</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_append_one_hot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">freq_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Appends a one-hot frequency indicator to the input tensor.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): Input tensor of shape (T, B, D).</span>
<span class="sd">            freq_idx (int): Frequency index to mark as 1 in the one-hot vector.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Tensor of shape (T, B, D + nf), where `nf` is the</span>
<span class="sd">            number of frequency branches. The appended one-hot encodes the</span>
<span class="sd">            branch identity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">oh</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">))</span>
        <span class="n">oh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">freq_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">oh</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_lstm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">lstm</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span>
        <span class="n">head</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span>
        <span class="n">h0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">c0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs an LSTM followed by a linear head with optional initial states.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (torch.Tensor): Input tensor of shape (T, B, D).</span>
<span class="sd">            lstm (nn.LSTM): LSTM module for this branch.</span>
<span class="sd">            head (nn.Linear): Linear output layer.</span>
<span class="sd">            h0 (torch.Tensor): Optional initial hidden state (1, B, H).</span>
<span class="sd">            c0 (torch.Tensor): Optional initial cell state (1, B, H).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:</span>
<span class="sd">                - y (torch.Tensor): Output sequence (T, B, O).</span>
<span class="sd">                - h_n (torch.Tensor): Final hidden state (1, B, H).</span>
<span class="sd">                - c_n (torch.Tensor): Final cell state (1, B, H).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">c0</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">h0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>  <span class="c1"># Project to output size</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_lowfreq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_high</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">factor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">agg_reduce</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">],</span>
        <span class="n">per_feature_aggs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]]],</span>
        <span class="n">truncate_incomplete</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregates high-frequency input into lower-frequency sequences.</span>

<span class="sd">        Args:</span>
<span class="sd">            x_high (torch.Tensor): Input tensor (T, B, D) at high frequency.</span>
<span class="sd">            factor (int): Aggregation factor (e.g., 24 for daily from hourly).</span>
<span class="sd">            agg_reduce (str): Default aggregation method, &quot;mean&quot; or &quot;sum&quot;.</span>
<span class="sd">            per_feature_aggs (List[str] | None):</span>
<span class="sd">                Optional per-feature aggregation strategies (&quot;mean&quot;/&quot;sum&quot;).</span>
<span class="sd">            truncate_incomplete (bool): If True, drop incomplete groups;</span>
<span class="sd">                if False, pad to make groups complete.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Aggregated tensor of shape (T_low, B, D),</span>
<span class="sd">            where T_low = floor(T / factor) if truncate_incomplete,</span>
<span class="sd">            else ceil(T / factor).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `agg_reduce` is not &quot;mean&quot; or &quot;sum&quot;.</span>
<span class="sd">            AssertionError: If `per_feature_aggs` length mismatches feature dim.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x_high</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">factor</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x_high</span>
        <span class="k">if</span> <span class="n">truncate_incomplete</span><span class="p">:</span>
            <span class="n">T_trim</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">//</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">xh</span> <span class="o">=</span> <span class="n">x_high</span><span class="p">[:</span><span class="n">T_trim</span><span class="p">]</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">xh</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">T_trim</span> <span class="o">//</span> <span class="n">factor</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor</span> <span class="o">-</span> <span class="p">(</span><span class="n">T</span> <span class="o">%</span> <span class="n">factor</span><span class="p">))</span> <span class="o">%</span> <span class="n">factor</span>
            <span class="k">if</span> <span class="n">pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pad_tensor</span> <span class="o">=</span> <span class="n">x_high</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">((</span><span class="n">pad</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
                <span class="n">xh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_high</span><span class="p">,</span> <span class="n">pad_tensor</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xh</span> <span class="o">=</span> <span class="n">x_high</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">xh</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">xh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">factor</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">per_feature_aggs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">agg_reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">agg_reduce</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;agg_reduce must be &#39;mean&#39; or &#39;sum&#39;&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_feature_aggs</span><span class="p">)</span> <span class="o">==</span> <span class="n">D</span><span class="p">,</span> <span class="s2">&quot;per_feature_aggs length must match D&quot;</span>
        <span class="n">mean_agg</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sum_agg</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask_sum</span> <span class="o">=</span> <span class="n">x_high</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">per_feature_aggs</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">mask_mean</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">mask_sum</span>
        <span class="k">return</span> <span class="n">mean_agg</span> <span class="o">*</span> <span class="n">mask_mean</span> <span class="o">+</span> <span class="n">sum_agg</span> <span class="o">*</span> <span class="n">mask_sum</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_multi_factor_to_high</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes cumulative factor from branch f to the highest frequency.</span>

<span class="sd">        Args:</span>
<span class="sd">            f (int): Branch index (0 = lowest frequency).</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Product of frequency factors from branch f to highest branch.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If `frequency_factors` is not defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;frequency_factors must be provided.&quot;</span><span class="p">)</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fac</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_factors</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fac</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_from_hourly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_hour</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds multi-frequency inputs from raw hourly features.</span>

<span class="sd">        Each branch selects features based on bucket assignment and aggregates</span>
<span class="sd">        them down to its frequency using frequency factors.</span>

<span class="sd">        Args:</span>
<span class="sd">            x_hour (torch.Tensor): Hourly input tensor (T_h, B, D).</span>
<span class="sd">                - T_h: number of hourly timesteps</span>
<span class="sd">                - B: batch size</span>
<span class="sd">                - D: feature dimension (must match `feature_buckets`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[torch.Tensor]: List of tensors, one per branch,</span>
<span class="sd">            with shapes (T_f, B, D_f).</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If feature dimension mismatches `feature_buckets`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;feature_buckets must be provided&quot;</span>
        <span class="n">T_h</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x_hour</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">D</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span><span class="p">),</span> <span class="s2">&quot;Mismatch between features and buckets&quot;</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_agg_all</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Insert placeholder if branch has no features</span>
                <span class="n">x_sub</span> <span class="o">=</span> <span class="n">x_hour</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">((</span><span class="n">T_h</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">per_aggs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_sub</span> <span class="o">=</span> <span class="n">x_hour</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">cols</span><span class="p">]</span>
                <span class="n">per_aggs</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">per_aggs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>

            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multi_factor_to_high</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">x_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_lowfreq</span><span class="p">(</span>
                <span class="n">x_high</span><span class="o">=</span><span class="n">x_sub</span><span class="p">,</span>
                <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span>
                <span class="n">agg_reduce</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_reduce</span><span class="p">,</span>
                <span class="n">per_feature_aggs</span><span class="o">=</span><span class="n">per_aggs</span><span class="p">,</span>
                <span class="n">truncate_incomplete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">truncate_incomplete</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slice_len_low</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">T_low</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">T_high</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the slice length for a low-frequency branch.</span>

<span class="sd">        This method determines how many timesteps from the low-frequency input</span>
<span class="sd">        should be aligned with the high-frequency branch during state transfer.</span>

<span class="sd">        Priority:</span>
<span class="sd">            1. If `slice_timesteps` is precomputed, return the clamped value.</span>
<span class="sd">            2. Otherwise, fall back to heuristic estimation using ceil/floor.</span>

<span class="sd">        Args:</span>
<span class="sd">            i (int): Index of the low-frequency branch.</span>
<span class="sd">            T_low (int): Sequence length of the low-frequency input.</span>
<span class="sd">            T_high (int): Sequence length of the high-frequency input.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of timesteps to slice from the low-frequency input,</span>
<span class="sd">            clamped between [0, T_low].</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeWarning: If `seq_lengths` and `frequency_factors` are not</span>
<span class="sd">            provided, a warning is issued since the fallback may not perfectly</span>
<span class="sd">            match NeuralHydrology&#39;s fixed slicing definition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_timesteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_timesteps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T_low</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warned_slice_fallback</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_transfer</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;[MTSLSTM]  seq_lengths/frequency_factorsceil/floor&quot;</span>
                <span class="s2">&quot; NeuralHydrology &quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warned_slice_fallback</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_build_lowfreq</span>
            <span class="p">)</span>
            <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T_high</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T_low</span><span class="p">))),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_use_ceil</span><span class="p">:</span>
            <span class="n">slice_len_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">T_high</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_len_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">T_high</span> <span class="o">//</span> <span class="n">factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">slice_len_low</span><span class="p">,</span> <span class="n">T_low</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare and validate input tensors for multi-frequency processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            xs: Input tensors from forward method</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of validated input tensors for each frequency branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#  + feature_buckets</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hourly_unified</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_from_hourly</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1">#  + </span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_build_lowfreq</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">x_high</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">x_high</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; (time,batch,features)&quot;</span>
            <span class="n">x_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_lowfreq</span><span class="p">(</span>
                <span class="n">x_high</span><span class="o">=</span><span class="n">x_high</span><span class="p">,</span>
                <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span><span class="p">,</span>
                <span class="n">agg_reduce</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_reduce</span><span class="p">,</span>
                <span class="n">per_feature_aggs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs</span><span class="p">,</span>
                <span class="n">truncate_incomplete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">truncate_incomplete</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x_low</span><span class="p">,</span> <span class="n">x_high</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate input tensor dimensions and shapes.</span>

<span class="sd">        Args:</span>
<span class="sd">            xs: Input tensors to validate</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If inputs don&#39;t match expected configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">  (time,batch,features)&quot;</span>
            <span class="n">exp_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_input_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">exp_d</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">exp_d</span><span class="si">}</span><span class="s2"> &quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_branch_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">branch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess input for a specific frequency branch.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor for the branch</span>
<span class="sd">            branch_idx: Index of the frequency branch</span>

<span class="sd">        Returns:</span>
<span class="sd">            Preprocessed tensor ready for LSTM processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add frequency one-hot encoding first if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_freq1hot</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_one_hot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">branch_idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_flag</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For non-pretrained mode, apply input linear layer</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_linears</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_branch_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get LSTM and head modules for a specific branch.</span>

<span class="sd">        Args:</span>
<span class="sd">            branch_idx: Index of the frequency branch</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (lstm_module, head_module) for the branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lstm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstms</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>
        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heads</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lstm</span><span class="p">,</span> <span class="n">head</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_transfer_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize hidden and cell states for transfer between branches.</span>

<span class="sd">        Args:</span>
<span class="sd">            device: Device to create tensors on</span>
<span class="sd">            batch_size: Batch size for state tensors</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (h_transfer, c_transfer) initial states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h_transfer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">H0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">c_transfer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">H0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_transfer_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">branch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">h_state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
        <span class="n">c_state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">next_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update transfer states for the next branch.</span>

<span class="sd">        Args:</span>
<span class="sd">            branch_idx: Current branch index</span>
<span class="sd">            h_state: Current hidden state</span>
<span class="sd">            c_state: Current cell state  </span>
<span class="sd">            next_batch_size: Batch size for next branch</span>
<span class="sd">            device: Device for tensor creation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Updated (h_transfer, c_transfer) for next branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">branch_idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h_state</span><span class="p">,</span> <span class="n">c_state</span>

        <span class="n">Hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">branch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">h_transfer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_batch_size</span><span class="p">,</span> <span class="n">Hn</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">c_transfer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_batch_size</span><span class="p">,</span> <span class="n">Hn</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_h</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">](</span><span class="n">h_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_c</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">](</span><span class="n">c_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_branch_with_slice_transfer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_i</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">branch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">xs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">lstm</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span>
        <span class="n">head</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span>
        <span class="n">h_transfer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">c_transfer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a branch with slice transfer enabled.</span>

<span class="sd">        Args:</span>
<span class="sd">            x_i: Input tensor for current branch</span>
<span class="sd">            branch_idx: Index of current branch</span>
<span class="sd">            xs: All input tensors</span>
<span class="sd">            lstm: LSTM module for current branch</span>
<span class="sd">            head: Head module for current branch</span>
<span class="sd">            h_transfer: Transfer hidden state</span>
<span class="sd">            c_transfer: Transfer cell state</span>
<span class="sd">            device: Device for tensor operations</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (output, final_h_state, final_c_state)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T_low</span> <span class="o">=</span> <span class="n">x_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_high</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">branch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slice_len_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slice_len_low</span><span class="p">(</span><span class="n">branch_idx</span><span class="p">,</span> <span class="n">T_low</span><span class="o">=</span><span class="n">T_low</span><span class="p">,</span> <span class="n">T_high</span><span class="o">=</span><span class="n">T_high</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slice_len_low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_lstm</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">lstm</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Process first part</span>
            <span class="n">x_part1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">x_i</span><span class="p">[:</span><span class="o">-</span><span class="n">slice_len_low</span><span class="p">]</span> <span class="k">if</span> <span class="n">slice_len_low</span> <span class="o">&lt;</span> <span class="n">x_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">x_i</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">x_part1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y1</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_lstm</span><span class="p">(</span><span class="n">x_part1</span><span class="p">,</span> <span class="n">lstm</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">x_i</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">))</span>
                <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span>

            <span class="c1"># Process second part</span>
            <span class="n">x_part2</span> <span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="o">-</span><span class="n">slice_len_low</span><span class="p">:]</span> <span class="k">if</span> <span class="n">slice_len_low</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x_i</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x_part2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y2</span><span class="p">,</span> <span class="n">h_final</span><span class="p">,</span> <span class="n">c_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_lstm</span><span class="p">(</span><span class="n">x_part2</span><span class="p">,</span> <span class="n">lstm</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
                <span class="n">y_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_all</span> <span class="o">=</span> <span class="n">y1</span>
                <span class="n">h_final</span><span class="p">,</span> <span class="n">c_final</span> <span class="o">=</span> <span class="n">h1</span><span class="p">,</span> <span class="n">c1</span>

            <span class="k">return</span> <span class="n">y_all</span><span class="p">,</span> <span class="n">h_final</span><span class="p">,</span> <span class="n">c_final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_branch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">branch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">xs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">h_transfer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">c_transfer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single frequency branch.</span>

<span class="sd">        Args:</span>
<span class="sd">            branch_idx: Index of the branch to process</span>
<span class="sd">            xs: All input tensors</span>
<span class="sd">            h_transfer: Transfer hidden state</span>
<span class="sd">            c_transfer: Transfer cell state</span>
<span class="sd">            device: Device for tensor operations</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (branch_output, final_h_state, final_c_state)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preprocess input</span>
        <span class="n">x_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_branch_input</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">],</span> <span class="n">branch_idx</span><span class="p">)</span>

        <span class="c1"># Get branch modules</span>
        <span class="n">lstm_i</span><span class="p">,</span> <span class="n">head_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_branch_modules</span><span class="p">(</span><span class="n">branch_idx</span><span class="p">)</span>

        <span class="c1"># Process with or without slice transfer</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">branch_idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_transfer</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_branch_with_slice_transfer</span><span class="p">(</span>
                <span class="n">x_i</span><span class="p">,</span> <span class="n">branch_idx</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">lstm_i</span><span class="p">,</span> <span class="n">head_i</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">,</span> <span class="n">device</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_lstm</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">lstm_i</span><span class="p">,</span> <span class="n">head_i</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">return_all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass of the Multi-Time-Scale LSTM (MTSLSTM).</span>

<span class="sd">        This method supports three types of input pipelines:</span>

<span class="sd">        1. New unified hourly input (recommended):</span>
<span class="sd">            - Pass a single hourly tensor (T, B, D).</span>
<span class="sd">            - Requires `feature_buckets` set in the constructor.</span>
<span class="sd">            - Internally calls `_build_from_hourly()` to build multi-scale inputs.</span>

<span class="sd">        2. Legacy path A (two-frequency auto build):</span>
<span class="sd">            - Pass a single high-frequency tensor (daily).</span>
<span class="sd">            - Requires `auto_build_lowfreq=True` and `nf=2`.</span>
<span class="sd">            - Automatically constructs the low-frequency branch.</span>

<span class="sd">        3. Legacy path B (manual multi-frequency input):</span>
<span class="sd">            - Pass a tuple of tensors: (x_f0, x_f1, ..., x_f{nf-1}).</span>

<span class="sd">        Args:</span>
<span class="sd">            *xs (torch.Tensor): Input tensors. Can be:</span>
<span class="sd">                - One hourly tensor of shape (T, B, D).</span>
<span class="sd">                - One daily tensor (legacy auto-build).</span>
<span class="sd">                - A tuple of nf tensors, each shaped (T_f, B, D_f).</span>
<span class="sd">            return_all (Optional[bool], default=None): Whether to return outputs</span>
<span class="sd">                from all frequency branches. If None, uses the class default.</span>
<span class="sd">            **kwargs: Additional unused keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, torch.Tensor] | torch.Tensor:</span>
<span class="sd">                - If `return_all=True`: Dictionary mapping branch names to outputs,</span>
<span class="sd">                  e.g. {&quot;f0&quot;: y_low, &quot;f1&quot;: y_mid, &quot;f2&quot;: y_high}.</span>
<span class="sd">                - If `return_all=False`: Only returns the highest-frequency output</span>
<span class="sd">                  tensor of shape (T_high, B, output_size).</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If the number of provided inputs does not match `nf`,</span>
<span class="sd">                or if input feature dimensions do not match the expected</span>
<span class="sd">                configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_all</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_all_default</span>

        <span class="c1"># Prepare and validate inputs</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_inputs</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

        <span class="c1"># Initialize processing state</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_transfer_states</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Process each frequency branch</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
            <span class="n">y_i</span><span class="p">,</span> <span class="n">h_i</span><span class="p">,</span> <span class="n">c_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_branch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_i</span>

            <span class="c1"># Update transfer states for next branch</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">next_batch_size</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_transfer_states</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">h_i</span><span class="p">,</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">next_batch_size</span><span class="p">,</span> <span class="n">device</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">return_all</span> <span class="k">else</span> <span class="n">outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.mtslstm.MTSLSTM.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_sizes</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_mtslstm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transfer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_freq_one_hot_if_shared</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">build_factor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">agg_reduce</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">per_feature_aggs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncate_incomplete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slice_transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slice_use_ceil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seq_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frequency_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_buckets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">per_feature_aggs_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">down_aggregate_all_to_each_branch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pretrained_day_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretrained_lstm_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretrained_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linear1_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear2_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.mtslstm.MTSLSTM.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Initializes an MTSLSTM model.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>input_sizes</code></td>
        <td><code>Union[int, List[int]]</code></td>
        <td><p>Input feature dimension(s). Can be:
* int: shared across all frequency branches
* list: per-frequency input sizes
* None: inferred from <code>feature_buckets</code></p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>hidden_sizes</code></td>
        <td><code>Union[int, List[int]]</code></td>
        <td><p>Hidden dimension(s) for each LSTM branch.</p></td>
        <td><code>128</code></td>
      </tr>
      <tr>
        <td><code>output_size</code></td>
        <td><code>int</code></td>
        <td><p>Output dimension per timestep.</p></td>
        <td><code>1</code></td>
      </tr>
      <tr>
        <td><code>shared_mtslstm</code></td>
        <td><code>bool</code></td>
        <td><p>If True, all frequency branches share one LSTM.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>transfer</code></td>
        <td><code>Union[NoneType, str, Dict[str, Optional[Literal[&#39;identity&#39;, &#39;linear&#39;]]]]</code></td>
        <td><p>Hidden state transfer mode between frequencies.
* None: no transfer
* "identity": copy states directly (same dim required)
* "linear": learn linear projection between dims</p></td>
        <td><code>&#39;linear&#39;</code></td>
      </tr>
      <tr>
        <td><code>dropout</code></td>
        <td><code>float</code></td>
        <td><p>Dropout probability applied before heads.</p></td>
        <td><code>0.0</code></td>
      </tr>
      <tr>
        <td><code>return_all</code></td>
        <td><code>bool</code></td>
        <td><p>If True, return all branch outputs (dict f0,f1,...).
If False, return only the highest-frequency output.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>add_freq_one_hot_if_shared</code></td>
        <td><code>bool</code></td>
        <td><p>If True and <code>shared_mtslstm=True</code>,
append frequency one-hot encoding to inputs.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>auto_build_lowfreq</code></td>
        <td><code>bool</code></td>
        <td><p>Legacy 2-frequency path (high-&gt;low).</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>build_factor</code></td>
        <td><code>int</code></td>
        <td><p>Aggregation factor for auto low-frequency.</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>agg_reduce</code></td>
        <td><code>Literal[&#39;mean&#39;, &#39;sum&#39;]</code></td>
        <td><p>Aggregation method for downsampling ("mean" or "sum").</p></td>
        <td><code>&#39;mean&#39;</code></td>
      </tr>
      <tr>
        <td><code>per_feature_aggs</code></td>
        <td><code>Optional[List[Literal[&#39;mean&#39;, &#39;sum&#39;]]]</code></td>
        <td><p>Optional list of per-feature aggregation methods.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>truncate_incomplete</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to drop remainder timesteps when
aggregating (vs. zero-padding).</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>slice_transfer</code></td>
        <td><code>bool</code></td>
        <td><p>If True, transfer LSTM states at slice boundaries
computed by seq_lengths  frequency_factors.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>slice_use_ceil</code></td>
        <td><code>bool</code></td>
        <td><p>If True, use ceil for slice length calculation.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>seq_lengths</code></td>
        <td><code>Optional[List[int]]</code></td>
        <td><p>Per-frequency sequence lengths [low, ..., high].</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>frequency_factors</code></td>
        <td><code>Optional[List[int]]</code></td>
        <td><p>Multipliers between adjacent frequencies.
Example: [7,24] means week-&gt;day 7, day-&gt;hour 24.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>feature_buckets</code></td>
        <td><code>Optional[List[int]]</code></td>
        <td><p>Per-feature frequency assignment (len = D).
0 = lowest (week), nf-1 = highest (hour).</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>per_feature_aggs_map</code></td>
        <td><code>Optional[List[Literal[&#39;mean&#39;, &#39;sum&#39;]]]</code></td>
        <td><p>Per-feature aggregation method ("mean"/"sum").</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>down_aggregate_all_to_each_branch</code></td>
        <td><code>bool</code></td>
        <td><p>If True, branch f includes all
features with bucket &gt;= f (down-aggregate); else only == f.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>pretrained_day_path</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>Optional path to pretrained checkpoint. If set,
loads weights for the daily (f1) LSTM and head.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>AssertionError</code></td>
        <td><p>If configuration is inconsistent.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/mtslstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_sizes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_sizes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
    <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">shared_mtslstm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">transfer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">]]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">return_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_freq_one_hot_if_shared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">auto_build_lowfreq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">build_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">agg_reduce</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">per_feature_aggs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">truncate_incomplete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">slice_transfer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">slice_use_ceil</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">seq_lengths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frequency_factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">feature_buckets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">per_feature_aggs_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">down_aggregate_all_to_each_branch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">pretrained_day_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pretrained_lstm_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pretrained_head_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pretrained_flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">linear1_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">linear2_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes an MTSLSTM model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_sizes: Input feature dimension(s). Can be:</span>
<span class="sd">            * int: shared across all frequency branches</span>
<span class="sd">            * list: per-frequency input sizes</span>
<span class="sd">            * None: inferred from `feature_buckets`</span>
<span class="sd">        hidden_sizes: Hidden dimension(s) for each LSTM branch.</span>
<span class="sd">        output_size: Output dimension per timestep.</span>
<span class="sd">        shared_mtslstm: If True, all frequency branches share one LSTM.</span>
<span class="sd">        transfer: Hidden state transfer mode between frequencies.</span>
<span class="sd">            * None: no transfer</span>
<span class="sd">            * &quot;identity&quot;: copy states directly (same dim required)</span>
<span class="sd">            * &quot;linear&quot;: learn linear projection between dims</span>
<span class="sd">        dropout: Dropout probability applied before heads.</span>
<span class="sd">        return_all: If True, return all branch outputs (dict f0,f1,...).</span>
<span class="sd">            If False, return only the highest-frequency output.</span>
<span class="sd">        add_freq_one_hot_if_shared: If True and `shared_mtslstm=True`,</span>
<span class="sd">            append frequency one-hot encoding to inputs.</span>
<span class="sd">        auto_build_lowfreq: Legacy 2-frequency path (high-&gt;low).</span>
<span class="sd">        build_factor: Aggregation factor for auto low-frequency.</span>
<span class="sd">        agg_reduce: Aggregation method for downsampling (&quot;mean&quot; or &quot;sum&quot;).</span>
<span class="sd">        per_feature_aggs: Optional list of per-feature aggregation methods.</span>
<span class="sd">        truncate_incomplete: Whether to drop remainder timesteps when</span>
<span class="sd">            aggregating (vs. zero-padding).</span>
<span class="sd">        slice_transfer: If True, transfer LSTM states at slice boundaries</span>
<span class="sd">            computed by seq_lengths  frequency_factors.</span>
<span class="sd">        slice_use_ceil: If True, use ceil for slice length calculation.</span>
<span class="sd">        seq_lengths: Per-frequency sequence lengths [low, ..., high].</span>
<span class="sd">        frequency_factors: Multipliers between adjacent frequencies.</span>
<span class="sd">            Example: [7,24] means week-&gt;day 7, day-&gt;hour 24.</span>
<span class="sd">        feature_buckets: Per-feature frequency assignment (len = D).</span>
<span class="sd">            0 = lowest (week), nf-1 = highest (hour).</span>
<span class="sd">        per_feature_aggs_map: Per-feature aggregation method (&quot;mean&quot;/&quot;sum&quot;).</span>
<span class="sd">        down_aggregate_all_to_each_branch: If True, branch f includes all</span>
<span class="sd">            features with bucket &gt;= f (down-aggregate); else only == f.</span>
<span class="sd">        pretrained_day_path: Optional path to pretrained checkpoint. If set,</span>
<span class="sd">            loads weights for the daily (f1) LSTM and head.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If configuration is inconsistent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># Store configuration parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_day_path</span> <span class="o">=</span> <span class="n">pretrained_day_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_flag</span> <span class="o">=</span> <span class="n">pretrained_flag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear1_size</span> <span class="o">=</span> <span class="n">linear1_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear2_size</span> <span class="o">=</span> <span class="n">linear2_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared_mtslstm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">return_all_default</span> <span class="o">=</span> <span class="n">return_all</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">per_feature_aggs_map</span><span class="p">)</span> <span class="k">if</span> <span class="n">per_feature_aggs_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">down_agg_all</span> <span class="o">=</span> <span class="n">down_aggregate_all_to_each_branch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auto_build_lowfreq</span> <span class="o">=</span> <span class="n">auto_build_lowfreq</span>

    <span class="c1"># Aggregation and slicing parameters</span>
    <span class="k">assert</span> <span class="n">build_factor</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;build_factor must be &gt;=2&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">build_factor</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">agg_reduce</span> <span class="o">=</span> <span class="n">agg_reduce</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">per_feature_aggs</span> <span class="o">=</span> <span class="n">per_feature_aggs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">truncate_incomplete</span> <span class="o">=</span> <span class="n">truncate_incomplete</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slice_transfer</span> <span class="o">=</span> <span class="n">slice_transfer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slice_use_ceil</span> <span class="o">=</span> <span class="n">slice_use_ceil</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seq_lengths</span><span class="p">)</span> <span class="k">if</span> <span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_warned_slice_fallback</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Setup frequency configuration</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frequency_config</span><span class="p">(</span><span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">)</span>

    <span class="c1"># Validate seq_lengths</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_lengths</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="s2">&quot;seq_lengths length must match nf&quot;</span>

    <span class="c1"># Setup input sizes for each branch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_input_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_input_sizes</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span><span class="p">,</span> <span class="n">input_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_agg_all</span>
    <span class="p">)</span>

    <span class="c1"># Setup hidden layer sizes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">hidden_sizes</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="s2">&quot;hidden_sizes length mismatch&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">)</span>

    <span class="c1"># Setup frequency one-hot encoding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_freq1hot</span> <span class="o">=</span> <span class="n">add_freq_one_hot_if_shared</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span>

    <span class="c1"># Setup transfer configuration</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_transfer_config</span><span class="p">(</span><span class="n">transfer</span><span class="p">)</span>

    <span class="c1"># Setup frequency factors and slice timesteps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frequency_factors</span><span class="p">(</span><span class="n">frequency_factors</span><span class="p">,</span> <span class="n">auto_build_lowfreq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_factor</span><span class="p">)</span>

    <span class="c1"># Calculate effective input sizes (including one-hot if needed)</span>
    <span class="n">eff_input_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_input_sizes</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_freq1hot</span><span class="p">:</span>
        <span class="n">eff_input_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">eff_input_sizes</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shared_mtslstm=True requires equal input sizes.&quot;</span><span class="p">)</span>

    <span class="c1"># Create model layers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_model_layers</span><span class="p">(</span><span class="n">eff_input_sizes</span><span class="p">)</span>

    <span class="c1"># Create transfer layers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_transfer_layers</span><span class="p">()</span>

    <span class="c1"># Setup dropout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

    <span class="c1"># Set unified hourly aggregation flag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_hourly_unified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buckets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Load pretrained weights if specified</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_load_pretrained_weights</span><span class="p">(</span><span class="n">pretrained_lstm_prefix</span><span class="p">,</span> <span class="n">pretrained_head_prefix</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.mtslstm.MTSLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#torchhydro.models.mtslstm.MTSLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass of the Multi-Time-Scale LSTM (MTSLSTM).</p>
<p>This method supports three types of input pipelines:</p>
<ol>
<li>
<p>New unified hourly input (recommended):</p>
<ul>
<li>Pass a single hourly tensor (T, B, D).</li>
<li>Requires <code>feature_buckets</code> set in the constructor.</li>
<li>Internally calls <code>_build_from_hourly()</code> to build multi-scale inputs.</li>
</ul>
</li>
<li>
<p>Legacy path A (two-frequency auto build):</p>
<ul>
<li>Pass a single high-frequency tensor (daily).</li>
<li>Requires <code>auto_build_lowfreq=True</code> and <code>nf=2</code>.</li>
<li>Automatically constructs the low-frequency branch.</li>
</ul>
</li>
<li>
<p>Legacy path B (manual multi-frequency input):</p>
<ul>
<li>Pass a tuple of tensors: (x_f0, x_f1, ..., x_f{nf-1}).</li>
</ul>
</li>
</ol>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>*xs</code></td>
        <td><code>torch.Tensor</code></td>
        <td><p>Input tensors. Can be:
- One hourly tensor of shape (T, B, D).
- One daily tensor (legacy auto-build).
- A tuple of nf tensors, each shaped (T_f, B, D_f).</p></td>
        <td><code>()</code></td>
      </tr>
      <tr>
        <td><code>return_all</code></td>
        <td><code>Optional[bool], default=None</code></td>
        <td><p>Whether to return outputs
from all frequency branches. If None, uses the class default.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>**kwargs</code></td>
        <td><code>Any</code></td>
        <td><p>Additional unused keyword arguments.</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, torch.Tensor] | torch.Tensor</code></td>
      <td><ul>
<li>If <code>return_all=True</code>: Dictionary mapping branch names to outputs,
      e.g. {"f0": y_low, "f1": y_mid, "f2": y_high}.<ul>
<li>If <code>return_all=False</code>: Only returns the highest-frequency output
  tensor of shape (T_high, B, output_size).</li>
</ul>
</li>
</ul></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>AssertionError</code></td>
        <td><p>If the number of provided inputs does not match <code>nf</code>,
or if input feature dimensions do not match the expected
configuration.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/mtslstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">return_all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass of the Multi-Time-Scale LSTM (MTSLSTM).</span>

<span class="sd">    This method supports three types of input pipelines:</span>

<span class="sd">    1. New unified hourly input (recommended):</span>
<span class="sd">        - Pass a single hourly tensor (T, B, D).</span>
<span class="sd">        - Requires `feature_buckets` set in the constructor.</span>
<span class="sd">        - Internally calls `_build_from_hourly()` to build multi-scale inputs.</span>

<span class="sd">    2. Legacy path A (two-frequency auto build):</span>
<span class="sd">        - Pass a single high-frequency tensor (daily).</span>
<span class="sd">        - Requires `auto_build_lowfreq=True` and `nf=2`.</span>
<span class="sd">        - Automatically constructs the low-frequency branch.</span>

<span class="sd">    3. Legacy path B (manual multi-frequency input):</span>
<span class="sd">        - Pass a tuple of tensors: (x_f0, x_f1, ..., x_f{nf-1}).</span>

<span class="sd">    Args:</span>
<span class="sd">        *xs (torch.Tensor): Input tensors. Can be:</span>
<span class="sd">            - One hourly tensor of shape (T, B, D).</span>
<span class="sd">            - One daily tensor (legacy auto-build).</span>
<span class="sd">            - A tuple of nf tensors, each shaped (T_f, B, D_f).</span>
<span class="sd">        return_all (Optional[bool], default=None): Whether to return outputs</span>
<span class="sd">            from all frequency branches. If None, uses the class default.</span>
<span class="sd">        **kwargs: Additional unused keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, torch.Tensor] | torch.Tensor:</span>
<span class="sd">            - If `return_all=True`: Dictionary mapping branch names to outputs,</span>
<span class="sd">              e.g. {&quot;f0&quot;: y_low, &quot;f1&quot;: y_mid, &quot;f2&quot;: y_high}.</span>
<span class="sd">            - If `return_all=False`: Only returns the highest-frequency output</span>
<span class="sd">              tensor of shape (T_high, B, output_size).</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If the number of provided inputs does not match `nf`,</span>
<span class="sd">            or if input feature dimensions do not match the expected</span>
<span class="sd">            configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">return_all</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">return_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_all_default</span>

    <span class="c1"># Prepare and validate inputs</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_inputs</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

    <span class="c1"># Initialize processing state</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_transfer_states</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process each frequency branch</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">):</span>
        <span class="n">y_i</span><span class="p">,</span> <span class="n">h_i</span><span class="p">,</span> <span class="n">c_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_branch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_i</span>

        <span class="c1"># Update transfer states for next branch</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_batch_size</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">h_transfer</span><span class="p">,</span> <span class="n">c_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_transfer_states</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">h_i</span><span class="p">,</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">next_batch_size</span><span class="p">,</span> <span class="n">device</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">return_all</span> <span class="k">else</span> <span class="n">outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.seq2seq" class="doc doc-heading">
        <code>seq2seq</code>



<a href="#torchhydro.models.seq2seq" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2024-04-17 12:32:26
LastEditTime: 2024-11-05 19:10:02
LastEditors: Wenyu Ouyang
Description:
FilePath:       orchhydro       orchhydro\models\seq2seq.py
Copyright (c) 2021-2024 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.AdditiveAttention" class="doc doc-heading">
        <code>
AdditiveAttention            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.AdditiveAttention" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdditiveAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AdditiveAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hidden_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">encoder_outputs_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">encoder_outputs</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">hidden_transformed</span> <span class="o">+</span> <span class="n">encoder_outputs_transformed</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.AdditiveAttention.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.AdditiveAttention.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hidden_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">encoder_outputs_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">encoder_outputs</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">hidden_transformed</span> <span class="o">+</span> <span class="n">encoder_outputs_transformed</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.Attention" class="doc doc-heading">
        <code>
Attention            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.Attention" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Attention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Attention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">hidden</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.Attention.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.Attention.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">hidden</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.DataEnhancedModel" class="doc doc-heading">
        <code>
DataEnhancedModel            (<a class="autorefs autorefs-internal" title="
GeneralSeq2Seq            (Module)
         (torchhydro.models.seq2seq.GeneralSeq2Seq)" href="#torchhydro.models.seq2seq.GeneralSeq2Seq">GeneralSeq2Seq</a>)
        </code>



<a href="#torchhydro.models.seq2seq.DataEnhancedModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataEnhancedModel</span><span class="p">(</span><span class="n">GeneralSeq2Seq</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_length</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataEnhancedModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_length</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_length</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
        <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">src</span>
        <span class="n">processed_src1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out_src1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">processed_src1</span><span class="p">)</span>
        <span class="n">out_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">out_src1</span><span class="p">)</span>
        <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">out_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataEnhancedModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">combined_input</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.DataEnhancedModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.DataEnhancedModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
    <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">src</span>
    <span class="n">processed_src1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">out_src1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">processed_src1</span><span class="p">)</span>
    <span class="n">out_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">out_src1</span><span class="p">)</span>
    <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">out_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataEnhancedModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">combined_input</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.DataFusionModel" class="doc doc-heading">
        <code>
DataFusionModel            (<a class="autorefs autorefs-internal" title="
DataEnhancedModel            (GeneralSeq2Seq)
         (torchhydro.models.seq2seq.DataEnhancedModel)" href="#torchhydro.models.seq2seq.DataEnhancedModel">DataEnhancedModel</a>)
        </code>



<a href="#torchhydro.models.seq2seq.DataFusionModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataFusionModel</span><span class="p">(</span><span class="n">DataEnhancedModel</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataFusionModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
        <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">src</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">processed_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layer</span><span class="p">(</span>
                <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">processed_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processed_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layer</span><span class="p">(</span>
                <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">processed_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataFusionModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">combined_input</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.DataFusionModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.DataFusionModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
    <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">src</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">processed_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layer</span><span class="p">(</span>
            <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">processed_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">processed_src1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layer</span><span class="p">(</span>
            <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">combined_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">processed_src1</span><span class="p">,</span> <span class="n">src1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataFusionModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">combined_input</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.Decoder" class="doc doc-heading">
        <code>
Decoder            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.Decoder" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">output_</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">))</span>
        <span class="n">output_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">output_</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_out</span><span class="p">(</span><span class="n">output_dr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.Decoder.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.Decoder.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">output_</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">))</span>
    <span class="n">output_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">output_</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_out</span><span class="p">(</span><span class="n">output_dr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.DotProductAttention" class="doc doc-heading">
        <code>
DotProductAttention            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.DotProductAttention" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DotProductAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DotProductAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">hidden_expanded</span> <span class="o">=</span> <span class="n">hidden</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span>
            <span class="n">hidden_expanded</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
        <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">attention_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attention_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attention_weights</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.DotProductAttention.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.DotProductAttention.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
    <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">hidden_expanded</span> <span class="o">=</span> <span class="n">hidden</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span>
        <span class="n">hidden_expanded</span><span class="p">,</span> <span class="n">encoder_outputs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
    <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">attention_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attention_weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attention_weights</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.Encoder" class="doc doc-heading">
        <code>
Encoder            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.Encoder" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># a nonlinear layer to transform the input</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="c1"># the LSTM layer</span>
        <span class="n">outputs_</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="c1"># a dropout layer</span>
        <span class="n">dr_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">outputs_</span><span class="p">)</span>
        <span class="c1"># final linear layer</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">dr_outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.Encoder.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.Encoder.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># a nonlinear layer to transform the input</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_relu</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="c1"># the LSTM layer</span>
    <span class="n">outputs_</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="c1"># a dropout layer</span>
    <span class="n">dr_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">outputs_</span><span class="p">)</span>
    <span class="c1"># final linear layer</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">dr_outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.GeneralSeq2Seq" class="doc doc-heading">
        <code>
GeneralSeq2Seq            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.GeneralSeq2Seq" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeneralSeq2Seq</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">en_input_size</span><span class="p">,</span>
        <span class="n">de_input_size</span><span class="p">,</span>
        <span class="n">output_size</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">forecast_length</span><span class="p">,</span>
        <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">teacher_forcing_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;General Seq2Seq model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        en_input_size : _type_</span>
<span class="sd">            the size of the input of the encoder</span>
<span class="sd">        de_input_size : _type_</span>
<span class="sd">            the size of the input of the decoder</span>
<span class="sd">        output_size : _type_</span>
<span class="sd">            the size of the output, same for encoder and decoder</span>
<span class="sd">        hidden_size : _type_</span>
<span class="sd">            the size of the hidden state of LSTMs</span>
<span class="sd">        forecast_length : _type_</span>
<span class="sd">            the length of the forecast, i.e., the periods of decoder outputs</span>
<span class="sd">        hindcast_output_window : int, optional</span>
<span class="sd">            the encoder&#39;s final several outputs in the final output;</span>
<span class="sd">            default is 0 which means no encoder output is included in the final output;</span>
<span class="sd">        teacher_forcing_ratio : float, optional</span>
<span class="sd">            the probability of using teacher forcing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeneralSeq2Seq</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span> <span class="o">=</span> <span class="n">forecast_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">=</span> <span class="n">hindcast_output_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span> <span class="o">=</span> <span class="n">teacher_forcing_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">en_input_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">output_size</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">de_input_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">output_size</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">StateTransferNetwork</span><span class="p">(</span><span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_teacher_forcing_preparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trgs</span><span class="p">):</span>
        <span class="c1"># teacher forcing preparation</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trgs</span><span class="p">)</span>
        <span class="n">random_vals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">random_vals</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">valid_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">encoder_input</span><span class="p">,</span> <span class="n">decoder_input</span><span class="p">,</span> <span class="n">trgs</span> <span class="o">=</span> <span class="n">src</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoder_input</span><span class="p">,</span> <span class="n">decoder_input</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="o">.</span><span class="n">device</span>
            <span class="n">trgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">,</span>  <span class="c1"># seq</span>
                    <span class="n">decoder_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># batch_size</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span>  <span class="c1"># features</span>
                <span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">trgs_q</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">trgs_s</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">trgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">trgs_s</span><span class="p">,</span> <span class="n">trgs_q</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># sq</span>
        <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">encoder_input</span><span class="p">)</span>  <span class="c1"># sq</span>
        <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">decoder_input</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">use_teacher_forcing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher_forcing_preparation</span><span class="p">(</span><span class="n">trgs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">):</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># sq</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
            <span class="n">safe_obs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="n">obs</span><span class="p">)</span>
            <span class="n">prev_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>  <span class="c1"># sq</span>
                <span class="n">use_teacher_forcing</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">safe_obs</span><span class="p">,</span>
                <span class="n">prev_output</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">current_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pc</span><span class="p">,</span> <span class="n">prev_output</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># pcsq</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">current_input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prec_outputs</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">prec_outputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">outputs_s</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">outputs_q</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">outputs_q</span><span class="p">,</span> <span class="n">outputs_s</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># qs</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.GeneralSeq2Seq.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">en_input_size</span><span class="p">,</span> <span class="n">de_input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">forecast_length</span><span class="p">,</span> <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">teacher_forcing_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>General Seq2Seq model</p>
<h6 id="torchhydro.models.seq2seq.GeneralSeq2Seq.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.seq2seq.GeneralSeq2Seq.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>en_input_size : <em>type</em>
    the size of the input of the encoder
de_input_size : <em>type</em>
    the size of the input of the decoder
output_size : <em>type</em>
    the size of the output, same for encoder and decoder
hidden_size : <em>type</em>
    the size of the hidden state of LSTMs
forecast_length : <em>type</em>
    the length of the forecast, i.e., the periods of decoder outputs
hindcast_output_window : int, optional
    the encoder's final several outputs in the final output;
    default is 0 which means no encoder output is included in the final output;
teacher_forcing_ratio : float, optional
    the probability of using teacher forcing</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">en_input_size</span><span class="p">,</span>
    <span class="n">de_input_size</span><span class="p">,</span>
    <span class="n">output_size</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">,</span>
    <span class="n">forecast_length</span><span class="p">,</span>
    <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">teacher_forcing_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;General Seq2Seq model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    en_input_size : _type_</span>
<span class="sd">        the size of the input of the encoder</span>
<span class="sd">    de_input_size : _type_</span>
<span class="sd">        the size of the input of the decoder</span>
<span class="sd">    output_size : _type_</span>
<span class="sd">        the size of the output, same for encoder and decoder</span>
<span class="sd">    hidden_size : _type_</span>
<span class="sd">        the size of the hidden state of LSTMs</span>
<span class="sd">    forecast_length : _type_</span>
<span class="sd">        the length of the forecast, i.e., the periods of decoder outputs</span>
<span class="sd">    hindcast_output_window : int, optional</span>
<span class="sd">        the encoder&#39;s final several outputs in the final output;</span>
<span class="sd">        default is 0 which means no encoder output is included in the final output;</span>
<span class="sd">    teacher_forcing_ratio : float, optional</span>
<span class="sd">        the probability of using teacher forcing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">GeneralSeq2Seq</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span> <span class="o">=</span> <span class="n">forecast_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">=</span> <span class="n">hindcast_output_window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span> <span class="o">=</span> <span class="n">teacher_forcing_ratio</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">en_input_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">output_size</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">de_input_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">output_size</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">StateTransferNetwork</span><span class="p">(</span><span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.GeneralSeq2Seq.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.GeneralSeq2Seq.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">encoder_input</span><span class="p">,</span> <span class="n">decoder_input</span><span class="p">,</span> <span class="n">trgs</span> <span class="o">=</span> <span class="n">src</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoder_input</span><span class="p">,</span> <span class="n">decoder_input</span> <span class="o">=</span> <span class="n">src</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="o">.</span><span class="n">device</span>
        <span class="n">trgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">,</span>  <span class="c1"># seq</span>
                <span class="n">decoder_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># batch_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span>  <span class="c1"># features</span>
            <span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">trgs_q</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">trgs_s</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">trgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">trgs_s</span><span class="p">,</span> <span class="n">trgs_q</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># sq</span>
    <span class="n">encoder_outputs</span><span class="p">,</span> <span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">encoder_input</span><span class="p">)</span>  <span class="c1"># sq</span>
    <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">hidden_</span><span class="p">,</span> <span class="n">cell_</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prev_output</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
        <span class="n">decoder_input</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span>
    <span class="n">use_teacher_forcing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher_forcing_preparation</span><span class="p">(</span><span class="n">trgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trg_len</span><span class="p">):</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">decoder_input</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># sq</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">trgs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
        <span class="n">safe_obs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="n">obs</span><span class="p">)</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>  <span class="c1"># sq</span>
            <span class="n">use_teacher_forcing</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="n">safe_obs</span><span class="p">,</span>
            <span class="n">prev_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">current_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pc</span><span class="p">,</span> <span class="n">prev_output</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># pcsq</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">current_input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sq</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">prec_outputs</span> <span class="o">=</span> <span class="n">encoder_outputs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">prec_outputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outputs_s</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">outputs_q</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">outputs_q</span><span class="p">,</span> <span class="n">outputs_s</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># qs</span>
    <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.StateTransferNetwork" class="doc doc-heading">
        <code>
StateTransferNetwork            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.StateTransferNetwork" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateTransferNetwork</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StateTransferNetwork</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_hidden</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_cell</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="n">transfer_hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_hidden</span><span class="p">(</span><span class="n">hidden</span><span class="p">))</span>
        <span class="n">transfer_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transfer_hidden</span><span class="p">,</span> <span class="n">transfer_cell</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.StateTransferNetwork.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.StateTransferNetwork.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
    <span class="n">transfer_hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_hidden</span><span class="p">(</span><span class="n">hidden</span><span class="p">))</span>
    <span class="n">transfer_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transfer_hidden</span><span class="p">,</span> <span class="n">transfer_cell</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seq2seq.Transformer" class="doc doc-heading">
        <code>
Transformer            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seq2seq.Transformer" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Transformer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_encoder_inputs</span><span class="p">,</span>
        <span class="n">n_decoder_inputs</span><span class="p">,</span>
        <span class="n">n_decoder_output</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">num_embeddings</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
        <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TODO: hindcast_output_window seems not used</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_encoder_inputs : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        n_decoder_inputs : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        n_decoder_output : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        channels : int, optional</span>
<span class="sd">            _description_, by default 256</span>
<span class="sd">        num_embeddings : int, optional</span>
<span class="sd">            _description_, by default 512</span>
<span class="sd">        nhead : int, optional</span>
<span class="sd">            _description_, by default 8</span>
<span class="sd">        num_layers : int, optional</span>
<span class="sd">            _description_, by default 8</span>
<span class="sd">        dropout : float, optional</span>
<span class="sd">            _description_, by default 0.1</span>
<span class="sd">        hindcast_output_window : int, optional</span>
<span class="sd">            _description_, by default 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_pos_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>

        <span class="n">encoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">nhead</span><span class="o">=</span><span class="n">nhead</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">channels</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">decoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoderLayer</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">nhead</span><span class="o">=</span><span class="n">nhead</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">channels</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">encoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoder</span><span class="p">(</span><span class="n">decoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_encoder_inputs</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_decoder_inputs</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">n_decoder_output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encode_src</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="n">src_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_projection</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="n">in_sequence_len</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">src_start</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">src_start</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pos_encoder</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_sequence_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">pos_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_pos_embedding</span><span class="p">(</span><span class="n">pos_encoder</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">src_start</span> <span class="o">+</span> <span class="n">pos_encoder</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">+</span> <span class="n">src_start</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">src</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decode_trg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trg</span><span class="p">,</span> <span class="n">memory</span><span class="p">):</span>
        <span class="n">trg_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_projection</span><span class="p">(</span><span class="n">trg</span><span class="p">)</span>

        <span class="n">out_sequence_len</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">trg_start</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trg_start</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pos_decoder</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_sequence_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">pos_decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_pos_embedding</span><span class="p">(</span><span class="n">pos_decoder</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">trg</span> <span class="o">=</span> <span class="n">pos_decoder</span> <span class="o">+</span> <span class="n">trg_start</span>
        <span class="n">trg_mask</span> <span class="o">=</span> <span class="n">gen_trg_mask</span><span class="p">(</span><span class="n">out_sequence_len</span><span class="p">,</span> <span class="n">trg</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">tgt</span><span class="o">=</span><span class="n">trg</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="o">=</span><span class="n">trg_mask</span><span class="p">)</span> <span class="o">+</span> <span class="n">trg_start</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">):</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">trg</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_src</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_trg</span><span class="p">(</span><span class="n">trg</span><span class="o">=</span><span class="n">trg</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.Transformer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_encoder_inputs</span><span class="p">,</span> <span class="n">n_decoder_inputs</span><span class="p">,</span> <span class="n">n_decoder_output</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_embeddings</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.seq2seq.Transformer.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>TODO: hindcast_output_window seems not used</p>
<h6 id="torchhydro.models.seq2seq.Transformer.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.seq2seq.Transformer.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>n_encoder_inputs : <em>type</em>
    <em>description</em>
n_decoder_inputs : <em>type</em>
    <em>description</em>
n_decoder_output : <em>type</em>
    <em>description</em>
channels : int, optional
    <em>description</em>, by default 256
num_embeddings : int, optional
    <em>description</em>, by default 512
nhead : int, optional
    <em>description</em>, by default 8
num_layers : int, optional
    <em>description</em>, by default 8
dropout : float, optional
    <em>description</em>, by default 0.1
hindcast_output_window : int, optional
    <em>description</em>, by default 0</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_encoder_inputs</span><span class="p">,</span>
    <span class="n">n_decoder_inputs</span><span class="p">,</span>
    <span class="n">n_decoder_output</span><span class="p">,</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">num_embeddings</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">hindcast_output_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO: hindcast_output_window seems not used</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_encoder_inputs : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    n_decoder_inputs : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    n_decoder_output : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    channels : int, optional</span>
<span class="sd">        _description_, by default 256</span>
<span class="sd">    num_embeddings : int, optional</span>
<span class="sd">        _description_, by default 512</span>
<span class="sd">    nhead : int, optional</span>
<span class="sd">        _description_, by default 8</span>
<span class="sd">    num_layers : int, optional</span>
<span class="sd">        _description_, by default 8</span>
<span class="sd">    dropout : float, optional</span>
<span class="sd">        _description_, by default 0.1</span>
<span class="sd">    hindcast_output_window : int, optional</span>
<span class="sd">        _description_, by default 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">input_pos_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_pos_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>

    <span class="n">encoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
        <span class="n">d_model</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">nhead</span><span class="o">=</span><span class="n">nhead</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
        <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">channels</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">decoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoderLayer</span><span class="p">(</span>
        <span class="n">d_model</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">nhead</span><span class="o">=</span><span class="n">nhead</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
        <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">channels</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">encoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoder</span><span class="p">(</span><span class="n">decoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">input_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_encoder_inputs</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_decoder_inputs</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">n_decoder_output</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">do</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seq2seq.Transformer.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.seq2seq.Transformer.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seq2seq.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">):</span>
    <span class="n">src</span><span class="p">,</span> <span class="n">trg</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_src</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_trg</span><span class="p">(</span><span class="n">trg</span><span class="o">=</span><span class="n">trg</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.seqforecast" class="doc doc-heading">
        <code>seqforecast</code>



<a href="#torchhydro.models.seqforecast" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.FeatureEmbedding" class="doc doc-heading">
        <code>
FeatureEmbedding            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.FeatureEmbedding" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FeatureEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FeatureEmbedding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">Mlp</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">dr</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_features</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.FeatureEmbedding.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_features</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.FeatureEmbedding.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_features</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.ForecastLSTM" class="doc doc-heading">
        <code>
ForecastLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.ForecastLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ForecastLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForecastLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.ForecastLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.ForecastLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.HiddenStateTransferNet" class="doc doc-heading">
        <code>
HiddenStateTransferNet            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.HiddenStateTransferNet" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HiddenStateTransferNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HiddenStateTransferNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_transfer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">forecast_hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_transfer</span> <span class="o">=</span> <span class="n">Mlp</span><span class="p">(</span>
            <span class="n">hindcast_hidden_dim</span><span class="p">,</span>
            <span class="n">forecast_hidden_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dr</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="n">transfer_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_transfer</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
        <span class="n">transfer_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_transfer</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transfer_hidden</span><span class="p">,</span> <span class="n">transfer_cell</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.HiddenStateTransferNet.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.HiddenStateTransferNet.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
    <span class="n">transfer_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_transfer</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
    <span class="n">transfer_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_transfer</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transfer_hidden</span><span class="p">,</span> <span class="n">transfer_cell</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.HindcastLSTM" class="doc doc-heading">
        <code>
HindcastLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.HindcastLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HindcastLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HindcastLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.HindcastLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.HindcastLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.ModelOutputHead" class="doc doc-heading">
        <code>
ModelOutputHead            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.ModelOutputHead" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelOutputHead</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelOutputHead</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.ModelOutputHead.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.ModelOutputHead.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.seqforecast.SequentialForecastLSTM" class="doc doc-heading">
        <code>
SequentialForecastLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.seqforecast.SequentialForecastLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SequentialForecastLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">static_input_dim</span><span class="p">,</span>
        <span class="n">dynamic_input_dim</span><span class="p">,</span>
        <span class="n">static_embedding_dim</span><span class="p">,</span>
        <span class="n">sta_embed_hidden_dim</span><span class="p">,</span>
        <span class="n">dynamic_embedding_dim</span><span class="p">,</span>
        <span class="n">dyn_embed_hidden_dim</span><span class="p">,</span>
        <span class="n">hindcast_hidden_dim</span><span class="p">,</span>
        <span class="n">forecast_hidden_dim</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="p">,</span>
        <span class="n">hindcast_output_window</span><span class="p">,</span>
        <span class="n">embedding_dropout</span><span class="p">,</span>
        <span class="n">handoff_dropout</span><span class="p">,</span>
        <span class="n">lstm_dropout</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        static_input_dim : int</span>
<span class="sd">            _description_</span>
<span class="sd">        dynamic_input_dim : int</span>
<span class="sd">            _description_</span>
<span class="sd">        static_embedding_dim : int</span>
<span class="sd">            output size of static embedding</span>
<span class="sd">        sta_embed_hidden_dim: int</span>
<span class="sd">            hidden size of static embedding</span>
<span class="sd">        dynamic_embedding_dim : int</span>
<span class="sd">            output size of dynamic embedding</span>
<span class="sd">        dyn_embed_hidden_dim: int</span>
<span class="sd">            hidden size of dynamic embedding</span>
<span class="sd">        hidden_dim : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        output_dim : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        hindcast_output_window : int</span>
<span class="sd">            length of hindcast output to calculate loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SequentialForecastLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">output_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">=</span> <span class="n">hindcast_output_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding_dim</span> <span class="o">=</span> <span class="n">dynamic_embedding_dim</span>
        <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding</span> <span class="o">=</span> <span class="n">FeatureEmbedding</span><span class="p">(</span>
                <span class="n">static_input_dim</span><span class="p">,</span>
                <span class="n">static_embedding_dim</span><span class="p">,</span>
                <span class="n">sta_embed_hidden_dim</span><span class="p">,</span>
                <span class="n">embedding_dropout</span><span class="p">,</span>
                <span class="n">activation</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding</span> <span class="o">=</span> <span class="n">FeatureEmbedding</span><span class="p">(</span>
                <span class="n">dynamic_input_dim</span><span class="p">,</span>
                <span class="n">dynamic_embedding_dim</span><span class="p">,</span>
                <span class="n">dyn_embed_hidden_dim</span><span class="p">,</span>
                <span class="n">embedding_dropout</span><span class="p">,</span>
                <span class="n">activation</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding_dim</span> <span class="o">=</span> <span class="n">static_embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding_dim</span> <span class="o">=</span> <span class="n">dynamic_embedding_dim</span>
        <span class="n">hindcast_input_dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dynamic_embedding_dim</span> <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dynamic_input_dim</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">static_embedding_dim</span> <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">static_input_dim</span><span class="p">)</span>
        <span class="n">forecast_input_dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dynamic_embedding_dim</span> <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dynamic_input_dim</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">static_embedding_dim</span> <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">static_input_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_lstm</span> <span class="o">=</span> <span class="n">HindcastLSTM</span><span class="p">(</span>
            <span class="n">hindcast_input_dim</span><span class="p">,</span> <span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">lstm_dropout</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_lstm</span> <span class="o">=</span> <span class="n">ForecastLSTM</span><span class="p">(</span>
            <span class="n">forecast_input_dim</span><span class="p">,</span> <span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">lstm_dropout</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenstatetransfer</span> <span class="o">=</span> <span class="n">HiddenStateTransferNet</span><span class="p">(</span>
            <span class="n">hindcast_hidden_dim</span><span class="p">,</span>
            <span class="n">forecast_hidden_dim</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">handoff_dropout</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_head</span> <span class="o">=</span> <span class="n">ModelOutputHead</span><span class="p">(</span><span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_output_head</span> <span class="o">=</span> <span class="n">ModelOutputHead</span><span class="p">(</span><span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_features</span><span class="p">,</span> <span class="n">dynamic_features</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dynamic_embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding</span><span class="p">(</span><span class="n">dynamic_features</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dynamic_embedded</span> <span class="o">=</span> <span class="n">dynamic_features</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">static_embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">static_embedded</span> <span class="o">=</span> <span class="n">static_features</span>
        <span class="n">static_embedded</span> <span class="o">=</span> <span class="n">static_embedded</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dynamic_embedded</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">dynamic_embedded</span><span class="p">,</span> <span class="n">static_embedded</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">hindcast_features</span><span class="p">,</span>
            <span class="n">forecast_features</span><span class="p">,</span>
            <span class="n">static_features</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">src</span>

        <span class="c1"># Hindcast LSTM</span>
        <span class="n">hindcast_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">,</span> <span class="n">hindcast_features</span><span class="p">)</span>
        <span class="n">hincast_output</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_lstm</span><span class="p">(</span><span class="n">hindcast_input</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hincast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_head</span><span class="p">(</span>
                <span class="n">hincast_output</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="p">)</span>

        <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenstatetransfer</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

        <span class="c1"># Forecast LSTM</span>
        <span class="n">forecast_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">,</span> <span class="n">forecast_features</span><span class="p">)</span>
        <span class="n">forecast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_lstm</span><span class="p">(</span><span class="n">forecast_input</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">forecast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_output_head</span><span class="p">(</span><span class="n">forecast_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">forecast_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hincast_output</span><span class="p">,</span> <span class="n">forecast_output</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">forecast_output</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.SequentialForecastLSTM.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_input_dim</span><span class="p">,</span> <span class="n">dynamic_input_dim</span><span class="p">,</span> <span class="n">static_embedding_dim</span><span class="p">,</span> <span class="n">sta_embed_hidden_dim</span><span class="p">,</span> <span class="n">dynamic_embedding_dim</span><span class="p">,</span> <span class="n">dyn_embed_hidden_dim</span><span class="p">,</span> <span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">hindcast_output_window</span><span class="p">,</span> <span class="n">embedding_dropout</span><span class="p">,</span> <span class="n">handoff_dropout</span><span class="p">,</span> <span class="n">lstm_dropout</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p><em>summary</em></p>
<h6 id="torchhydro.models.seqforecast.SequentialForecastLSTM.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.seqforecast.SequentialForecastLSTM.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>static_input_dim : int
    <em>description</em>
dynamic_input_dim : int
    <em>description</em>
static_embedding_dim : int
    output size of static embedding
!!! sta_embed_hidden_dim "int"
    hidden size of static embedding
dynamic_embedding_dim : int
    output size of dynamic embedding
!!! dyn_embed_hidden_dim "int"
    hidden size of dynamic embedding
hidden_dim : <em>type</em>
    <em>description</em>
output_dim : <em>type</em>
    <em>description</em>
hindcast_output_window : int
    length of hindcast output to calculate loss</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">static_input_dim</span><span class="p">,</span>
    <span class="n">dynamic_input_dim</span><span class="p">,</span>
    <span class="n">static_embedding_dim</span><span class="p">,</span>
    <span class="n">sta_embed_hidden_dim</span><span class="p">,</span>
    <span class="n">dynamic_embedding_dim</span><span class="p">,</span>
    <span class="n">dyn_embed_hidden_dim</span><span class="p">,</span>
    <span class="n">hindcast_hidden_dim</span><span class="p">,</span>
    <span class="n">forecast_hidden_dim</span><span class="p">,</span>
    <span class="n">output_dim</span><span class="p">,</span>
    <span class="n">hindcast_output_window</span><span class="p">,</span>
    <span class="n">embedding_dropout</span><span class="p">,</span>
    <span class="n">handoff_dropout</span><span class="p">,</span>
    <span class="n">lstm_dropout</span><span class="p">,</span>
    <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    static_input_dim : int</span>
<span class="sd">        _description_</span>
<span class="sd">    dynamic_input_dim : int</span>
<span class="sd">        _description_</span>
<span class="sd">    static_embedding_dim : int</span>
<span class="sd">        output size of static embedding</span>
<span class="sd">    sta_embed_hidden_dim: int</span>
<span class="sd">        hidden size of static embedding</span>
<span class="sd">    dynamic_embedding_dim : int</span>
<span class="sd">        output size of dynamic embedding</span>
<span class="sd">    dyn_embed_hidden_dim: int</span>
<span class="sd">        hidden size of dynamic embedding</span>
<span class="sd">    hidden_dim : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    output_dim : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    hindcast_output_window : int</span>
<span class="sd">        length of hindcast output to calculate loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">SequentialForecastLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">output_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">=</span> <span class="n">hindcast_output_window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding_dim</span> <span class="o">=</span> <span class="n">dynamic_embedding_dim</span>
    <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding</span> <span class="o">=</span> <span class="n">FeatureEmbedding</span><span class="p">(</span>
            <span class="n">static_input_dim</span><span class="p">,</span>
            <span class="n">static_embedding_dim</span><span class="p">,</span>
            <span class="n">sta_embed_hidden_dim</span><span class="p">,</span>
            <span class="n">embedding_dropout</span><span class="p">,</span>
            <span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding</span> <span class="o">=</span> <span class="n">FeatureEmbedding</span><span class="p">(</span>
            <span class="n">dynamic_input_dim</span><span class="p">,</span>
            <span class="n">dynamic_embedding_dim</span><span class="p">,</span>
            <span class="n">dyn_embed_hidden_dim</span><span class="p">,</span>
            <span class="n">embedding_dropout</span><span class="p">,</span>
            <span class="n">activation</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">static_embedding_dim</span> <span class="o">=</span> <span class="n">static_embedding_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_embedding_dim</span> <span class="o">=</span> <span class="n">dynamic_embedding_dim</span>
    <span class="n">hindcast_input_dim</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dynamic_embedding_dim</span> <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dynamic_input_dim</span>
    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">static_embedding_dim</span> <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">static_input_dim</span><span class="p">)</span>
    <span class="n">forecast_input_dim</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dynamic_embedding_dim</span> <span class="k">if</span> <span class="n">dynamic_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dynamic_input_dim</span>
    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">static_embedding_dim</span> <span class="k">if</span> <span class="n">static_embedding_dim</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">static_input_dim</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_lstm</span> <span class="o">=</span> <span class="n">HindcastLSTM</span><span class="p">(</span>
        <span class="n">hindcast_input_dim</span><span class="p">,</span> <span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">lstm_dropout</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forecast_lstm</span> <span class="o">=</span> <span class="n">ForecastLSTM</span><span class="p">(</span>
        <span class="n">forecast_input_dim</span><span class="p">,</span> <span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">lstm_dropout</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hiddenstatetransfer</span> <span class="o">=</span> <span class="n">HiddenStateTransferNet</span><span class="p">(</span>
        <span class="n">hindcast_hidden_dim</span><span class="p">,</span>
        <span class="n">forecast_hidden_dim</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">handoff_dropout</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_head</span> <span class="o">=</span> <span class="n">ModelOutputHead</span><span class="p">(</span><span class="n">hindcast_hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forecast_output_head</span> <span class="o">=</span> <span class="n">ModelOutputHead</span><span class="p">(</span><span class="n">forecast_hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.seqforecast.SequentialForecastLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span></code>


<a href="#torchhydro.models.seqforecast.SequentialForecastLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/seqforecast.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">):</span>
    <span class="p">(</span>
        <span class="n">hindcast_features</span><span class="p">,</span>
        <span class="n">forecast_features</span><span class="p">,</span>
        <span class="n">static_features</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">src</span>

    <span class="c1"># Hindcast LSTM</span>
    <span class="n">hindcast_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">,</span> <span class="n">hindcast_features</span><span class="p">)</span>
    <span class="n">hincast_output</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_lstm</span><span class="p">(</span><span class="n">hindcast_input</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hincast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_head</span><span class="p">(</span>
            <span class="n">hincast_output</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="p">)</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiddenstatetransfer</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="c1"># Forecast LSTM</span>
    <span class="n">forecast_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_embedding</span><span class="p">(</span><span class="n">static_features</span><span class="p">,</span> <span class="n">forecast_features</span><span class="p">)</span>
    <span class="n">forecast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_lstm</span><span class="p">(</span><span class="n">forecast_input</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">forecast_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_output_head</span><span class="p">(</span><span class="n">forecast_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_output_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">forecast_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hincast_output</span><span class="p">,</span> <span class="n">forecast_output</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">forecast_output</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.simple_lstm" class="doc doc-heading">
        <code>simple_lstm</code>



<a href="#torchhydro.models.simple_lstm" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Wenyu Ouyang
Date: 2023-09-19 09:36:25
LastEditTime: 2025-11-08 15:55:14
LastEditors: Wenyu Ouyang
Description: Some self-made LSTMs
FilePath:       orchhydro       orchhydro\models\simple_lstm.py
Copyright (c) 2023-2024 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.HFLSTM" class="doc doc-heading">
        <code>
HFLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.simple_lstm.HFLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HFLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">teacher_forcing_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">hindcast_with_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_size : int</span>
<span class="sd">            without streamflow</span>
<span class="sd">        output_size : int</span>
<span class="sd">            streamflow</span>
<span class="sd">        hidden_size : int</span>
<span class="sd">        dr : float, optional</span>
<span class="sd">            dropout, by default 0.0</span>
<span class="sd">        teacher_forcing_ratio : float, optional</span>
<span class="sd">            by default 0</span>
<span class="sd">        hindcast_with_output : bool, optional</span>
<span class="sd">            whether to use the output of the model as input for the next time step, by default True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HFLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span> <span class="o">=</span> <span class="n">teacher_forcing_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_with_output</span> <span class="o">=</span> <span class="n">hindcast_with_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_teacher_forcing_preparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xq_hor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="c1"># teacher forcing preparation</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xq_hor</span><span class="p">)</span>
        <span class="n">random_vals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">random_vals</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">valid_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rho_forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x_rho</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">x0_rho</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x_rho</span><span class="p">))</span>
        <span class="n">out_lstm_rho</span><span class="p">,</span> <span class="p">(</span><span class="n">hn_rho</span><span class="p">,</span> <span class="n">cn_rho</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0_rho</span><span class="p">)</span>
        <span class="n">out_lstm_rho_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out_lstm_rho</span><span class="p">)</span>
        <span class="n">out_lstm_rho_lnout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm_rho_dr</span><span class="p">)</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="n">out_lstm_rho_lnout</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">out_lstm_rho_lnout</span><span class="p">,</span> <span class="n">hn_rho</span><span class="p">,</span> <span class="n">cn_rho</span><span class="p">,</span> <span class="n">prev_output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xfc_hor</span><span class="p">,</span> <span class="n">xq_rho</span><span class="p">,</span> <span class="n">xq_hor</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">x_rho</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xq_rho</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hor_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xfc_hor</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c1"># hindcast-forecast, we do not have forecast-hindcast situation</span>
        <span class="c1"># do rho forward first, prev_output is the last output of rho (seq_length = 1, batch_size, feature = output_size)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_with_output</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">,</span> <span class="n">prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_forward</span><span class="p">(</span><span class="n">x_rho</span><span class="p">)</span>
            <span class="n">seq_len</span> <span class="o">=</span> <span class="n">hor_len</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: need more test</span>
            <span class="n">seq_len</span> <span class="o">=</span> <span class="n">xfc_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">hor_len</span>
            <span class="n">xfc_hor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xfc_hor</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xq_hor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xq_rho</span><span class="p">,</span> <span class="n">xq_hor</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">h_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">c_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">prev_output</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="p">)</span>

        <span class="n">use_teacher_forcing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher_forcing_preparation</span><span class="p">(</span><span class="n">xq_hor</span><span class="p">)</span>

        <span class="c1"># do hor forward</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># TODO: too slow here when seq_len is large, need to optimize</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">):</span>
            <span class="n">real_streamflow_input</span> <span class="o">=</span> <span class="n">xq_hor</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">prev_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">use_teacher_forcing</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">real_streamflow_input</span><span class="p">,</span>
                <span class="n">prev_output</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">input_concat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_hor</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">prev_output</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Pass through the initial linear layer</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">input_concat</span><span class="p">))</span>

            <span class="c1"># LSTM step</span>
            <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">))</span>

            <span class="c1"># Generate the current output</span>
            <span class="n">prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">prev_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Return the outputs</span>
        <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="n">hor_len</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.HFLSTM.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">teacher_forcing_ratio</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hindcast_with_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.simple_lstm.HFLSTM.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.simple_lstm.HFLSTM.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.simple_lstm.HFLSTM.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>input_size : int
    without streamflow
output_size : int
    streamflow
hidden_size : int
dr : float, optional
    dropout, by default 0.0
teacher_forcing_ratio : float, optional
    by default 0
hindcast_with_output : bool, optional
    whether to use the output of the model as input for the next time step, by default True</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">teacher_forcing_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">hindcast_with_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_size : int</span>
<span class="sd">        without streamflow</span>
<span class="sd">    output_size : int</span>
<span class="sd">        streamflow</span>
<span class="sd">    hidden_size : int</span>
<span class="sd">    dr : float, optional</span>
<span class="sd">        dropout, by default 0.0</span>
<span class="sd">    teacher_forcing_ratio : float, optional</span>
<span class="sd">        by default 0</span>
<span class="sd">    hindcast_with_output : bool, optional</span>
<span class="sd">        whether to use the output of the model as input for the next time step, by default True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">HFLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">teacher_forcing_ratio</span> <span class="o">=</span> <span class="n">teacher_forcing_ratio</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_with_output</span> <span class="o">=</span> <span class="n">hindcast_with_output</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.HFLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.HFLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xfc_hor</span><span class="p">,</span> <span class="n">xq_rho</span><span class="p">,</span> <span class="n">xq_hor</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">x_rho</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xq_rho</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hor_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xfc_hor</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="c1"># hindcast-forecast, we do not have forecast-hindcast situation</span>
    <span class="c1"># do rho forward first, prev_output is the last output of rho (seq_length = 1, batch_size, feature = output_size)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hindcast_with_output</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">,</span> <span class="n">prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_forward</span><span class="p">(</span><span class="n">x_rho</span><span class="p">)</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">hor_len</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: need more test</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">xfc_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">hor_len</span>
        <span class="n">xfc_hor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_rho</span><span class="p">,</span> <span class="n">xfc_hor</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xq_hor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xq_rho</span><span class="p">,</span> <span class="n">xq_hor</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">h_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">c_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="p">)</span>

    <span class="n">use_teacher_forcing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher_forcing_preparation</span><span class="p">(</span><span class="n">xq_hor</span><span class="p">)</span>

    <span class="c1"># do hor forward</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xfc_rho</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># TODO: too slow here when seq_len is large, need to optimize</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">):</span>
        <span class="n">real_streamflow_input</span> <span class="o">=</span> <span class="n">xq_hor</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">use_teacher_forcing</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="n">real_streamflow_input</span><span class="p">,</span>
            <span class="n">prev_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">input_concat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xfc_hor</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">prev_output</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Pass through the initial linear layer</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">input_concat</span><span class="p">))</span>

        <span class="c1"># LSTM step</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">))</span>

        <span class="c1"># Generate the current output</span>
        <span class="n">prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">prev_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Return the outputs</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="n">hor_len</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel" class="doc doc-heading">
        <code>
LinearMultiLayerLSTMModel            (<a class="autorefs autorefs-internal" title="
MultiLayerLSTM            (Module)
         (torchhydro.models.simple_lstm.MultiLayerLSTM)" href="#torchhydro.models.simple_lstm.MultiLayerLSTM">MultiLayerLSTM</a>)
        </code>



<a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This model is nonlinear layer + MultiLayerLSTM.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LinearMultiLayerLSTMModel</span><span class="p">(</span><span class="n">MultiLayerLSTM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model is nonlinear layer + MultiLayerLSTM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        linear_size</span>
<span class="sd">            the number of input features for the first input linear layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinearMultiLayerLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearMultiLayerLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>linear_size
    the number of input features for the first input linear layer</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    linear_size</span>
<span class="sd">        the number of input features for the first input linear layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">LinearMultiLayerLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.LinearMultiLayerLSTMModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearMultiLayerLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.LinearSimpleLSTMModel" class="doc doc-heading">
        <code>
LinearSimpleLSTMModel            (<a class="autorefs autorefs-internal" title="
SimpleLSTM            (Module)
         (torchhydro.models.simple_lstm.SimpleLSTM)" href="#torchhydro.models.simple_lstm.SimpleLSTM">SimpleLSTM</a>)
        </code>



<a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This model is nonlinear layer + SimpleLSTM.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LinearSimpleLSTMModel</span><span class="p">(</span><span class="n">SimpleLSTM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model is nonlinear layer + SimpleLSTM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        linear_size</span>
<span class="sd">            the number of input features for the first input linear layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinearSimpleLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass for the LinearSimpleLSTMModel.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor which will be passed through a linear layer first.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The output of the underlying SimpleLSTM model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearSimpleLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__--parameters">Parameters<a class="headerlink" href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.__init__--parameters" title="Permanent link">&para;</a></h6>
<p>linear_size
    the number of input features for the first input linear layer</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    linear_size</span>
<span class="sd">        the number of input features for the first input linear layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">LinearSimpleLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">linear_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.LinearSimpleLSTMModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.LinearSimpleLSTMModel.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass for the LinearSimpleLSTMModel.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>x</code></td>
        <td><code>Tensor</code></td>
        <td><p>Input tensor which will be passed through a linear layer first.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tensor</code></td>
      <td><p>The output of the underlying SimpleLSTM model.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass for the LinearSimpleLSTMModel.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor which will be passed through a linear layer first.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The output of the underlying SimpleLSTM model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">former_linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinearSimpleLSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.MinLSTM" class="doc doc-heading">
        <code>
MinLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.simple_lstm.MinLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Only "parallel mode" is supported for conciseness.
use log space.
Written by Yang Wang</p>
<p>https://arxiv.org/pdf/2410.01201
https://github.com/axion66/minLSTM-implementation</p>
<p>input shape: [batch, seq_len, in_chn]
output shape: [batch,seq_len, out_chn]</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MinLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Only &quot;parallel mode&quot; is supported for conciseness.</span>
<span class="sd">    use log space.</span>
<span class="sd">    Written by Yang Wang</span>

<span class="sd">    https://arxiv.org/pdf/2410.01201</span>
<span class="sd">    https://github.com/axion66/minLSTM-implementation</span>

<span class="sd">    input shape: [batch, seq_len, in_chn]</span>
<span class="sd">    output shape: [batch,seq_len, out_chn]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">h_prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">x_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x_t</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x_t</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x_t</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
        <span class="n">log_f</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">log_i</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">log_h_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_g</span><span class="p">(</span><span class="n">h_prev</span><span class="p">)</span>
        <span class="n">log_tilde_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_g</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">log_coeff</span> <span class="o">=</span> <span class="n">log_f</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">log_h_0</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">log_i</span> <span class="o">+</span> <span class="n">log_tilde_h</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_scan_log</span><span class="p">(</span><span class="n">log_coeff</span><span class="p">,</span> <span class="n">log_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h_t</span><span class="p">[:,</span> <span class="o">-</span><span class="n">seq_len</span><span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parallel_scan_log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">log_coeffs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">log_values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">a_star</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_coeffs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log_h0_plus_b_star</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logcumsumexp</span><span class="p">(</span><span class="n">log_values</span> <span class="o">-</span> <span class="n">a_star</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log_h</span> <span class="o">=</span> <span class="n">a_star</span> <span class="o">+</span> <span class="n">log_h0_plus_b_star</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_h</span><span class="p">)</span>  <span class="c1"># will return [batch, seq + 1, chn]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">(),</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.MinLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">h_prev</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.MinLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">h_prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">x_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x_t</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x_t</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x_t</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
    <span class="n">log_f</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">log_i</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">log_h_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_g</span><span class="p">(</span><span class="n">h_prev</span><span class="p">)</span>
    <span class="n">log_tilde_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_g</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">log_coeff</span> <span class="o">=</span> <span class="n">log_f</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">log_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">log_h_0</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">log_i</span> <span class="o">+</span> <span class="n">log_tilde_h</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">h_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_scan_log</span><span class="p">(</span><span class="n">log_coeff</span><span class="p">,</span> <span class="n">log_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_t</span><span class="p">[:,</span> <span class="o">-</span><span class="n">seq_len</span><span class="p">:]</span>
</code></pre></div>
        </details>
    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.MultiLayerLSTM" class="doc doc-heading">
        <code>
MultiLayerLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.simple_lstm.MultiLayerLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiLayerLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiLayerLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">dr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.MultiLayerLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.MultiLayerLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.SimpleLSTM" class="doc doc-heading">
        <code>
SimpleLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.simple_lstm.SimpleLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass of the SimpleLSTM model.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor.</span>
<span class="sd">            **kwargs: Optional keyword arguments:</span>
<span class="sd">                - seq_lengths: Sequence lengths for PackedSequence.</span>
<span class="sd">                - mask: Mask tensor for manual masking.</span>
<span class="sd">                - use_manual_mask: Prioritize manual masking over PackedSequence.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The output tensor from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c1"># Extract parameters from kwargs</span>
        <span class="n">seq_lengths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seq_lengths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">use_manual_mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_manual_mask&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Determine processing method based on available parameters</span>
        <span class="k">if</span> <span class="n">use_manual_mask</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use manual masking</span>
            <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

            <span class="c1"># Apply mask to LSTM output</span>
            <span class="c1"># Ensure mask has the correct shape for broadcasting</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># [batch_size, seq_len]</span>
                <span class="c1"># Convert to [seq_len, batch_size, 1] for seq_first format</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If mask is [seq_len, batch_size, features], take only the first feature</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Apply mask: set masked positions to zero</span>
            <span class="n">out_lstm</span> <span class="o">=</span> <span class="n">out_lstm</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="k">elif</span> <span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_manual_mask</span><span class="p">:</span>
            <span class="c1"># Use PackedSequence (original behavior)</span>
            <span class="n">packed_x</span> <span class="o">=</span> <span class="n">pack_padded_sequence</span><span class="p">(</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">seq_lengths</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enforce_sorted</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">packed_out</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">packed_x</span><span class="p">)</span>
            <span class="n">out_lstm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pad_packed_sequence</span><span class="p">(</span><span class="n">packed_out</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Standard processing without masking</span>
            <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

            <span class="c1"># Apply mask if provided (even without use_manual_mask flag)</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># [batch_size, seq_len]</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">out_lstm</span> <span class="o">=</span> <span class="n">out_lstm</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="n">out_lstm_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm_dr</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.SimpleLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.SimpleLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass of the SimpleLSTM model.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>x</code></td>
        <td><code>Tensor</code></td>
        <td><p>Input tensor.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>**kwargs</code></td>
        <td><code>Any</code></td>
        <td><p>Optional keyword arguments:
- seq_lengths: Sequence lengths for PackedSequence.
- mask: Mask tensor for manual masking.
- use_manual_mask: Prioritize manual masking over PackedSequence.</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tensor</code></td>
      <td><p>The output tensor from the model.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass of the SimpleLSTM model.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor.</span>
<span class="sd">        **kwargs: Optional keyword arguments:</span>
<span class="sd">            - seq_lengths: Sequence lengths for PackedSequence.</span>
<span class="sd">            - mask: Mask tensor for manual masking.</span>
<span class="sd">            - use_manual_mask: Prioritize manual masking over PackedSequence.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The output tensor from the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linearIn</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Extract parameters from kwargs</span>
    <span class="n">seq_lengths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seq_lengths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">use_manual_mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_manual_mask&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Determine processing method based on available parameters</span>
    <span class="k">if</span> <span class="n">use_manual_mask</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use manual masking</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

        <span class="c1"># Apply mask to LSTM output</span>
        <span class="c1"># Ensure mask has the correct shape for broadcasting</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># [batch_size, seq_len]</span>
            <span class="c1"># Convert to [seq_len, batch_size, 1] for seq_first format</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If mask is [seq_len, batch_size, features], take only the first feature</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Apply mask: set masked positions to zero</span>
        <span class="n">out_lstm</span> <span class="o">=</span> <span class="n">out_lstm</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="k">elif</span> <span class="n">seq_lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_manual_mask</span><span class="p">:</span>
        <span class="c1"># Use PackedSequence (original behavior)</span>
        <span class="n">packed_x</span> <span class="o">=</span> <span class="n">pack_padded_sequence</span><span class="p">(</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">seq_lengths</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enforce_sorted</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">packed_out</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">packed_x</span><span class="p">)</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pad_packed_sequence</span><span class="p">(</span><span class="n">packed_out</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard processing without masking</span>
        <span class="n">out_lstm</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

        <span class="c1"># Apply mask if provided (even without use_manual_mask flag)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># [batch_size, seq_len]</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_lstm</span> <span class="o">=</span> <span class="n">out_lstm</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">out_lstm_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out_lstm</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearOut</span><span class="p">(</span><span class="n">out_lstm_dr</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.SimpleLSTMForecast" class="doc doc-heading">
        <code>
SimpleLSTMForecast            (<a class="autorefs autorefs-internal" title="
SimpleLSTM            (Module)
         (torchhydro.models.simple_lstm.SimpleLSTM)" href="#torchhydro.models.simple_lstm.SimpleLSTM">SimpleLSTM</a>)
        </code>



<a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleLSTMForecast</span><span class="p">(</span><span class="n">SimpleLSTM</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">output_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">forecast_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleLSTMForecast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dr</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass for the SimpleLSTMForecast model.</span>

<span class="sd">        This method calls the parent&#39;s forward method and returns only the</span>
<span class="sd">        final part of the output sequence corresponding to the forecast length.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Input tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tensor containing the forecast part of the output sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># forward</span>
        <span class="n">full_output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimpleLSTMForecast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">full_output</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.SimpleLSTMForecast.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.SimpleLSTMForecast.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Forward pass for the SimpleLSTMForecast model.</p>
<p>This method calls the parent's forward method and returns only the
final part of the output sequence corresponding to the forecast length.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>x</code></td>
        <td><code>Tensor</code></td>
        <td><p>Input tensor.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tensor</code></td>
      <td><p>A tensor containing the forecast part of the output sequence.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass for the SimpleLSTMForecast model.</span>

<span class="sd">    This method calls the parent&#39;s forward method and returns only the</span>
<span class="sd">    final part of the output sequence corresponding to the forecast length.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tensor containing the forecast part of the output sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># forward</span>
    <span class="n">full_output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimpleLSTMForecast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">full_output</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.simple_lstm.SlowLSTM" class="doc doc-heading">
        <code>
SlowLSTM            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.simple_lstm.SlowLSTM" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>A pedagogic implementation of Hochreiter &amp; Schmidhuber:
'Long-Short Term Memory'
http://www.bioinf.jku.at/publications/older/2604.pdf</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SlowLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pedagogic implementation of Hochreiter &amp; Schmidhuber:</span>
<span class="sd">    &#39;Long-Short Term Memory&#39;</span>
<span class="sd">    http://www.bioinf.jku.at/publications/older/2604.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlowLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="c1"># input to hidden weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_xi</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_xf</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_xo</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_xc</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">))</span>
        <span class="c1"># hidden to hidden weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_hi</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_hf</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ho</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_hc</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
        <span class="c1"># bias terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_f</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_o</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_c</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Wrap biases as parameters if desired, else as variables without gradients</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">P</span> <span class="k">if</span> <span class="n">bias</span> <span class="k">else</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span> <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_f</span> <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_o</span> <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_c</span> <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">std</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">std</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">hidden</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">hidden</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Linear mappings</span>
        <span class="n">i_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xi</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hi</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span>
        <span class="n">f_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xf</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hf</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_f</span>
        <span class="n">o_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xo</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ho</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_o</span>
        <span class="c1"># activations</span>
        <span class="n">i_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
        <span class="n">f_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
        <span class="n">o_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
        <span class="c1"># cell computations</span>
        <span class="n">c_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xc</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hc</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_c</span>
        <span class="n">c_t</span><span class="o">.</span><span class="n">tanh_</span><span class="p">()</span>
        <span class="n">c_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">i_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">)</span>
        <span class="n">h_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">o_t</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c_t</span><span class="p">))</span>
        <span class="c1"># Reshape for compatibility</span>
        <span class="n">h_t</span> <span class="o">=</span> <span class="n">h_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c_t</span> <span class="o">=</span> <span class="n">c_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">c_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_t</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h_t</span><span class="p">,</span> <span class="p">(</span><span class="n">h_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.simple_lstm.SlowLSTM.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span></code>


<a href="#torchhydro.models.simple_lstm.SlowLSTM.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/simple_lstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">hidden</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">hidden</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Linear mappings</span>
    <span class="n">i_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xi</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hi</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span>
    <span class="n">f_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xf</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hf</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_f</span>
    <span class="n">o_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xo</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ho</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_o</span>
    <span class="c1"># activations</span>
    <span class="n">i_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
    <span class="n">f_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
    <span class="n">o_t</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
    <span class="c1"># cell computations</span>
    <span class="n">c_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_xc</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_hc</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_c</span>
    <span class="n">c_t</span><span class="o">.</span><span class="n">tanh_</span><span class="p">()</span>
    <span class="n">c_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">i_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">)</span>
    <span class="n">h_t</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">o_t</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c_t</span><span class="p">))</span>
    <span class="c1"># Reshape for compatibility</span>
    <span class="n">h_t</span> <span class="o">=</span> <span class="n">h_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c_t</span> <span class="o">=</span> <span class="n">c_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">c_t</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_t</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_t</span><span class="p">,</span> <span class="p">(</span><span class="n">h_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="torchhydro.models.spplstm" class="doc doc-heading">
        <code>spplstm</code>



<a href="#torchhydro.models.spplstm" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Author: Xinzhuo Wu
Date: 2023-09-30 1:20:18
LastEditTime: 2024-05-27 16:26:06
LastEditors: Wenyu Ouyang
Description: spp lstm model
FilePath:       orchhydro       orchhydro\models\spplstm.py
Copyright (c) 2021-2022 Wenyu Ouyang. All rights reserved.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.spplstm.SPP_LSTM_Model" class="doc doc-heading">
        <code>
SPP_LSTM_Model            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.spplstm.SPP_LSTM_Model" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SPP_LSTM_Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hindcast_length</span><span class="p">,</span> <span class="n">forecast_length</span><span class="p">,</span> <span class="n">n_output</span><span class="p">,</span> <span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">dropout</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SPP_LSTM_Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">SppLayer</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="mi">21</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">n_hidden_states</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">n_output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.SPP_LSTM_Model.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.spplstm.SPP_LSTM_Model.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.spplstm.SPP_LSTM_Model_2" class="doc doc-heading">
        <code>
SPP_LSTM_Model_2            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SPP_LSTM_Model_2</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hindcast_length</span><span class="p">,</span>
        <span class="n">forecast_length</span><span class="p">,</span>
        <span class="n">p_n_output</span><span class="p">,</span>
        <span class="n">p_n_hidden_states</span><span class="p">,</span>
        <span class="n">p_dropout</span><span class="p">,</span>
        <span class="n">p_in_channels</span><span class="p">,</span>
        <span class="n">p_out_channels</span><span class="p">,</span>
        <span class="n">len_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_hindcast_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_n_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_n_hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_in_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">s_out_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the SPP_LSTM_Model_2.</span>

<span class="sd">        A custom neural network model for handling and integrating various types</span>
<span class="sd">        of meteorological and geographical data, including precipitation (p),</span>
<span class="sd">        soil (s), and basin attributes (c).</span>

<span class="sd">        Args:</span>
<span class="sd">            hindcast_length: The length of the input sequence for precipitation data.</span>
<span class="sd">            forecast_length: The length of the forecast period.</span>
<span class="sd">            p_n_output: Output dimension for the precipitation (p) data path.</span>
<span class="sd">            p_n_hidden_states: Number of hidden states in the LSTM for the precipitation path.</span>
<span class="sd">            p_dropout: Dropout rate applied in the precipitation path.</span>
<span class="sd">            p_in_channels: Number of input channels for the conv layer in the precipitation path.</span>
<span class="sd">            p_out_channels: Number of output channels for the conv layer in the precipitation path.</span>
<span class="sd">            len_c: Optional, the number of basin attribute (c) features.</span>
<span class="sd">            s_hindcast_length: Optional, hindcast length for the soil (s) data path.</span>
<span class="sd">            s_n_output: Optional, output dimension for the soil path.</span>
<span class="sd">            s_n_hidden_states: Optional, number of hidden states for the soil path LSTM.</span>
<span class="sd">            s_dropout: Optional, dropout rate for the soil path.</span>
<span class="sd">            s_in_channels: Optional, input channels for the soil path conv layer.</span>
<span class="sd">            s_out_channels: Optional, output channels for the soil path conv layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SPP_LSTM_Model_2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">p_in_channels</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="n">p_out_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">p_out_channels</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">len_c</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">p_n_hidden_states</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p_dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">p_n_hidden_states</span><span class="p">,</span> <span class="n">p_n_output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span> <span class="o">=</span> <span class="n">SppLayer</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span> <span class="o">=</span> <span class="n">hindcast_length</span> <span class="o">+</span> <span class="n">forecast_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span>

        <span class="k">if</span> <span class="n">s_hindcast_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="n">s_in_channels</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="n">s_out_channels</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
                <span class="n">input_size</span><span class="o">=</span><span class="n">s_out_channels</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">hidden_size</span><span class="o">=</span><span class="n">s_n_hidden_states</span><span class="p">,</span>
                <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">s_dropout</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">s_n_hidden_states</span><span class="p">,</span> <span class="n">s_n_output</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span> <span class="o">=</span> <span class="n">SppLayer</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span> <span class="o">=</span> <span class="n">s_hindcast_length</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x_lst</span><span class="p">):</span>
        <span class="c1"># c and s must be None, g might be None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># g might be None. either c or s must be None, but not both</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># c is not None</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># s is not None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">p</span>
        <span class="c1"># g might be None. Both s and c are not None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">p_c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>
            <span class="n">p_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>
            <span class="n">p_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">p_c</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.SPP_LSTM_Model_2.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hindcast_length</span><span class="p">,</span> <span class="n">forecast_length</span><span class="p">,</span> <span class="n">p_n_output</span><span class="p">,</span> <span class="n">p_n_hidden_states</span><span class="p">,</span> <span class="n">p_dropout</span><span class="p">,</span> <span class="n">p_in_channels</span><span class="p">,</span> <span class="n">p_out_channels</span><span class="p">,</span> <span class="n">len_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_hindcast_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_n_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_n_hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_in_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_out_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Initializes the SPP_LSTM_Model_2.</p>
<p>A custom neural network model for handling and integrating various types
of meteorological and geographical data, including precipitation (p),
soil (s), and basin attributes (c).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>hindcast_length</code></td>
        <td></td>
        <td><p>The length of the input sequence for precipitation data.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>forecast_length</code></td>
        <td></td>
        <td><p>The length of the forecast period.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>p_n_output</code></td>
        <td></td>
        <td><p>Output dimension for the precipitation (p) data path.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>p_n_hidden_states</code></td>
        <td></td>
        <td><p>Number of hidden states in the LSTM for the precipitation path.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>p_dropout</code></td>
        <td></td>
        <td><p>Dropout rate applied in the precipitation path.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>p_in_channels</code></td>
        <td></td>
        <td><p>Number of input channels for the conv layer in the precipitation path.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>p_out_channels</code></td>
        <td></td>
        <td><p>Number of output channels for the conv layer in the precipitation path.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>len_c</code></td>
        <td></td>
        <td><p>Optional, the number of basin attribute (c) features.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_hindcast_length</code></td>
        <td></td>
        <td><p>Optional, hindcast length for the soil (s) data path.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_n_output</code></td>
        <td></td>
        <td><p>Optional, output dimension for the soil path.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_n_hidden_states</code></td>
        <td></td>
        <td><p>Optional, number of hidden states for the soil path LSTM.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_dropout</code></td>
        <td></td>
        <td><p>Optional, dropout rate for the soil path.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_in_channels</code></td>
        <td></td>
        <td><p>Optional, input channels for the soil path conv layer.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s_out_channels</code></td>
        <td></td>
        <td><p>Optional, output channels for the soil path conv layer.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">hindcast_length</span><span class="p">,</span>
    <span class="n">forecast_length</span><span class="p">,</span>
    <span class="n">p_n_output</span><span class="p">,</span>
    <span class="n">p_n_hidden_states</span><span class="p">,</span>
    <span class="n">p_dropout</span><span class="p">,</span>
    <span class="n">p_in_channels</span><span class="p">,</span>
    <span class="n">p_out_channels</span><span class="p">,</span>
    <span class="n">len_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_hindcast_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_n_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_n_hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_in_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">s_out_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the SPP_LSTM_Model_2.</span>

<span class="sd">    A custom neural network model for handling and integrating various types</span>
<span class="sd">    of meteorological and geographical data, including precipitation (p),</span>
<span class="sd">    soil (s), and basin attributes (c).</span>

<span class="sd">    Args:</span>
<span class="sd">        hindcast_length: The length of the input sequence for precipitation data.</span>
<span class="sd">        forecast_length: The length of the forecast period.</span>
<span class="sd">        p_n_output: Output dimension for the precipitation (p) data path.</span>
<span class="sd">        p_n_hidden_states: Number of hidden states in the LSTM for the precipitation path.</span>
<span class="sd">        p_dropout: Dropout rate applied in the precipitation path.</span>
<span class="sd">        p_in_channels: Number of input channels for the conv layer in the precipitation path.</span>
<span class="sd">        p_out_channels: Number of output channels for the conv layer in the precipitation path.</span>
<span class="sd">        len_c: Optional, the number of basin attribute (c) features.</span>
<span class="sd">        s_hindcast_length: Optional, hindcast length for the soil (s) data path.</span>
<span class="sd">        s_n_output: Optional, output dimension for the soil path.</span>
<span class="sd">        s_n_hidden_states: Optional, number of hidden states for the soil path LSTM.</span>
<span class="sd">        s_dropout: Optional, dropout rate for the soil path.</span>
<span class="sd">        s_in_channels: Optional, input channels for the soil path conv layer.</span>
<span class="sd">        s_out_channels: Optional, output channels for the soil path conv layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">SPP_LSTM_Model_2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
        <span class="n">in_channels</span><span class="o">=</span><span class="n">p_in_channels</span><span class="p">,</span>
        <span class="n">out_channels</span><span class="o">=</span><span class="n">p_out_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
        <span class="n">input_size</span><span class="o">=</span><span class="n">p_out_channels</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">len_c</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">p_n_hidden_states</span><span class="p">,</span>
        <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p_dropout</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">p_n_hidden_states</span><span class="p">,</span> <span class="n">p_n_output</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span> <span class="o">=</span> <span class="n">SppLayer</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span> <span class="o">=</span> <span class="n">hindcast_length</span> <span class="o">+</span> <span class="n">forecast_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span>

    <span class="k">if</span> <span class="n">s_hindcast_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">s_in_channels</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="n">s_out_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">s_out_channels</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">s_n_hidden_states</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">s_dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">s_n_hidden_states</span><span class="p">,</span> <span class="n">s_n_output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span> <span class="o">=</span> <span class="n">SppLayer</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span> <span class="o">=</span> <span class="n">s_hindcast_length</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.SPP_LSTM_Model_2.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x_lst</span><span class="p">)</span></code>


<a href="#torchhydro.models.spplstm.SPP_LSTM_Model_2.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">x_lst</span><span class="p">):</span>
    <span class="c1"># c and s must be None, g might be None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># g might be None. either c or s must be None, but not both</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># c is not None</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># s is not None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">p</span>
    <span class="c1"># g might be None. Both s and c are not None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">x_lst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p_c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>
        <span class="n">p_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>
        <span class="n">p_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_p</span><span class="p">(</span><span class="n">p_c</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaky_relu_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spp_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid_s</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">p_c</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="p">:,</span> <span class="p">:]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.spplstm.SppLayer" class="doc doc-heading">
        <code>
SppLayer            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.spplstm.SppLayer" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SppLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_pool_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        out_pool_size: a int vector of expected output size of max pooling layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SppLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_pool_size</span> <span class="o">=</span> <span class="n">out_pool_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">)):</span>
            <span class="n">pool_i</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool_i</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_conv</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        previous_conv</span>
<span class="sd">            a tensor vector of previous convolution layer</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            a tensor vector with shape [1 x n] is the concentration of multi-level pooling</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">num_sample</span> <span class="o">=</span> <span class="n">previous_conv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">channel_size</span> <span class="o">=</span> <span class="n">previous_conv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out_pool_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_pool_size</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">)):</span>
            <span class="n">maxpool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">maxpool</span><span class="p">(</span><span class="n">previous_conv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">num_sample</span><span class="p">,</span> <span class="n">channel_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">spp</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">num_sample</span><span class="p">,</span> <span class="n">channel_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spp</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.SppLayer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_pool_size</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#torchhydro.models.spplstm.SppLayer.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>out_pool_size: a int vector of expected output size of max pooling layer</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_pool_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    out_pool_size: a int vector of expected output size of max pooling layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">SppLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_pool_size</span> <span class="o">=</span> <span class="n">out_pool_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">)):</span>
        <span class="n">pool_i</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool_i</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.SppLayer.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_conv</span><span class="p">)</span></code>


<a href="#torchhydro.models.spplstm.SppLayer.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h6 id="torchhydro.models.spplstm.SppLayer.forward--parameters">Parameters<a class="headerlink" href="#torchhydro.models.spplstm.SppLayer.forward--parameters" title="Permanent link">&para;</a></h6>
<p>previous_conv
    a tensor vector of previous convolution layer</p>
<h6 id="torchhydro.models.spplstm.SppLayer.forward--returns">Returns<a class="headerlink" href="#torchhydro.models.spplstm.SppLayer.forward--returns" title="Permanent link">&para;</a></h6>
<p>torch.Tensor
    a tensor vector with shape [1 x n] is the concentration of multi-level pooling</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_conv</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    previous_conv</span>
<span class="sd">        a tensor vector of previous convolution layer</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        a tensor vector with shape [1 x n] is the concentration of multi-level pooling</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_sample</span> <span class="o">=</span> <span class="n">previous_conv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">channel_size</span> <span class="o">=</span> <span class="n">previous_conv</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out_pool_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_pool_size</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_pool_size</span><span class="p">)):</span>
        <span class="n">maxpool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">maxpool</span><span class="p">(</span><span class="n">previous_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">num_sample</span><span class="p">,</span> <span class="n">channel_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">spp</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">num_sample</span><span class="p">,</span> <span class="n">channel_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spp</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="torchhydro.models.spplstm.TimeDistributed" class="doc doc-heading">
        <code>
TimeDistributed            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#torchhydro.models.spplstm.TimeDistributed" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TimeDistributed</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h4 id="torchhydro.models.spplstm.TimeDistributed.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


<a href="#torchhydro.models.spplstm.TimeDistributed.forward" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Define the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>torchhydro/models/spplstm.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2025-11-08
  </span>

    
    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "search.highlight"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>